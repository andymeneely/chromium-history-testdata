{"description":"Add vector_math::FMUL.  Replace audio_util::AdjustVolume.\n\nRemoves the integer based volume adjustment code from the\nmelting pot that is audio_util in favor of an\nAudioBus::AdjustVolume() method which works on float.\n\nThe driver behind the method is a new vector_math::FMUL\nmethod which is SSE optimized.  Benchmarks put it in line\nwith the vector_math::FMAC() method.\n\nBenchmarking 200000 iterations:\nFMUL_C took 1962.52ms.\nFMUL_SSE (unaligned size) took 493.03ms; which is 3.98x faster than FMUL_C.\nFMUL_SSE (aligned size) took 491.79ms; which is 3.99x faster than FMUL_C and 1.00x faster than FMUL_SSE (unaligned size).\n\nBUG=120319, 171540, 226447\nTEST=new media_unittests.\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=192905","cc":["chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"reviewers":["crogers@google.com","henrika@chromium.org"],"messages":[{"sender":"dalecurtis@chromium.org","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"","disapproval":false,"date":"2013-04-05 18:20:19.107970","approval":false},{"sender":"crogers@google.com","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"lgtm - Dale, thanks so much for doing this!\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/audio/audio_util.h\nFile media/audio/audio_util.h (right):\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/audio/audio_util.h#newcode10\nmedia/audio/audio_util.h:10: #include \"build/build_config.h\"\njust curious why these new header files?\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/base/audio_bus.cc\nFile media/base/audio_bus.cc (right):\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/base/audio_bus.cc#newcode312\nmedia/base/audio_bus.cc:312: if (volume > 0 && volume < 1) {\nI would suggest generalizing it by calling is Scale() and removing the < 1 restriction (you can still optimize for the==1 case.  It's valid to want to scale >1 and even <0 (for phase inversion).\n\nI know right now we're using it in  a specific use case for <audio> (and similar) where volume must be 0<=volume<=1 but the general case is also useful.\n\nPerhaps we can keep the AdjustVolume() method with these limits and implement it in terms of another AudioBus method called Scale() which does not have these limits - WDYT?\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/base/audio_bus.h\nFile media/base/audio_bus.h (right):\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/base/audio_bus.h#newcode95\nmedia/base/audio_bus.h:95: // Scale internal channel values by 0 <= |volume| <= 1.  If an invalid value\nplease see comment in .cc about supporting other ranges","disapproval":false,"date":"2013-04-05 21:31:35.190980","approval":true},{"sender":"crogers@google.com","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"Oh, one last thing, can you also please add this in for the AUHAL back-end too?","disapproval":false,"date":"2013-04-05 21:33:01.868410","approval":false},{"sender":"dalecurtis@chromium.org","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"https://codereview.chromium.org/13726011/diff/6001/media/audio/audio_util.h\nFile media/audio/audio_util.h (right):\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/audio/audio_util.h#newcode10\nmedia/audio/audio_util.h:10: #include \"build/build_config.h\"\nOn 2013/04/05 21:31:35, Chris Rogers wrote:\n> just curious why these new header files?\n\nThe defined(OS_WIN) should have build_config.h available. time.h was a mistake.\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/base/audio_bus.cc\nFile media/base/audio_bus.cc (right):\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/base/audio_bus.cc#newcode312\nmedia/base/audio_bus.cc:312: if (volume > 0 && volume < 1) {\nOn 2013/04/05 21:31:35, Chris Rogers wrote:\n> I would suggest generalizing it by calling is Scale() and removing the < 1\n> restriction (you can still optimize for the==1 case.  It's valid to want to\n> scale >1 and even <0 (for phase inversion).\n> \n> I know right now we're using it in  a specific use case for <audio> (and\n> similar) where volume must be 0<=volume<=1 but the general case is also useful.\n> \n> Perhaps we can keep the AdjustVolume() method with these limits and implement it\n> in terms of another AudioBus method called Scale() which does not have these\n> limits - WDYT?\n> \n\nLets see if we can get away with just the Scale() method for now.  AudioRendererHost::OnSetVolume doesn't except volume ranges outside of [0, 1], so we should be fine.\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/base/audio_bus.h\nFile media/base/audio_bus.h (right):\n\nhttps://codereview.chromium.org/13726011/diff/6001/media/base/audio_bus.h#newcode95\nmedia/base/audio_bus.h:95: // Scale internal channel values by 0 <= |volume| <= 1.  If an invalid value\nOn 2013/04/05 21:31:35, Chris Rogers wrote:\n> please see comment in .cc about supporting other ranges\n\nDone.","disapproval":false,"date":"2013-04-05 23:52:30.143850","approval":false},{"sender":"henrika@chromium.org","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"Great work Dale; highly appreciated!\n\nLGTM w/ nits.\n\nDon't know the SSE parts well enough to provide valid comments. Same with your gyp, gypi changes.","disapproval":false,"date":"2013-04-08 18:41:00.382190","approval":true},{"sender":"henrika@chromium.org","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"https://codereview.chromium.org/13726011/diff/12001/media/base/audio_bus.cc\nFile media/base/audio_bus.cc (right):\n\nhttps://codereview.chromium.org/13726011/diff/12001/media/base/audio_bus.cc#newcode312\nmedia/base/audio_bus.cc:312: if (volume > 0 && volume < 1) {\nAdd special case for volume = 1.o where we do nothing.\n\nhttps://codereview.chromium.org/13726011/diff/12001/media/base/vector_math.h\nFile media/base/vector_math.h (right):\n\nhttps://codereview.chromium.org/13726011/diff/12001/media/base/vector_math.h#newcode21\nmedia/base/vector_math.h:21: // |dest| must be aligned by kRequiredAlignment.\nWhat happens if they are not properly aligned?","disapproval":false,"date":"2013-04-08 18:41:09.077400","approval":false},{"sender":"dalecurtis@chromium.org","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"https://codereview.chromium.org/13726011/diff/12001/media/base/audio_bus.cc\nFile media/base/audio_bus.cc (right):\n\nhttps://codereview.chromium.org/13726011/diff/12001/media/base/audio_bus.cc#newcode312\nmedia/base/audio_bus.cc:312: if (volume > 0 && volume < 1) {\nOn 2013/04/08 18:41:09, henrika wrote:\n> Add special case for volume = 1.o where we do nothing.\n\nWhoops, done!\n\nhttps://codereview.chromium.org/13726011/diff/12001/media/base/vector_math.h\nFile media/base/vector_math.h (right):\n\nhttps://codereview.chromium.org/13726011/diff/12001/media/base/vector_math.h#newcode21\nmedia/base/vector_math.h:21: // |dest| must be aligned by kRequiredAlignment.\nOn 2013/04/08 18:41:09, henrika wrote:\n> What happens if they are not properly aligned?\n\nWhen using mm_load instead of mm_loadu (unaligned) an unaligned load will generate a fault. AudioBus takes care of ensuring our allocations are aligned correctly.","disapproval":false,"date":"2013-04-08 19:11:40.285300","approval":false},{"sender":"commit-bot@chromium.org","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/dalecurtis@chromium.org/13726011/17002","disapproval":false,"date":"2013-04-08 19:11:52.828190","approval":false},{"sender":"commit-bot@chromium.org","recipients":["dalecurtis@chromium.org","crogers@google.com","henrika@chromium.org","chromium-reviews@chromium.org","feature-media-reviews@chromium.org","sail+watch@chromium.org"],"text":"Change committed as 192905","disapproval":false,"date":"2013-04-08 21:30:38.163910","approval":false}],"owner_email":"dalecurtis@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"DaleCurtis","subject":"Add vector_math::FMUL.  Replace audio_util::AdjustVolume.","created":"2013-04-05 17:21:25.982820","patchsets":[6001,12001,17002],"modified":"2013-04-08 21:30:38.234520","closed":true,"commit":false,"issue":13726011}