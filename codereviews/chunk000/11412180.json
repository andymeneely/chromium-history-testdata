{"description":"Recreate InstantLoader when its underlying RenderView dies.\n\nCurrently the new loader created is not updated with the previous status and\nthe omnibox input stays the same as before the crash. If the user changes the\nomnibox input in any way, instant will showup as expected.\n\nBUG=159327\n\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=171723","cc":["chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"reviewers":["samarth@chromium.org","sky@chromium.org"],"messages":[{"sender":"shishir@chromium.org","recipients":["shishir@chromium.org","sreeram@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"Hey Sreeram,\n\nBasic CL that recreates the InstantLoader on a crash. Currently it does not retain state on recreation of loader, (thats in progress). Will drop by to discuss what we want to do in such scenarios.\n\nPTAL.\n\nThanks.","disapproval":false,"date":"2012-11-27 00:42:24.462490","approval":false},{"sender":"shishir@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"PTAL.","disapproval":false,"date":"2012-12-06 20:25:14.651770","approval":false},{"sender":"sky@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"https://codereview.chromium.org/11412180/diff/6001/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11412180/diff/6001/chrome/browser/instant/instant_controller.cc#newcode770\nchrome/browser/instant/instant_controller.cc:770: DLOG(ERROR)<< \"InstantClientRenderViewGone\";\nDo we really need a DLOG(ERROR) here?\n\nhttps://codereview.chromium.org/11412180/diff/6001/chrome/browser/instant/instant_controller.cc#newcode771\nchrome/browser/instant/instant_controller.cc:771: ++blacklisted_urls_[loader_->instant_url()];\nIf you're going to do this, which seems fine, update the comments around blacklisted_urls_ and kMaxInstantSupportFailures.\n\nhttps://codereview.chromium.org/11412180/diff/6001/chrome/browser/instant/instant_controller.cc#newcode774\nchrome/browser/instant/instant_controller.cc:774: MessageLoop::current()->DeleteSoon(FROM_HERE, loader_.release());\nAdd a comment as to why this needs to be delayed.","disapproval":false,"date":"2012-12-06 21:00:29.925660","approval":false},{"sender":"shishir@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"PTAL.\n\nhttps://codereview.chromium.org/11412180/diff/6001/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11412180/diff/6001/chrome/browser/instant/instant_controller.cc#newcode770\nchrome/browser/instant/instant_controller.cc:770: DLOG(ERROR)<< \"InstantClientRenderViewGone\";\nOn 2012/12/06 21:00:30, sky wrote:\n> Do we really need a DLOG(ERROR) here?\n\nRemoved.\n\nhttps://codereview.chromium.org/11412180/diff/6001/chrome/browser/instant/instant_controller.cc#newcode771\nchrome/browser/instant/instant_controller.cc:771: ++blacklisted_urls_[loader_->instant_url()];\nOn 2012/12/06 21:00:30, sky wrote:\n> If you're going to do this, which seems fine, update the comments around\n> blacklisted_urls_ and kMaxInstantSupportFailures.\n\nDone.\n\nhttps://codereview.chromium.org/11412180/diff/6001/chrome/browser/instant/instant_controller.cc#newcode774\nchrome/browser/instant/instant_controller.cc:774: MessageLoop::current()->DeleteSoon(FROM_HERE, loader_.release());\nOn 2012/12/06 21:00:30, sky wrote:\n> Add a comment as to why this needs to be delayed.\n\nDone.","disapproval":false,"date":"2012-12-06 21:08:58.094190","approval":false},{"sender":"samarth@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"Some questions and nits below but looks OK otherwise.\n\nSo, if the crash happens while you're interacting with the omnibox, I assume you can still continue typing and hit enter to navigate / search? What happens if we finish resetting the loader while the user is still typing?\n\nThanks,\nSamarth\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_client.h#newcode62\nchrome/browser/instant/instant_client.h:62: virtual void InstantClientRenderViewGone() = 0;\nI would just call this RenderViewGone. We don't prefix any of other methods in the delegate with InstantClient.\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.cc#newcode887\nchrome/browser/instant/instant_controller.cc:887: if (GetPreviewContents()) {\nWill GetPreviewContents will return non-NULL value here? We want to make sure we reset model_ when the loader crashes.\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.cc#newcode892\nchrome/browser/instant/instant_controller.cc:892: loader_->Update(string16(), 0, 0, true);\nIn general, does it matter if we continue trying to send IPCs to the non-existent render view? We have InstantLoader keep track of when the crash happened and drop any IPC requests after that point.\n\nI doubt it matters but wanted to check.\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.h\nFile chrome/browser/instant/instant_controller.h (right):\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.h#newcode146\nchrome/browser/instant/instant_controller.h:146: void InstantClientRenderViewGone();\nLet's call this something that makes it clear that it's the loader that crashed, like InstantLoaderRenderViewGone (or InstantLoaderCrashed if there other paths that may want to trigger this).","disapproval":false,"date":"2012-12-06 21:39:07.638750","approval":false},{"sender":"shishir@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"> So, if the crash happens while you're interacting with the omnibox, I assume you\n> can still continue typing and hit enter to navigate / search? What happens if we\n> finish resetting the loader while the user is still typing?\n\nIf the crash happens when you are interacting with the omnibox and say the preview is showing. If the renderview crashes, the preview will disappear but the state of the omnibox text will remain the same. If you now interact with the omnibox by typing a character the results will show up as expected (might be a bit delayed as the instant page may not be ready). If you just press enter you will commit whats in the omnibox.\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_client.h#newcode62\nchrome/browser/instant/instant_client.h:62: virtual void InstantClientRenderViewGone() = 0;\nOn 2012/12/06 21:39:07, samarth wrote:\n> I would just call this RenderViewGone. We don't prefix any of other methods in\n> the delegate with InstantClient.\n\nDone.\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.cc#newcode887\nchrome/browser/instant/instant_controller.cc:887: if (GetPreviewContents()) {\nOn 2012/12/06 21:39:07, samarth wrote:\n> Will GetPreviewContents will return non-NULL value here? We want to make sure we\n> reset model_ when the loader crashes.\n\nIts the WebContents that calls this method (RenderViewGone) on the obeservers, so it has to be alive at this point.\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.cc#newcode892\nchrome/browser/instant/instant_controller.cc:892: loader_->Update(string16(), 0, 0, true);\nOn 2012/12/06 21:39:07, samarth wrote:\n> In general, does it matter if we continue trying to send IPCs to the\n> non-existent render view? We have InstantLoader keep track of when the crash\n> happened and drop any IPC requests after that point.\n> \n> I doubt it matters but wanted to check.\n\nI dont think it matters much since this should be a rare occurrence. I am in favor of keeping the logic simple and not adding more state.\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.h\nFile chrome/browser/instant/instant_controller.h (right):\n\nhttps://codereview.chromium.org/11412180/diff/9002/chrome/browser/instant/instant_controller.h#newcode146\nchrome/browser/instant/instant_controller.h:146: void InstantClientRenderViewGone();\nOn 2012/12/06 21:39:07, samarth wrote:\n> Let's call this something that makes it clear that it's the loader that crashed,\n> like InstantLoaderRenderViewGone (or InstantLoaderCrashed if there other paths\n> that may want to trigger this).\n\nDone.","disapproval":false,"date":"2012-12-06 21:56:07.069680","approval":false},{"sender":"sky@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"Can you add a test case that crashes the renderer while interacting with the omnibox?","disapproval":false,"date":"2012-12-06 22:38:51.951970","approval":false},{"sender":"shishir@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"On 2012/12/06 22:38:51, sky wrote:\n> Can you add a test case that crashes the renderer while interacting with the\n> omnibox?\n\nAdded test case.","disapproval":false,"date":"2012-12-07 00:40:31.584750","approval":false},{"sender":"sky@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"LGTM","disapproval":false,"date":"2012-12-07 01:02:31.585160","approval":true},{"sender":"commit-bot@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/shishir@chromium.org/11412180/7011","disapproval":false,"date":"2012-12-07 01:08:22.589640","approval":false},{"sender":"commit-bot@chromium.org","recipients":["shishir@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","dcblack@chromium.org","jered@chromium.org"],"text":"Change committed as 171723","disapproval":false,"date":"2012-12-07 08:19:22.370840","approval":false}],"owner_email":"shishir@chromium.org","private":false,"base_url":"http://git.chromium.org/chromium/src.git@master","owner":"Shishir","subject":"Recreate InstantLoader when its underlying RenderView dies.","created":"2012-11-27 00:36:15.607270","patchsets":[1,3001,6001,9002,7002,7011],"modified":"2012-12-07 08:19:22.582080","closed":true,"commit":false,"issue":11412180}