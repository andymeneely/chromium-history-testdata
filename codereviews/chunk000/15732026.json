{"description":"Shift schema check earlier in ThumbnailDatabase::Init().\n\nIf the schema is incorrect, then UpgradeToVersion6() will fail with\nSQLITE_ERROR, and the database will never get cleaned up.\n\nBUG=240396\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=204641","cc":["chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"reviewers":["pkotwicz@chromium.org","jar@chromium.org","sky@chromium.org"],"messages":[{"sender":"shess@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"jar: For boolean->enum conversion.  History isn't in the new histograms.xml file, so that'll have to be a cleanup pass or something.\n\npkotwicz: Per the bug, I have seen a case failing the v6 upgrade because of the missing column.  I'm actually not at all sure what it even means that the existing test placement was catching failures.  I tested these cases by manually tweaking a database and seeing if things got razed.","disapproval":false,"date":"2013-06-04 23:22:23.319400","approval":false},{"sender":"pkotwicz@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"LGTM.\nshess@, thanks a lot for looking into this. This bug really confuses me","disapproval":false,"date":"2013-06-05 14:34:37.706320","approval":true},{"sender":"pkotwicz@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"You want to start at 2 instead?\nIn the old histograms.xml file, Hit = 1\n\nhttps://codereview.chromium.org/15732026/diff/1/chrome/browser/history/thumbnail_database.cc\nFile chrome/browser/history/thumbnail_database.cc (right):\n\nhttps://codereview.chromium.org/15732026/diff/1/chrome/browser/history/thumbnail_database.cc#newcode98\nchrome/browser/history/thumbnail_database.cc:98: // NOTE(shess): Intentionally skip bucket 0 to account for\nYou want to start at 2 instead?\nHit = 1","disapproval":false,"date":"2013-06-05 14:35:21.088840","approval":false},{"sender":"shess@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"https://codereview.chromium.org/15732026/diff/1/chrome/browser/history/thumbnail_database.cc\nFile chrome/browser/history/thumbnail_database.cc (right):\n\nhttps://codereview.chromium.org/15732026/diff/1/chrome/browser/history/thumbnail_database.cc#newcode98\nchrome/browser/history/thumbnail_database.cc:98: // NOTE(shess): Intentionally skip bucket 0 to account for\nOn 2013/06/05 14:35:21, pkotwicz wrote:\n> You want to start at 2 instead?\n> Hit = 1\n\nI'm discussing it with jar@.  He suggested maybe a new histogram entirely.  The way it's coded now, the previous \"hit\" should map to bucket 1, so it should stitch right together as if it was always this way and I've just added some new ones.","disapproval":false,"date":"2013-06-05 14:42:49.724440","approval":false},{"sender":"shess@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"On 2013/06/05 14:34:37, pkotwicz wrote:\n> LGTM.\n> shess@, thanks a lot for looking into this. This bug really confuses me\n\nThe fact that your original check was firing indicates that somehow there exist version-6 databases with that incorrect schema.  Likewise, the schema I'm seeing for a failed version-6 migration indicates that it got to version 5 with an incorrect schema.  Long Long Ago, there was a meta_table.cc bug which didn't correctly initialize atomically, so what could happen is that a later version would initialize the table but then bounce on the initial schema creation and end up in a state where the schema did not match the version.  But AFAICT, this code has always been in an overall transaction.\n\nThe only thing I have left is that the meta-table root page is distinct from the database root page (where the schema is actually stored).  That just seems really unreasonable, though, version migrations don't happen very often, so there shouldn't be all that many chances for those to get out of sync.  I have been considering encoding the version number in a view, something like:\n\nsqlite> CREATE VIEW IF NOT EXISTS meta_version AS SELECT 5;\nsqlite> SELECT * from meta_version;\n5\n\nThis would usually put the version information in the same page as the schema information.\n\nTrying to reason about this has again made me annoyed with schema-handling code which is written to share things and rearrange things and stuff.  It makes it almost impossible to easily reason about the version history.  This is the one case where saying \"just use revision control\" fails, because you have to simultaneously think about a database created by an old version, migrated by a newer version, and breaking a current version - the results of the old code are still live.  I'm thinking of trying to make a new requirement, that all schema code exists until specifically obsoleted.  So you always start at the same point and migrate forward, so that the code all continues to exist.\n\nOK, I'm really ranting.  Sorry, insomnia last night and I'm really grumpy.\n\n-scott","disapproval":false,"date":"2013-06-05 17:08:30.375250","approval":false},{"sender":"shess@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"WRT the histograms, the existing code logs a boolean histogram when a particular code path is executed, and has for quite awhile.  My change adds two new similar codepaths and keeps the original codepath.  The histogram conversion bins the original codepath into the same bin, and adds two new bins for the two new codepaths.  It leaves bin 0 unused just because bin 0 was previously unused (it never logged \"false\").\n\nDoes that make sense?  It's not so much that I don't want to spin up a new histogram, rather I just wanted to augment an existing histogram.\n\nIf having an intentionally-unused bin is questionable, I could just put one of the new enums in there.","disapproval":false,"date":"2013-06-05 17:12:41.364150","approval":false},{"sender":"jar@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"based on off-line discussion with shess... I'm convinced the histogram changes are safe (stitch together new and old data)... so histogram code LGTM","disapproval":false,"date":"2013-06-05 18:20:39.238810","approval":true},{"sender":"shess@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"And then sky for OWNERS.\n\nThanks.","disapproval":false,"date":"2013-06-05 19:11:11.710750","approval":false},{"sender":"sky@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"LGTM","disapproval":false,"date":"2013-06-06 15:46:38.986470","approval":true},{"sender":"commit-bot@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/shess@chromium.org/15732026/1","disapproval":false,"date":"2013-06-06 16:56:15.261280","approval":false},{"sender":"commit-bot@chromium.org","recipients":["shess@chromium.org","pkotwicz@chromium.org","jar@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","browser-components-watch@chromium.org"],"text":"Change committed as 204641","disapproval":false,"date":"2013-06-06 23:03:05.110610","approval":false}],"owner_email":"shess@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"shess","subject":"Shift schema check earlier in ThumbnailDatabase::Init().","created":"2013-06-04 23:15:15.352000","patchsets":[1],"modified":"2013-06-06 23:03:05.693770","closed":true,"commit":false,"issue":15732026}