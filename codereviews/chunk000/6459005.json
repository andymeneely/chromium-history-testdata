{"description":"Cancel prerender when we discover a download starting from a page we are prerendering.\n\nBUG=71214\nTEST=Search for carbon poker download and wait. The first result, which has a <link rel=\"prefetch\"> will not cause a prerender as the download that the next page starts will cancel it.\n\n\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=75168","cc":["chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"reviewers":["cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com"],"messages":[{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"","disapproval":false,"date":"2011-02-08 23:58:41.374084","approval":false},{"sender":"cbentzel@chromium.org","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"Randy - the download is triggered via an iframe with a src set to a non-html\nlink. Do you expect this to bring up the download shelf?\n\nI'll take a look at the code a bit later.\n\nOn Tue, Feb 8, 2011 at 6:58 PM, <dominich@chromium.org> wrote:\n\n> Reviewers: cbentzel, rdsmith,\n>\n> Description:\n> Cancel prerender when we discover a download starting from a page we are\n> prerendering.\n>\n> Contributed by: dominich@chromium.org\n>\n> BUG=71214\n> TEST=Search for carbon poker download and wait. The first result, which has\n> a\n> <link rel=\"prefetch\"> will not cause a prerender as the download that the\n> next\n> page starts will cancel it.\n>\n>\n>\n> Please review this at http://codereview.chromium.org/6459005/\n>\n> SVN Base: svn://svn.chromium.org/chrome/trunk/src/\n>\n> Affected files:\n>  M     chrome/browser/prerender/prerender_browsertest.cc\n>  M     chrome/browser/prerender/prerender_contents.h\n>  M     chrome/browser/prerender/prerender_contents.cc\n>  M     chrome/browser/renderer_host/download_throttling_resource_handler.h\n>  M     chrome/browser/renderer_host/download_throttling_resource_handler.cc\n>  M     chrome/common/notification_type.h\n>  A     chrome/test/data/prerender/prerender_download.html\n>\n>\n> Index: chrome/browser/prerender/prerender_browsertest.cc\n> ===================================================================\n> --- chrome/browser/prerender/prerender_browsertest.cc   (revision 74194)\n> +++ chrome/browser/prerender/prerender_browsertest.cc   (working copy)\n> @@ -242,3 +242,10 @@\n>                    PrerenderContents::FINAL_STATUS_USED, 2);\n>   NavigateToDestURL();\n>  }\n> +\n> +// Prerenders a page that contains an automatic download. This should not\n> +// prerender successfully\n> +IN_PROC_BROWSER_TEST_F(PrerenderBrowserTest, PrerenderDownload) {\n> +  PrerenderTestURL(\"prerender_download.html\",\n> +                   PrerenderContents::FINAL_STATUS_DOWNLOAD, 1);\n> +}\n> Index: chrome/browser/prerender/prerender_contents.cc\n> ===================================================================\n> --- chrome/browser/prerender/prerender_contents.cc      (revision 74194)\n> +++ chrome/browser/prerender/prerender_contents.cc      (working copy)\n> @@ -11,6 +11,7 @@\n>  #include \"chrome/browser/prerender/prerender_manager.h\"\n>  #include \"chrome/browser/profiles/profile.h\"\n>  #include \"chrome/browser/renderer_host/render_view_host.h\"\n> +#include \"chrome/browser/renderer_host/resource_request_details.h\"\n>  #include \"chrome/browser/renderer_host/site_instance.h\"\n>  #include \"chrome/browser/renderer_preferences_util.h\"\n>  #include \"chrome/browser/ui/login/login_prompt.h\"\n> @@ -82,6 +83,10 @@\n>   registrar_.Add(this, NotificationType::AUTH_CANCELLED,\n>                  NotificationService::AllSources());\n>\n> +  // Register all responses to see if we should cancel.\n> +  registrar_.Add(this, NotificationType::DOWNLOAD_STARTED,\n> +                 NotificationService::AllSources());\n> +\n>   DCHECK(load_start_time_.is_null());\n>   load_start_time_ = base::TimeTicks::Now();\n>\n> @@ -206,6 +211,18 @@\n>       break;\n>     }\n>\n> +    case NotificationType::DOWNLOAD_STARTED: {\n> +      // If the download is started from a RenderViewHost that we are\n> +      // delegating, kill the prerender. This will also stop the download\n> and\n> +      // navigating to the page will restart it as expected.\n> +      RenderViewHostDelegate* rvhd =\n> +          Source<RenderViewHostDelegate>(source).ptr();\n> +      if (rvhd == this) {\n> +        Destroy(FINAL_STATUS_DOWNLOAD);\n> +      }\n> +      break;\n> +    }\n> +\n>     default:\n>       NOTREACHED() << \"Unexpected notification sent.\";\n>       break;\n> Index: chrome/browser/prerender/prerender_contents.h\n> ===================================================================\n> --- chrome/browser/prerender/prerender_contents.h       (revision 74194)\n> +++ chrome/browser/prerender/prerender_contents.h       (working copy)\n> @@ -50,6 +50,7 @@\n>     FINAL_STATUS_APP_TERMINATING,\n>     FINAL_STATUS_JAVASCRIPT_ALERT,\n>     FINAL_STATUS_AUTH_NEEDED,\n> +    FINAL_STATUS_DOWNLOAD,\n>     FINAL_STATUS_MAX,\n>   };\n>\n> Index: chrome/browser/renderer_host/download_throttling_resource_handler.cc\n> ===================================================================\n> --- chrome/browser/renderer_host/download_throttling_resource_handler.cc\n>      (revision 74194)\n> +++ chrome/browser/renderer_host/download_throttling_resource_handler.cc\n>      (working copy)\n> @@ -5,8 +5,14 @@\n>  #include\n> \"chrome/browser/renderer_host/download_throttling_resource_handler.h\"\n>\n>  #include \"base/logging.h\"\n> +#include \"chrome/browser/cert_store.h\"\n>  #include \"chrome/browser/renderer_host/download_resource_handler.h\"\n> +#include \"chrome/browser/renderer_host/render_view_host.h\"\n> +#include \"chrome/browser/renderer_host/render_view_host_delegate.h\"\n>  #include \"chrome/browser/renderer_host/resource_dispatcher_host.h\"\n> +#include\n> \"chrome/browser/renderer_host/resource_dispatcher_host_request_info.h\"\n> +#include \"chrome/browser/renderer_host/resource_request_details.h\"\n> +#include \"chrome/common/notification_service.h\"\n>  #include \"chrome/common/resource_response.h\"\n>  #include \"net/base/io_buffer.h\"\n>  #include \"net/base/mime_sniffer.h\"\n> @@ -36,6 +42,34 @@\n>  DownloadThrottlingResourceHandler::~DownloadThrottlingResourceHandler() {\n>  }\n>\n> +ResourceRequestDetails*\n> +  DownloadThrottlingResourceHandler::GetResourceRequestDetails() {\n> +  int certID = 0;\n> +  if (request_->ssl_info().cert) {\n> +    ResourceDispatcherHostRequestInfo* info =\n> +        ResourceDispatcherHost::InfoForRequest(request_);\n> +\n> +    certID =\n> CertStore::GetInstance()->StoreCert(request_->ssl_info().cert,\n> +                                                 info->child_id());\n> +  }\n> +\n> +  return new ResourceRequestDetails(request_, certID);\n> +}\n> +\n> +template<NotificationType::Type T>\n> +void DownloadThrottlingResourceHandler::NotifyOnUI(\n> +    int process_id, int view_id,\n> +    ResourceRequestDetails* details) {\n> +  RenderViewHost* rvh = RenderViewHost::FromID(process_id, view_id);\n> +  if (rvh) {\n> +    RenderViewHostDelegate* rvhd = rvh->delegate();\n> +    NotificationService::current()->Notify(T,\n> +        Source<RenderViewHostDelegate>(rvhd),\n> +        Details<ResourceRequestDetails>(details));\n> +  }\n> +  delete details;\n> +}\n> +\n>  bool DownloadThrottlingResourceHandler::OnUploadProgress(int request_id,\n>                                                          uint64 position,\n>                                                          uint64 size) {\n> @@ -60,6 +94,14 @@\n>  bool DownloadThrottlingResourceHandler::OnResponseStarted(\n>     int request_id,\n>     ResourceResponse* response) {\n> +  BrowserThread::PostTask(\n> +      BrowserThread::UI, FROM_HERE,\n> +      NewRunnableFunction(\n> +        &DownloadThrottlingResourceHandler::NotifyOnUI\n> +          <NotificationType::DOWNLOAD_STARTED>,\n> +          render_process_host_id_, render_view_id_,\n> +          GetResourceRequestDetails()));\n> +\n>   if (download_handler_.get())\n>     return download_handler_->OnResponseStarted(request_id, response);\n>   response_ = response;\n> @@ -141,6 +183,14 @@\n>  }\n>\n>  void DownloadThrottlingResourceHandler::CancelDownload() {\n> +  BrowserThread::PostTask(\n> +      BrowserThread::UI, FROM_HERE,\n> +      NewRunnableFunction(\n> +          &DownloadThrottlingResourceHandler::NotifyOnUI\n> +            <NotificationType::DOWNLOAD_CANCELLED>,\n> +          render_process_host_id_, render_view_id_,\n> +          GetResourceRequestDetails()));\n> +\n>   host_->CancelRequest(render_process_host_id_, request_id_, false);\n>  }\n>\n> Index: chrome/browser/renderer_host/download_throttling_resource_handler.h\n> ===================================================================\n> --- chrome/browser/renderer_host/download_throttling_resource_handler.h\n> (revision 74194)\n> +++ chrome/browser/renderer_host/download_throttling_resource_handler.h\n> (working copy)\n> @@ -10,10 +10,12 @@\n>\n>  #include \"chrome/browser/download/download_request_limiter.h\"\n>  #include \"chrome/browser/renderer_host/resource_handler.h\"\n> +#include \"chrome/common/notification_type.h\"\n>  #include \"googleurl/src/gurl.h\"\n>\n>  class DownloadResourceHandler;\n>  class ResourceDispatcherHost;\n> +class ResourceRequestDetails;\n>\n>  namespace net {\n>  class URLRequest;\n> @@ -65,6 +67,12 @@\n>\n>   void CopyTmpBufferToDownloadHandler();\n>\n> +  ResourceRequestDetails* GetResourceRequestDetails();\n> +\n> +  template<NotificationType::Type T>\n> +  static void NotifyOnUI(int process_id, int view_id,\n> +                         ResourceRequestDetails* details);\n> +\n>   ResourceDispatcherHost* host_;\n>   net::URLRequest* request_;\n>   GURL url_;\n> Index: chrome/common/notification_type.h\n> ===================================================================\n> --- chrome/common/notification_type.h   (revision 74194)\n> +++ chrome/common/notification_type.h   (working copy)\n> @@ -1229,7 +1229,16 @@\n>     // The source is the corresponding RenderViewHost. There are not\n> details.\n>     AUTOFILL_DID_FILL_FORM_DATA,\n>\n> +    // Download Notifications\n> --------------------------------------------------\n>\n> +    // Sent when a download starts. The source is the\n> RenderViewHostDelegate.\n> +    // The details are a ResourceRequestDetails.\n> +    DOWNLOAD_STARTED,\n> +\n> +    // Sent when a download is canceled. The source is the\n> +    // RenderViewHostDelegate. The details are a ResourceRequestDetails.\n> +    DOWNLOAD_CANCELLED,\n> +\n>     // Misc\n> --------------------------------------------------------------------\n>\n>  #if defined(OS_CHROMEOS)\n> Index: chrome/test/data/prerender/prerender_download.html\n> ===================================================================\n> --- chrome/test/data/prerender/prerender_download.html  (revision 0)\n> +++ chrome/test/data/prerender/prerender_download.html  (revision 0)\n> @@ -0,0 +1,7 @@\n> +<html>\n> +  <head><title>Prerender download test</title></head>\n> +  <body>\n> +    <iframe name=\"download\" src=\"../download-test1.lib\" width=\"0\"\n> height=\"0\"\n> +      frameborder=\"0\"></iframe>\n> +  </body>\n> +</html>\n>\n> Property changes on: chrome/test/data/prerender/prerender_download.html\n> ___________________________________________________________________\n> Added: svn:eol-style\n>   + LF\n>\n>\n>\n>\n","disapproval":false,"date":"2011-02-09 10:47:08.075418","approval":false},{"sender":"cbentzel@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"The big question for me is whether this is the earliest possible place to trigger the notification - Randy would be a better judge.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/prerender/prerender_contents.cc#newcode221\nchrome/browser/prerender/prerender_contents.cc:221: Destroy(FINAL_STATUS_DOWNLOAD);\nNit: I'd like an explicit return here, since Destroy is calling delete this.\n\nIt's OK for now, but if any logic went below the switch statement it might be problematic.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode52\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:52: certID = CertStore::GetInstance()->StoreCert(request_->ssl_info().cert,\nI have no idea what's going on here, but it seems like storing SSL certs for a download notification is probably not correct.\n\nAlso, none of the consumers currently use any of the details - just the source. Could you use a generic details?\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode190\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:190: <NotificationType::DOWNLOAD_CANCELLED>,\nThere are no consumers of DOWNLOAD_CANCELLED right now - should you skip adding it in this CL?\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.h\nFile chrome/browser/renderer_host/download_throttling_resource_handler.h (right):\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode72\nchrome/browser/renderer_host/download_throttling_resource_handler.h:72: template<NotificationType::Type T>\nMove this into .cc file and put in anonymous namespace. It's only being used by internal methods.\n\nIt also doesn't look like there are substantial gains templating it on NotificationType::Type - why not pass it in as an argument?","disapproval":false,"date":"2011-02-09 12:11:13.944229","approval":false},{"sender":"cbentzel@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6459005/diff/7/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/prerender/prerender_contents.cc#newcode87\nchrome/browser/prerender/prerender_contents.cc:87: registrar_.Add(this, NotificationType::DOWNLOAD_STARTED,\nInstead of registering with AllSources, you could register with Source<RenderViewHostDelegate>(this). That way the filtering is done in the NotificationService rather than here.","disapproval":false,"date":"2011-02-09 12:19:15.571631","approval":false},{"sender":"cbentzel@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"So, I'm not convinced DownloadThrottlingResourceHandler is the right place to put the notification.\n\nThere's other entry points to the download system. For example, an IPC of ViewHostMsg_DownloadUrl will cause a DownloadResourceHandler to be created, but not a throttling resource handler.\n\nI'm guessing that the Notification should be done in the DownloadManager or some other location than a resource handler.","disapproval":false,"date":"2011-02-09 13:08:50.623888","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"[Not yet my full review, just tossing in a couple of comments.  ]\n\nOn 2011/02/09 13:08:50, cbentzel wrote:\n> So, I'm not convinced DownloadThrottlingResourceHandler is the right place to\n> put the notification.\n> \n> There's other entry points to the download system. For example, an IPC of\n> ViewHostMsg_DownloadUrl will cause a DownloadResourceHandler to be created, but\n> not a throttling resource handler.\n> \n> I'm guessing that the Notification should be done in the DownloadManager or some\n> other location than a resource handler.\n\nI'd suggest DownloadResourceHandler.  I believe that everything that ends up in DownloadManager goes through DownloadResourceHandle, and I've got a background CL that's really going to mess with the areas in which you'd want to put the notification in the DownloadManager.  If you really want to put it in DownloadManager, let me know and I'll give you guidance as to where.\n\nAlso, a question I don't know the answer to: Is there any way for a pre-renderer to invoke a SavePackage operation?  SavePackage is what's used for \"Save Page As ...\"; it's separate from the download code for (bad) historical reasons, and I don't know the code very well.  My guess is that there isn't such a way, but it might be worth scanning.","disapproval":false,"date":"2011-02-09 13:41:30.037419","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"I'm going to wait for my primary review on the resolution to Chris' points (it looks like that may change the download code significantly) but one high-level question: When you kill a pre-render because of downloads, you come back and cancel the download, right?  Where is the code that cancels the download?","disapproval":false,"date":"2011-02-09 13:52:17.139080","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 10:47:08, cbentzel wrote:\n> Randy - the download is triggered via an iframe with a src set to a non-html\n> link. Do you expect this to bring up the download shelf?\n\nI would, but my knowledge of those aspects of the UI is not yet certain, so if you want to be sure you should test it in a non-prerenderer context.","disapproval":false,"date":"2011-02-09 14:01:53.812287","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 12:11:13, cbentzel wrote:\n> The big question for me is whether this is the earliest possible place to\n> trigger the notification - Randy would be a better judge.\n\nFor what it's worth, my answer to that question is \"yes\".  The DownloadThrottlingResourceHandler may cancel the download, so you can't be sure that the download is actually going to happen until just about the point in the code where the notification was put. That doesn't mean it's the best place; for the reasons you called out, there may be downloads that don't go through this section of code.  So I'd be inclined to put it in the DownloadResourceHandler; that doesn't lose you very much time at all.","disapproval":false,"date":"2011-02-09 14:03:37.242798","approval":false},{"sender":"cbentzel@chromium.org","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"On Wed, Feb 9, 2011 at 9:01 AM, <rdsmith@chromium.org> wrote:\n\n> On 2011/02/09 10:47:08, cbentzel wrote:\n>\n>> Randy - the download is triggered via an iframe with a src set to a\n>> non-html\n>> link. Do you expect this to bring up the download shelf?\n>>\n>\n> I would, but my knowledge of those aspects of the UI is not yet certain, so\n> if\n> you want to be sure you should test it in a non-prerenderer context.\n\n\nThis does work in non-prerender context [Dominic pointed to a site which did\nit, and I reproed].\n\nMy question was whether this _should_ work.\n","disapproval":false,"date":"2011-02-09 14:54:39.729914","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 13:08:50, cbentzel wrote:\n> So, I'm not convinced DownloadThrottlingResourceHandler is the right place to\n> put the notification.\n> \n> There's other entry points to the download system. For example, an IPC of\n> ViewHostMsg_DownloadUrl will cause a DownloadResourceHandler to be created, but\n> not a throttling resource handler.\n> \n> I'm guessing that the Notification should be done in the DownloadManager or some\n> other location than a resource handler.\n\nMy experience is that in the prerender case it never gets to the DownloadManager. This is the only place I could find to catch it. I'm more than happy to find somewhere else though.","disapproval":false,"date":"2011-02-09 16:25:57.873351","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 13:52:17, rdsmith wrote:\n> I'm going to wait for my primary review on the resolution to Chris' points (it\n> looks like that may change the download code significantly) but one high-level\n> question: When you kill a pre-render because of downloads, you come back and\n> cancel the download, right?  Where is the code that cancels the download?\n\nI don't explicitly cancel the download but it doesn't show in the history and no files are created. As we destroy the background tab being used for the prerender I expected the download to be cancelled. If this isn't true, I'll work in a cancellation after changing the code as per Chris's comments.","disapproval":false,"date":"2011-02-09 16:27:47.665362","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 14:03:37, rdsmith wrote:\n> On 2011/02/09 12:11:13, cbentzel wrote:\n> > The big question for me is whether this is the earliest possible place to\n> > trigger the notification - Randy would be a better judge.\n> \n> For what it's worth, my answer to that question is \"yes\".  The\n> DownloadThrottlingResourceHandler may cancel the download, so you can't be sure\n> that the download is actually going to happen until just about the point in the\n> code where the notification was put. That doesn't mean it's the best place; for\n> the reasons you called out, there may be downloads that don't go through this\n> section of code.  So I'd be inclined to put it in the DownloadResourceHandler;\n> that doesn't lose you very much time at all.\n\nAs I mentioned above, I didn't find that the download made it to the DownloadResourceHandler in the prerender case. It seems that it is paused and never resumed.\n\nI'll take another look as I may have missed something, but I'm fairly confident this is the right, if not the best, place to put it.","disapproval":false,"date":"2011-02-09 16:29:55.630220","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 14:54:39, cbentzel wrote:\n> On Wed, Feb 9, 2011 at 9:01 AM, <mailto:rdsmith@chromium.org> wrote:\n> \n> > On 2011/02/09 10:47:08, cbentzel wrote:\n> >\n> >> Randy - the download is triggered via an iframe with a src set to a\n> >> non-html\n> >> link. Do you expect this to bring up the download shelf?\n> >>\n> >\n> > I would, but my knowledge of those aspects of the UI is not yet certain, so\n> > if\n> > you want to be sure you should test it in a non-prerenderer context.\n> \n> \n> This does work in non-prerender context [Dominic pointed to a site which did\n> it, and I reproed].\n> \n> My question was whether this _should_ work.\n\nFrom a quick search, it seems this is given as the best technique to start downloads automatically from a page. If there are other ways of building the page to start a download that might go through a different code path, let me know and I'll test them.","disapproval":false,"date":"2011-02-09 16:31:30.733689","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 14:54:39, cbentzel wrote:\n> On Wed, Feb 9, 2011 at 9:01 AM, <mailto:rdsmith@chromium.org> wrote:\n> \n> > On 2011/02/09 10:47:08, cbentzel wrote:\n> >\n> >> Randy - the download is triggered via an iframe with a src set to a\n> >> non-html\n> >> link. Do you expect this to bring up the download shelf?\n> >>\n> >\n> > I would, but my knowledge of those aspects of the UI is not yet certain, so\n> > if\n> > you want to be sure you should test it in a non-prerenderer context.\n> \n> \n> This does work in non-prerender context [Dominic pointed to a site which did\n> it, and I reproed].\n> \n> My question was whether this _should_ work.\n\nAh, sorry.  Yes, it should.","disapproval":false,"date":"2011-02-09 16:34:29.473208","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 16:25:57, dominic wrote:\n> On 2011/02/09 13:08:50, cbentzel wrote:\n> > So, I'm not convinced DownloadThrottlingResourceHandler is the right place to\n> > put the notification.\n> > \n> > There's other entry points to the download system. For example, an IPC of\n> > ViewHostMsg_DownloadUrl will cause a DownloadResourceHandler to be created,\n> but\n> > not a throttling resource handler.\n> > \n> > I'm guessing that the Notification should be done in the DownloadManager or\n> some\n> > other location than a resource handler.\n> \n> My experience is that in the prerender case it never gets to the\n> DownloadManager. This is the only place I could find to catch it. I'm more than\n> happy to find somewhere else though.\n\nThat's ... interesting.  Where does it block; can you tell?  (or if you give me a repro, I can find it).  It *should* get to the download manager ....","disapproval":false,"date":"2011-02-09 16:35:22.737294","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 16:27:47, dominic wrote:\n> On 2011/02/09 13:52:17, rdsmith wrote:\n> > I'm going to wait for my primary review on the resolution to Chris' points (it\n> > looks like that may change the download code significantly) but one high-level\n> > question: When you kill a pre-render because of downloads, you come back and\n> > cancel the download, right?  Where is the code that cancels the download?\n> \n> I don't explicitly cancel the download but it doesn't show in the history and no\n> files are created. As we destroy the background tab being used for the prerender\n> I expected the download to be cancelled. If this isn't true, I'll work in a\n> cancellation after changing the code as per Chris's comments.\n\nI don't believe it's true--certainly I can start a download from a tab and kill the tab without killing the download.  The downloads are separate from tabs (and I think even separate from the browser windows, even though the download shelf is per-browser window).  This may be related to the fact that you didn't see a download get to the DownloadManager; if it doesn't get to the DownloadManager, it ain't showing up in the file system or history.","disapproval":false,"date":"2011-02-09 16:37:08.380564","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"> As I mentioned above, I didn't find that the download made it to the\n> DownloadResourceHandler in the prerender case. It seems that it is paused and\n> never resumed.\n\nIf it never gets to the DownloadResourceHandler, I believe that means that the DownloadRequestLimitter is blocking it.  I'd be interested in whether you get a DownloadThrottlingResourceHandler::CancelDownload() or if you just never get ContinueDownload() called.  But either way, that means that no download will occur.  Which may mean you don't need to notify at all.  Would be nice to know what's going on in the DownloadRequestLimiter in response to this invocation.  (The relevant code chain starts from the DownloadThrottlingResourceHandler constructor; it calls into the DownloadRequestLimiter, and is expecting a callback of some sort; either cancel or continue--see download_request_limiter.cc).\n\n\n> \n> I'll take another look as I may have missed something, but I'm fairly confident\n> this is the right, if not the best, place to put it.","disapproval":false,"date":"2011-02-09 16:53:53.584657","approval":false},{"sender":"dominic@google.com","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"On Wed, Feb 9, 2011 at 8:53 AM, <rdsmith@chromium.org> wrote:\n\n> As I mentioned above, I didn't find that the download made it to the\n>> DownloadResourceHandler in the prerender case. It seems that it is paused\n>> and\n>> never resumed.\n>>\n>\n> If it never gets to the DownloadResourceHandler, I believe that means that\n> the\n> DownloadRequestLimitter is blocking it.  I'd be interested in whether you\n> get a\n> DownloadThrottlingResourceHandler::CancelDownload() or if you just never\n> get\n> ContinueDownload() called.  But either way, that means that no download\n> will\n> occur.  Which may mean you don't need to notify at all.  Would be nice to\n> know\n> what's going on in the DownloadRequestLimiter in response to this\n> invocation.\n> (The relevant code chain starts from the DownloadThrottlingResourceHandler\n> constructor; it calls into the DownloadRequestLimiter, and is expecting a\n> callback of some sort; either cancel or continue--see\n> download_request_limiter.cc).\n>\n>\nFrom memory, it never gets the continue but I need to double check. I still\nneed to notify as I need the prerender to be cancelled. If I don't do this,\nwhile there are no obvious negative effects, on navigation to the page the\nautomatic download doesn't start as it should (as it is paused).\n\n\n>\n>\n>\n>  I'll take another look as I may have missed something, but I'm fairly\n>>\n> confident\n>\n>> this is the right, if not the best, place to put it.\n>>\n>\n>\n>\n> http://codereview.chromium.org/6459005/\n>\n\n\n\n-- \nDominic Hamon\nSoftware Engineer | Google\n","disapproval":false,"date":"2011-02-09 16:56:22.772162","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 16:53:53, rdsmith wrote:\n> > As I mentioned above, I didn't find that the download made it to the\n> > DownloadResourceHandler in the prerender case. It seems that it is paused and\n> > never resumed.\n> \n> If it never gets to the DownloadResourceHandler, I believe that means that the\n> DownloadRequestLimitter is blocking it.  I'd be interested in whether you get a\n> DownloadThrottlingResourceHandler::CancelDownload() or if you just never get\n> ContinueDownload() called.  But either way, that means that no download will\n> occur.  Which may mean you don't need to notify at all.  Would be nice to know\n> what's going on in the DownloadRequestLimiter in response to this invocation. \n> (The relevant code chain starts from the DownloadThrottlingResourceHandler\n> constructor; it calls into the DownloadRequestLimiter, and is expecting a\n> callback of some sort; either cancel or continue--see\n> download_request_limiter.cc).\n\nThe DownloadRequestLimiter is cancelling the download immediately as the prerendered render view has no TabContents.\n\n\n\n> \n> \n> > \n> > I'll take another look as I may have missed something, but I'm fairly\n> confident\n> > this is the right, if not the best, place to put it.","disapproval":false,"date":"2011-02-09 17:58:16.461334","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/02/09 17:58:16, dominic wrote:\n> The DownloadRequestLimiter is cancelling the download immediately as the\n> prerendered render view has no TabContents.\n\nFrom my perspective this is awesome behavior; let's keep it! :-} :-|  Thanks for checking this out.\n\nChris is right, though, in that there are other paths into this code that go straight to the DownloadResourceHandler, and hence trigger the download.  So you'll probably need to instrument multiple paths.  I'm also a bit uncomfortable about doing a general \"DownloadStarted\" notification on a path on which the download actually hasn't been started (from my perspective, if we never get to the DownloadResourceHandler, the download hasn't been started).  Maybe call it \"DOWNLOAD_INITIATED\" with a comment at notification type definition that this doesn't actually mean that the download's going to be started?\n\nA month or two ago I did a reverse call graph of all the paths into DownloadResourceHandler; I'll send that under separate cover (I don't trust the formatting to stand up to cut&paste in a web form).","disapproval":false,"date":"2011-02-09 18:13:30.192600","approval":false},{"sender":"cbentzel@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"I was hoping that there was a single entry point for kicking off a download where the notification would happen, partly to help future-proof this in case there are other triggers for downloads over what currently exists. \n\nI agree that the code Dominic wrote handles the most likely case, however.","disapproval":false,"date":"2011-02-09 21:39:56.470263","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"Added more browser test variations for downloading of files based on existing download browser tests.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/prerender/prerender_contents.cc#newcode87\nchrome/browser/prerender/prerender_contents.cc:87: registrar_.Add(this, NotificationType::DOWNLOAD_STARTED,\nOn 2011/02/09 12:19:15, cbentzel wrote:\n> Instead of registering with AllSources, you could register with\n> Source<RenderViewHostDelegate>(this). That way the filtering is done in the\n> NotificationService rather than here. \n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/prerender/prerender_contents.cc#newcode221\nchrome/browser/prerender/prerender_contents.cc:221: Destroy(FINAL_STATUS_DOWNLOAD);\nOn 2011/02/09 12:11:14, cbentzel wrote:\n> Nit: I'd like an explicit return here, since Destroy is calling delete this.\n> \n> It's OK for now, but if any logic went below the switch statement it might be\n> problematic.\n\nI'll add the same to the AUTH_* cases above.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/prerender/prerender_contents.cc#newcode221\nchrome/browser/prerender/prerender_contents.cc:221: Destroy(FINAL_STATUS_DOWNLOAD);\nOn 2011/02/09 12:11:14, cbentzel wrote:\n> Nit: I'd like an explicit return here, since Destroy is calling delete this.\n> \n> It's OK for now, but if any logic went below the switch statement it might be\n> problematic.\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode52\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:52: certID = CertStore::GetInstance()->StoreCert(request_->ssl_info().cert,\nOn 2011/02/09 12:11:14, cbentzel wrote:\n> I have no idea what's going on here, but it seems like storing SSL certs for a\n> download notification is probably not correct.\n> \n> Also, none of the consumers currently use any of the details - just the source.\n> Could you use a generic details?\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode190\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:190: <NotificationType::DOWNLOAD_CANCELLED>,\nOn 2011/02/09 12:11:14, cbentzel wrote:\n> There are no consumers of DOWNLOAD_CANCELLED right now - should you skip adding\n> it in this CL?\n\nI can. I thought that it would be good to have both in for completeness, but I'll strip this out.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode190\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:190: <NotificationType::DOWNLOAD_CANCELLED>,\nOn 2011/02/09 12:11:14, cbentzel wrote:\n> There are no consumers of DOWNLOAD_CANCELLED right now - should you skip adding\n> it in this CL?\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.h\nFile chrome/browser/renderer_host/download_throttling_resource_handler.h (right):\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode72\nchrome/browser/renderer_host/download_throttling_resource_handler.h:72: template<NotificationType::Type T>\nOn 2011/02/09 12:11:14, cbentzel wrote:\n> Move this into .cc file and put in anonymous namespace. It's only being used by\n> internal methods.\n> \n> It also doesn't look like there are substantial gains templating it on\n> NotificationType::Type - why not pass it in as an argument?\n\nI was following the pattern established in the ResourceDispatcherHost to be consistent, but yes I'd rather this was a parameter too.\n\nhttp://codereview.chromium.org/6459005/diff/7/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode72\nchrome/browser/renderer_host/download_throttling_resource_handler.h:72: template<NotificationType::Type T>\nOn 2011/02/09 12:11:14, cbentzel wrote:\n> Move this into .cc file and put in anonymous namespace. It's only being used by\n> internal methods.\n> \n> It also doesn't look like there are substantial gains templating it on\n> NotificationType::Type - why not pass it in as an argument?\n\nDone.","disapproval":false,"date":"2011-02-09 22:33:30.777467","approval":false},{"sender":"cbentzel@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode8\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:8: #include \"chrome/browser/cert_store.h\"\nA bunch of these includes are not needed:\n\ncert_store\nresource_request_details.h\n\nprobably others.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode24\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:24: RenderViewHost* rvh = RenderViewHost::FromID(process_id, view_id);\nYou should probably DCHECK that this is called on the UI thread - although some of the things you call may be doing that as well.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode24\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:24: RenderViewHost* rvh = RenderViewHost::FromID(process_id, view_id);\nDo you want to DCHECK that the notification_type is an expected one?\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode25\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:25: if (rvh) {\nYou can also do \n\nif (!rvh)\n  return;\n\nto minimize indentation.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode28\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:28: Source<RenderViewHostDelegate>(rvhd),\nThis certainly simplifies things for prerender, but feels a little weird that the rvhd is being used a source rather than renderviewsource, or Profile, or DownloadManger.\n\nI don't think you need to change for now, but it seems like a mismatch.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode33\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:33: }\nNit: add // namespace to make it clear what this block closes.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode84\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:84: BrowserThread::PostTask(\nI thought this was going to move into DownloadResourceHandler as a more centralized location? Am I wrong?\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.h\nFile chrome/browser/renderer_host/download_throttling_resource_handler.h (right):\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode13\nchrome/browser/renderer_host/download_throttling_resource_handler.h:13: #include \"chrome/common/notification_type.h\"\nInclude not needed.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode18\nchrome/browser/renderer_host/download_throttling_resource_handler.h:18: class ResourceRequestDetails;\nThis isn't needed now that you are passing NoDetails.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode70\nchrome/browser/renderer_host/download_throttling_resource_handler.h:70: ResourceRequestDetails* GetResourceRequestDetails();\nAlso not needed since passing NoDetails.","disapproval":false,"date":"2011-02-10 14:44:34.835347","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"I apologize for requesting the extra work, but I'd like to see this put on all of the paths that may initiate a download.  Calling it \"DOWNLOAD_INITIATED\" will tempt people to hook it, and then they'll be surprised when a download does an end run around the notification.  (This is also why I don't want the RenderViewHostDelegate as the source.)  \n\nIt's not ideal that we're by hand instrumenting several different locations, but I don't see a better way to go given that we want to hook initiation and can't count on making it to DownloadResourceHandler.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/prerender/prerender_contents.cc#newcode220\nchrome/browser/prerender/prerender_contents.cc:220: // delegating, kill the prerender. This will also stop the download and\nCan you give me the context for how killing the prerender stops the download?  I thought that the download never got started because the limiter blocked it.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode28\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:28: Source<RenderViewHostDelegate>(rvhd),\nOn 2011/02/10 14:44:34, cbentzel wrote:\n> This certainly simplifies things for prerender, but feels a little weird that\n> the rvhd is being used a source rather than renderviewsource, or Profile, or\n> DownloadManger.\n> \n> I don't think you need to change for now, but it seems like a mismatch.\n\nI would agree with this comment, and unless it really makes your life difficult, I'd like to see it changed.  Temporary solutions aren't, and this would be weird and wrong to have in the code long-term.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode84\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:84: BrowserThread::PostTask(\nOn 2011/02/10 14:44:34, cbentzel wrote:\n> I thought this was going to move into DownloadResourceHandler as a more\n> centralized location? Am I wrong?\n\nWe never get to DownloadResourceHandler, so he can't put it there.","disapproval":false,"date":"2011-02-10 16:57:10.284858","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6459005/diff/11003/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/prerender/prerender_contents.cc#newcode220\nchrome/browser/prerender/prerender_contents.cc:220: // delegating, kill the prerender. This will also stop the download and\nOn 2011/02/10 16:57:10, rdsmith wrote:\n> Can you give me the context for how killing the prerender stops the download?  I\n> thought that the download never got started because the limiter blocked it.\n\nYou're right - changed the comment to reflect that.\n\nWhen the prerender is cancelled, the RenderViewHost is shutdown and deleted and unless I've missed something this cancels all requests made from that RenderViewHost.\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode8\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:8: #include \"chrome/browser/cert_store.h\"\nOn 2011/02/10 14:44:34, cbentzel wrote:\n> A bunch of these includes are not needed:\n> \n> cert_store\n> resource_request_details.h\n> \n> probably others. \n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode24\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:24: RenderViewHost* rvh = RenderViewHost::FromID(process_id, view_id);\nOn 2011/02/10 14:44:34, cbentzel wrote:\n> You should probably DCHECK that this is called on the UI thread - although some\n> of the things you call may be doing that as well.\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode24\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:24: RenderViewHost* rvh = RenderViewHost::FromID(process_id, view_id);\nOn 2011/02/10 14:44:34, cbentzel wrote:\n> Do you want to DCHECK that the notification_type is an expected one?\nI can, but given this is local to the file and is written to be generic, I don't think it's necessary. Especially if I use the handler as a Source.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode28\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:28: Source<RenderViewHostDelegate>(rvhd),\nOn 2011/02/10 16:57:10, rdsmith wrote:\n> On 2011/02/10 14:44:34, cbentzel wrote:\n> > This certainly simplifies things for prerender, but feels a little weird that\n> > the rvhd is being used a source rather than renderviewsource, or Profile, or\n> > DownloadManger.\n> > \n> > I don't think you need to change for now, but it seems like a mismatch.\n> \n> I would agree with this comment, and unless it really makes your life difficult,\n> I'd like to see it changed.  Temporary solutions aren't, and this would be weird\n> and wrong to have in the code long-term.\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.h\nFile chrome/browser/renderer_host/download_throttling_resource_handler.h (right):\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode13\nchrome/browser/renderer_host/download_throttling_resource_handler.h:13: #include \"chrome/common/notification_type.h\"\nOn 2011/02/10 14:44:34, cbentzel wrote:\n> Include not needed.\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode18\nchrome/browser/renderer_host/download_throttling_resource_handler.h:18: class ResourceRequestDetails;\nOn 2011/02/10 14:44:34, cbentzel wrote:\n> This isn't needed now that you are passing NoDetails.\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/11003/chrome/browser/renderer_host/download_throttling_resource_handler.h#newcode70\nchrome/browser/renderer_host/download_throttling_resource_handler.h:70: ResourceRequestDetails* GetResourceRequestDetails();\nOn 2011/02/10 14:44:34, cbentzel wrote:\n> Also not needed since passing NoDetails.\n\nDone.","disapproval":false,"date":"2011-02-10 18:46:22.605783","approval":false},{"sender":"cbentzel@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"Prerender stuff looks fine, but the downloads change still looks wrong to me.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/prerender/prerender_contents.cc#newcode224\nchrome/browser/prerender/prerender_contents.cc:224: if (rvh->delegate() == this) {\nMay not hurt to be defensive and check that rvh is non-NULL.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/prerender/prerender_contents.cc#newcode227\nchrome/browser/prerender/prerender_contents.cc:227: return;\nmove return next to Destroy and make this break, to be similar to Observe.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode145\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:145: BrowserThread::UI, FROM_HERE,\nI really don't think this is what you want - it will send out a notification each time some bytes are read from the stream.","disapproval":false,"date":"2011-02-10 19:32:18.688439","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"Annotated some changes but i'm not uploading a new patch set yet.\n\nI went through the entry points from RDH into the Downloads and made sure I'm adding the notification to those places that are called when a download starts. I'd like some feedback before I upload again.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/prerender/prerender_contents.cc#newcode224\nchrome/browser/prerender/prerender_contents.cc:224: if (rvh->delegate() == this) {\nOn 2011/02/10 19:32:18, cbentzel wrote:\n> May not hurt to be defensive and check that rvh is non-NULL. \n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/prerender/prerender_contents.cc#newcode227\nchrome/browser/prerender/prerender_contents.cc:227: return;\nOn 2011/02/10 19:32:18, cbentzel wrote:\n> move return next to Destroy and make this break, to be similar to Observe.\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode108\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:108: NewRunnableFunction(&NotifyOnUI, NotificationType::DOWNLOAD_INITIATED,\nMoving this to OnWillStart for the same reasons as outlined below. This is called once but only once we've started.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode145\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:145: BrowserThread::UI, FROM_HERE,\nOn 2011/02/10 19:32:18, cbentzel wrote:\n> I really don't think this is what you want - it will send out a notification\n> each time some bytes are read from the stream. \n\nYou're right - I was going from rdsmith's diagram of entry points but it looks like this one can't be hit without one of the other entry points being hit first.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode145\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:145: BrowserThread::UI, FROM_HERE,\nOn 2011/02/10 19:32:18, cbentzel wrote:\n> I really don't think this is what you want - it will send out a notification\n> each time some bytes are read from the stream. \n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode159\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:159: NewRunnableFunction(&NotifyOnUI, NotificationType::DOWNLOAD_INITIATED,\nThis suffers from the same issue as above. Even though it is an entry point from RDH, it is only called when a download request cannot be initiated or has completed. Neither match the concept of an initiated download so I'm removing this too.","disapproval":false,"date":"2011-02-10 20:02:17.856865","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"I just read through and reviewed the download code.\n\nI would like to see the other entry points for downloads be instrumented as well.  That isn't necessary for the pre-render work, but if you put a notification in the system that claims to be triggered when a download is initiated, it should be triggered whenever a download is initiated, yes?  From the reverse callgraph I posted, I think that just means you need to instrument ResourceDispatcherHost::BeginDownload.  Any objection to that?\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode86\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:86: render_process_host_id_, render_view_id_));\nWhy do separate notifications for request redirected and response started?  It's a single download.  \n\nMy inclination would be to put the notification in the constructor; any reason not to do that?\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode145\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:145: BrowserThread::UI, FROM_HERE,\nOn 2011/02/10 20:02:17, dominic wrote:\n> You're right - I was going from rdsmith's diagram of entry points but it looks\n> like this one can't be hit without one of the other entry points being hit\n> first.\n\nSorry; that diagram shows control flow within the download system.  For all the reasons we've talked about, that's probably not relevant to you; the limiter keeps the download from actually starting in the common case.  I think you want the notification just from the constructor.","disapproval":false,"date":"2011-02-11 18:44:15.399514","approval":false},{"sender":"dominic@google.com","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"On Fri, Feb 11, 2011 at 10:44 AM, <rdsmith@chromium.org> wrote:\n\n> I just read through and reviewed the download code.\n>\n> I would like to see the other entry points for downloads be instrumented as\n> well.  That isn't necessary for the pre-render work, but if you put a\n> notification in the system that claims to be triggered when a download is\n> initiated, it should be triggered whenever a download is initiated, yes?\n>  From\n> the reverse callgraph I posted, I think that just means you need to\n> instrument\n> ResourceDispatcherHost::BeginDownload.  Any objection to that?\n>\n>\nI've checked out the call-graph for the automatic and manual download cases,\nand this is what I found:\n\nFrom the context menu:\n  DownloadManager::DownloadUrl\n  .  download_util::DownloadUrl\n  .  .  ResourceDispatcherHost::BeginDownload\n  .  .  .  DownloadResourceHandler::DownloadResourceHandler\n\nAutomatic downloads:\n  ResourceDispatcherHost::CompleteRead\n  .  SafeBrowsingResourceHandler::OnReadCompleted\n  .  .  BufferedResourceHandler::OnReadCompleted\n  .  .  .  BufferedResourceHandler::CompleteResponseStarted\n  .  .  .  .    DownloadThrottlingResourceHandler::\nDownloadThrottlingResourceHandler\n\nSo I agree that notifying in both the Download*ResourceHandler constructors\nis the way to go. I'll clean everything up and upload for review.\n","disapproval":false,"date":"2011-02-11 22:11:18.817477","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/14001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode86\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:86: render_process_host_id_, render_view_id_));\nOn 2011/02/11 18:44:15, rdsmith wrote:\n> Why do separate notifications for request redirected and response started?  It's\n> a single download.  \n> \n> My inclination would be to put the notification in the constructor; any reason\n> not to do that?\n\nDone.","disapproval":false,"date":"2011-02-11 22:51:54.204202","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_resource_handler.cc\nFile chrome/browser/renderer_host/download_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_resource_handler.cc#newcode68\nchrome/browser/renderer_host/download_resource_handler.cc:68: render_process_host_id, render_view_id_));\nI'd rather not notify from the DownloadResourceHandler constructor, as that'll mean in the case where a download comes off of the usual path (i.e. through the DownloadThrottlingResourceHandler) you'll get two notifications that the same download is starting.  I don't like the fragility of putting the notification in ResourceDispatcherHost::BeginDownload, but it has the advantage of covering all the (current :-{) pathways through which a download can be initiated while still giving you the notification you're looking for when the initiation doesn't actually go through to creating a DownloadResourceHandler.\n\nhttp://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode28\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:28: }  // namespace\nIs dislike duplicating this code; is there anywhere more appropriate to put it?  I'll admit I'm not coming up with anything :-{.  Maybe make it specific to DOWNLOAD_INITIATED and make it a static function on DownloadResourceHandler?\n\n(I'd also accept leaving it here--I'm not coming up with great options on this one.)","disapproval":false,"date":"2011-02-13 03:08:36.173516","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_resource_handler.cc\nFile chrome/browser/renderer_host/download_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_resource_handler.cc#newcode68\nchrome/browser/renderer_host/download_resource_handler.cc:68: render_process_host_id, render_view_id_));\nOn 2011/02/13 03:08:36, rdsmith wrote:\n> I'd rather not notify from the DownloadResourceHandler constructor, as that'll\n> mean in the case where a download comes off of the usual path (i.e. through the\n> DownloadThrottlingResourceHandler) you'll get two notifications that the same\n> download is starting.  I don't like the fragility of putting the notification in\n> ResourceDispatcherHost::BeginDownload, but it has the advantage of covering all\n> the (current :-{) pathways through which a download can be initiated while still\n> giving you the notification you're looking for when the initiation doesn't\n> actually go through to creating a DownloadResourceHandler.\n\nI was considering download_util::DownloadUrl as an alternative to RDH::BeginDownload as it may be a little more future-proof. What do you think?\n\nhttp://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_throttling_resource_handler.cc\nFile chrome/browser/renderer_host/download_throttling_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_throttling_resource_handler.cc#newcode28\nchrome/browser/renderer_host/download_throttling_resource_handler.cc:28: }  // namespace\nOn 2011/02/13 03:08:36, rdsmith wrote:\n> Is dislike duplicating this code; is there anywhere more appropriate to put it? \n> I'll admit I'm not coming up with anything :-{.  Maybe make it specific to\n> DOWNLOAD_INITIATED and make it a static function on DownloadResourceHandler?\n> \n> (I'd also accept leaving it here--I'm not coming up with great options on this\n> one.)\n\nI do want to keep it generic as I can see this being extended to include download cancelation notifications in the future, but I agree it isn't great. Maybe download_util makes sense for this too.","disapproval":false,"date":"2011-02-14 16:07:12.148153","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"I think we're almost there.  Just a few comments.\n\nhttp://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_resource_handler.cc\nFile chrome/browser/renderer_host/download_resource_handler.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/22001/chrome/browser/renderer_host/download_resource_handler.cc#newcode68\nchrome/browser/renderer_host/download_resource_handler.cc:68: render_process_host_id, render_view_id_));\nOn 2011/02/14 16:07:12, dominic wrote:\n> On 2011/02/13 03:08:36, rdsmith wrote:\n> > I'd rather not notify from the DownloadResourceHandler constructor, as that'll\n> > mean in the case where a download comes off of the usual path (i.e. through\n> the\n> > DownloadThrottlingResourceHandler) you'll get two notifications that the same\n> > download is starting.  I don't like the fragility of putting the notification\n> in\n> > ResourceDispatcherHost::BeginDownload, but it has the advantage of covering\n> all\n> > the (current :-{) pathways through which a download can be initiated while\n> still\n> > giving you the notification you're looking for when the initiation doesn't\n> > actually go through to creating a DownloadResourceHandler.\n> \n> I was considering download_util::DownloadUrl as an alternative to\n> RDH::BeginDownload as it may be a little more future-proof. What do you think?\n\nNeither one's particularly future-proof, I'm afraid :-{.  I have (vague) plans to get rid of download_util based on a recent rant of Brett's on chromium-dev, and no current plans to get rid of RDH::BeginDownload, but I don't consider either of them part of a particularly clean architecture.  It's sort of like the breakfast cereal adds: \"Standing next to ^W ^W Part of this complete architecture\" :-} :-J.\n\nHaving said that, I'd vote in favor of RDH just because there's a path that initiales a download that doesn't get notified if we use download_util: ResourceMessageFilter::OnDownloadUrl -> ResourceDispatcherHost::BeginDownload-> DownloadResourceHandler().  That happens when the renderer processes sends us a message requesting a download; I'm still not sure under what circumstances that happens, but if the path's in the code, I'd like to catch it.\n\nhttp://codereview.chromium.org/6459005/diff/28001/chrome/browser/download/download_util.cc\nFile chrome/browser/download/download_util.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/28001/chrome/browser/download/download_util.cc#newcode748\nchrome/browser/download/download_util.cc:748: render_process_host_id, render_view_id));\nSee notes elsewhere; this either needs to be moved to ResourceDispatcherHost or we need another notification point in ResourceMessageFilter::OnDownloadUrl, and I'd vote for choice #1.\n\nhttp://codereview.chromium.org/6459005/diff/28001/chrome/browser/download/download_util.cc#newcode767\nchrome/browser/download/download_util.cc:767: NotificationService::NoDetails());\nI'm happy with this location and structure.","disapproval":false,"date":"2011-02-14 19:20:51.368390","approval":false},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6459005/diff/28001/chrome/browser/download/download_util.cc\nFile chrome/browser/download/download_util.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/28001/chrome/browser/download/download_util.cc#newcode748\nchrome/browser/download/download_util.cc:748: render_process_host_id, render_view_id));\nOn 2011/02/14 19:20:51, rdsmith wrote:\n> See notes elsewhere; this either needs to be moved to ResourceDispatcherHost or\n> we need another notification point in ResourceMessageFilter::OnDownloadUrl, and\n> I'd vote for choice #1.\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/28001/chrome/browser/download/download_util.cc#newcode767\nchrome/browser/download/download_util.cc:767: NotificationService::NoDetails());\nOn 2011/02/14 19:20:51, rdsmith wrote:\n> I'm happy with this location and structure.\n\nDone.","disapproval":false,"date":"2011-02-15 19:09:19.140369","approval":false},{"sender":"cbentzel@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"LGTM, with two nits. \n\nPlease make sure Randy is OK with the download+RDH change.\n\nhttp://codereview.chromium.org/6459005/diff/43005/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/43005/chrome/browser/prerender/prerender_contents.cc#newcode222\nchrome/browser/prerender/prerender_contents.cc:222: DCHECK(details == NotificationService::NoDetails());\nNit: DCHECK_EQ\n\nhttp://codereview.chromium.org/6459005/diff/43005/chrome/common/notification_type.h\nFile chrome/common/notification_type.h (right):\n\nhttp://codereview.chromium.org/6459005/diff/43005/chrome/common/notification_type.h#newcode1227\nchrome/common/notification_type.h:1227: // prematurely. The source is the RenderViewHostDelegate. There are no\nComment is wrong - the source is RenderViewHost. You may also want to mention that it will not be none.","disapproval":false,"date":"2011-02-15 20:51:23.479706","approval":true},{"sender":"dominich@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"Fixed the nits. Will wait to upload in case rdsmith has any more comments.\n\nhttp://codereview.chromium.org/6459005/diff/43005/chrome/browser/prerender/prerender_contents.cc\nFile chrome/browser/prerender/prerender_contents.cc (right):\n\nhttp://codereview.chromium.org/6459005/diff/43005/chrome/browser/prerender/prerender_contents.cc#newcode222\nchrome/browser/prerender/prerender_contents.cc:222: DCHECK(details == NotificationService::NoDetails());\nOn 2011/02/15 20:51:23, cbentzel wrote:\n> Nit: DCHECK_EQ\n\nDone.\n\nhttp://codereview.chromium.org/6459005/diff/43005/chrome/common/notification_type.h\nFile chrome/common/notification_type.h (right):\n\nhttp://codereview.chromium.org/6459005/diff/43005/chrome/common/notification_type.h#newcode1227\nchrome/common/notification_type.h:1227: // prematurely. The source is the RenderViewHostDelegate. There are no\nOn 2011/02/15 20:51:23, cbentzel wrote:\n> Comment is wrong - the source is RenderViewHost. You may also want to mention\n> that it will not be none. \n\nDone.","disapproval":false,"date":"2011-02-15 21:25:42.951127","approval":false},{"sender":"rdsmith@chromium.org","recipients":["dominich@chromium.org","cbentzel@chromium.org","rdsmith@chromium.org","dominic@google.com","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","brettw-cc@chromium.org"],"text":"LGTM (only download and resource_dispatcher_host.* portions reviewed).","disapproval":false,"date":"2011-02-15 22:33:33.665315","approval":true},{"sender":"cbentzel@chromium.org","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"LGTM\n\nOn Tue, Feb 15, 2011 at 5:33 PM, <rdsmith@chromium.org> wrote:\n\n> LGTM (only download and resource_dispatcher_host.* portions reviewed).\n>\n>\n>\n> http://codereview.chromium.org/6459005/\n>\n","disapproval":false,"date":"2011-02-15 22:34:40.784778","approval":true}],"owner_email":"dominich@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src/","owner":"dominich","subject":"Cancel prerender when we discover a download starting from a page we are prer...","created":"2011-02-08 22:52:31.608165","patchsets":[1,7,9001,11003,14001,22001,28001,42001,43005,9036],"modified":"2011-05-09 13:11:23.958291","closed":true,"commit":false,"issue":6459005}