{"description":"Add a done task to ScreenRecorder::Stop()\r\n\r\nScreenRecorder::Stop() need a done task to indicate it is actually paused.\r\nThis is needed so that we can shutdown threads safely.\r\n\r\nBUG=69997\r\nTEST=remoting_unittests --gtest_filter=ScreenRecorder.*\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=72188","cc":["chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","ajwong@chromium.org"],"reviewers":["sergeyu@chromium.org","ajwong@chromium.org"],"messages":[{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","chromium-reviews@chromium.org","hclam@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","ajwong@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org"],"text":"Please take a look of this code. This adds a pause task to ScreenRecorder. However I'm also changing ChromotingHost at the same time so leaving Pause invocation as Pause(NULL) so those two patches will be submitted together instead of this going in alone.","disapproval":false,"date":"2011-01-19 02:25:57.211954","approval":false},{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","ajwong@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org"],"text":"hm.. fixed a bug in my code.. test didn't catch that..","disapproval":false,"date":"2011-01-19 02:44:13.871096","approval":false},{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","ajwong@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org"],"text":"This is ready for review. I changed pause to stop and so now it's safe to wait for stop task, release ScreenRecorder and terminates threads.","disapproval":false,"date":"2011-01-19 23:50:19.810019","approval":false},{"sender":"sergeyu@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","ajwong@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org"],"text":"http://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc\nFile remoting/host/screen_recorder.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc#newcode152\nremoting/host/screen_recorder.cc:152: if (task) {\nCall DoCompleteStop()?\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc#newcode270\nremoting/host/screen_recorder.cc:270: // more than one connection.\nI think we should just remove support for parallel connections\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc#newcode283\nremoting/host/screen_recorder.cc:283: if (network_stopped_)\nDo we really need network_stopped_? It should be safe to post DoFinishOneRecording task on capture_loop_, it doesn't do anything when started_ == false. If you remove network_stopped_, then we also don't need DoStopOnNetworkThread, and the whole shutdown process becomes much simpler.\n\nIs the problem that capture_loop_ may not exist at this point? Maybe we should use MessageLoopProxy instead of MessageLoop?\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc#newcode348\nremoting/host/screen_recorder.cc:348: // TODO(hclam): Invalid the full screen if there is a new connection added.\nInvalidate\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.h\nFile remoting/host/screen_recorder.h (right):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.h#newcode81\nremoting/host/screen_recorder.h:81: void Stop(Task* task);\nI think we should call it |done_task|, or |done|, or |stop_done|. |task| is not very meaningful.\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/protocol/buffered_socket_writer.cc\nFile remoting/protocol/buffered_socket_writer.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/protocol/buffered_socket_writer.cc#newcode73\nremoting/protocol/buffered_socket_writer.cc:73: // Don't try to write if there is another write pending.\nRemove extra spaces\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/protocol/buffered_socket_writer.h\nFile remoting/protocol/buffered_socket_writer.h (left):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/protocol/buffered_socket_writer.h#oldcode93\nremoting/protocol/buffered_socket_writer.h:93: scoped_ptr<WriteFailedCallback> write_failed_callback_;\nWhy do you need to remove this?","disapproval":false,"date":"2011-01-20 19:14:17.630710","approval":false},{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","ajwong@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org"],"text":"Addressing style problems later.\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc\nFile remoting/host/screen_recorder.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc#newcode270\nremoting/host/screen_recorder.cc:270: // more than one connection.\nOn 2011/01/20 19:14:17, sergeyu wrote:\n> I think we should just remove support for parallel connections\n\nI'd leave the decision later, not really related to this patch.\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc#newcode283\nremoting/host/screen_recorder.cc:283: if (network_stopped_)\nOn 2011/01/20 19:14:17, sergeyu wrote:\n> Do we really need network_stopped_? It should be safe to post\n> DoFinishOneRecording task on capture_loop_, it doesn't do anything when started_\n> == false. If you remove network_stopped_, then we also don't need\n> DoStopOnNetworkThread, and the whole shutdown process becomes much simpler.\n> \n> Is the problem that capture_loop_ may not exist at this point? Maybe we should\n> use MessageLoopProxy instead of MessageLoop?\n\nThe problem that needs network_stopped_ here is that when we are shutting down capture loop, network loop can receive a callback and needs to post back to the capture loop and that causes race conditions in MessageLoop code.\n\nI think we've gone through this argument before, the reason that we're not using MessageLoopProxy was because we thought we can order destruction nicely and doesn't need refcounting. Since we made that decision in the first place we should try to make it happen.\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/protocol/buffered_socket_writer.h\nFile remoting/protocol/buffered_socket_writer.h (left):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/protocol/buffered_socket_writer.h#oldcode93\nremoting/protocol/buffered_socket_writer.h:93: scoped_ptr<WriteFailedCallback> write_failed_callback_;\nOn 2011/01/20 19:14:17, sergeyu wrote:\n> Why do you need to remove this?\n\nGoing through I found this is not used at all so I cleaned it up at the same time.","disapproval":false,"date":"2011-01-20 19:24:17.770750","approval":false},{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","ajwong@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","hclam@chromium.org"],"text":"Fixed style problems too.\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc\nFile remoting/host/screen_recorder.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.cc#newcode152\nremoting/host/screen_recorder.cc:152: if (task) {\nOn 2011/01/20 19:14:17, sergeyu wrote:\n> Call DoCompleteStop()?\n\nDone.\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.h\nFile remoting/host/screen_recorder.h (right):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/host/screen_recorder.h#newcode81\nremoting/host/screen_recorder.h:81: void Stop(Task* task);\nOn 2011/01/20 19:14:17, sergeyu wrote:\n> I think we should call it |done_task|, or |done|, or |stop_done|. |task| is not\n> very meaningful.\n\nDone.\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/protocol/buffered_socket_writer.cc\nFile remoting/protocol/buffered_socket_writer.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/7001/remoting/protocol/buffered_socket_writer.cc#newcode73\nremoting/protocol/buffered_socket_writer.cc:73: // Don't try to write if there is another write pending.\nOn 2011/01/20 19:14:17, sergeyu wrote:\n> Remove extra spaces\n\nweird... done.","disapproval":false,"date":"2011-01-20 19:32:08.144146","approval":false},{"sender":"sergeyu@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","ajwong@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","hclam@chromium.org"],"text":"LGTM\n\nhttp://codereview.chromium.org/6282006/diff/15001/remoting/host/screen_recorder.cc\nFile remoting/host/screen_recorder.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/15001/remoting/host/screen_recorder.cc#newcode346\nremoting/host/screen_recorder.cc:346: // TODO(hclam): Invalid the full screen if there is a new connection added.\ns/Invalid/Invalidate/","disapproval":false,"date":"2011-01-20 20:00:06.536406","approval":true},{"sender":"ajwong@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","ajwong@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","hclam@chromium.org"],"text":"I got acouple more comments...\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder.cc\nFile remoting/host/screen_recorder.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder.cc#newcode69\nremoting/host/screen_recorder.cc:69: void ScreenRecorder::Stop(Task* done_task) {\nCan we fix this combine the all the Stop/DoStop, SetMaxRate/DoSetMaxRate functions?\n\nCan be a separate CL, but we should fix the convention.\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder.cc#newcode218\nremoting/host/screen_recorder.cc:218: if (!started_)\nIs this a normal condition?\n\nIf so, should we warn?\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder.cc#newcode252\nremoting/host/screen_recorder.cc:252: if (network_stopped_) {\nThis class's comment needs a description of the various states that it can be in, and what that logically means.  We don't need to list out exactly which functions are allowed, but having the states listed out would help\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder_unittest.cc\nFile remoting/host/screen_recorder_unittest.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder_unittest.cc#newcode40\nremoting/host/screen_recorder_unittest.cc:40: delete arg0;\nI hate Chromium Tasks. :(\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder_unittest.cc#newcode145\nremoting/host/screen_recorder_unittest.cc:145: TEST_F(ScreenRecorderTest, StartAndStop) {\nWhat's the invariant that this is testing?  Can you add a 1-line comment above the TEST_F?","disapproval":false,"date":"2011-01-20 20:14:00.716974","approval":false},{"sender":"sergeyu@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","ajwong@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","hclam@chromium.org"],"text":"http://codereview.chromium.org/6282006/diff/21001/remoting/protocol/buffered_socket_writer.h\nFile remoting/protocol/buffered_socket_writer.h (left):\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/protocol/buffered_socket_writer.h#oldcode93\nremoting/protocol/buffered_socket_writer.h:93: scoped_ptr<WriteFailedCallback> write_failed_callback_;\nAfter looking at this again: This is supposed to be set in Init(). It's better to fix Init() so that it sets this callback instead of removing it completely.","disapproval":false,"date":"2011-01-20 20:56:26.245407","approval":false},{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","ajwong@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","hclam@chromium.org","ajwong@chromium.org"],"text":"http://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder.cc\nFile remoting/host/screen_recorder.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder.cc#newcode69\nremoting/host/screen_recorder.cc:69: void ScreenRecorder::Stop(Task* done_task) {\nOn 2011/01/20 20:14:00, awong wrote:\n> Can we fix this combine the all the Stop/DoStop, SetMaxRate/DoSetMaxRate\n> functions?\n> \n> Can be a separate CL, but we should fix the convention.\n\nwill do separately.\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder.cc#newcode218\nremoting/host/screen_recorder.cc:218: if (!started_)\nOn 2011/01/20 20:14:00, awong wrote:\n> Is this a normal condition?\n> \n> If so, should we warn?\n\nYou're right, this should be a DCHECK. The check in the next method is valid though.\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder.cc#newcode252\nremoting/host/screen_recorder.cc:252: if (network_stopped_) {\nOn 2011/01/20 20:14:00, awong wrote:\n> This class's comment needs a description of the various states that it can be\n> in, and what that logically means.  We don't need to list out exactly which\n> functions are allowed, but having the states listed out would help\n\nDone.\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder_unittest.cc\nFile remoting/host/screen_recorder_unittest.cc (right):\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/host/screen_recorder_unittest.cc#newcode145\nremoting/host/screen_recorder_unittest.cc:145: TEST_F(ScreenRecorderTest, StartAndStop) {\nOn 2011/01/20 20:14:00, awong wrote:\n> What's the invariant that this is testing?  Can you add a 1-line comment above\n> the TEST_F?\n\nDone.\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/protocol/buffered_socket_writer.h\nFile remoting/protocol/buffered_socket_writer.h (left):\n\nhttp://codereview.chromium.org/6282006/diff/21001/remoting/protocol/buffered_socket_writer.h#oldcode93\nremoting/protocol/buffered_socket_writer.h:93: scoped_ptr<WriteFailedCallback> write_failed_callback_;\nOn 2011/01/20 20:56:26, sergeyu wrote:\n> After looking at this again: This is supposed to be set in Init(). It's better\n> to fix Init() so that it sets this callback instead of removing it completely.\n\nRemoved from this patch.","disapproval":false,"date":"2011-01-20 22:48:47.799719","approval":false},{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","ajwong@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","ajwong@chromium.org"],"text":"ping.","disapproval":false,"date":"2011-01-21 18:58:44.486422","approval":false},{"sender":"ajwong@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","ajwong@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","ajwong@chromium.org"],"text":"One more comment.\n\nhttp://codereview.chromium.org/6282006/diff/26001/remoting/host/screen_recorder.h\nFile remoting/host/screen_recorder.h (right):\n\nhttp://codereview.chromium.org/6282006/diff/26001/remoting/host/screen_recorder.h#newcode65\nremoting/host/screen_recorder.h:65: // |started_| - If this is set to false there should be no activity on the\nstarted_ and network_stopped_ are negations of each other.  One says the thread should be used, and one says the thread should not.\n\nCan they both be \"started\" or \"stopped\"?\n\nAlso, maybe capture_started_ instead of just started_","disapproval":false,"date":"2011-01-21 19:09:40.819481","approval":false},{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","ajwong@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","ajwong@chromium.org"],"text":"On 2011/01/21 19:09:40, awong wrote:\n> One more comment.\n> \n> http://codereview.chromium.org/6282006/diff/26001/remoting/host/screen_recorder.h\n> File remoting/host/screen_recorder.h (right):\n> \n> http://codereview.chromium.org/6282006/diff/26001/remoting/host/screen_recorder.h#newcode65\n> remoting/host/screen_recorder.h:65: // |started_| - If this is set to false\n> there should be no activity on the\n> started_ and network_stopped_ are negations of each other.  One says the thread\n> should be used, and one says the thread should not.\n> \n> Can they both be \"started\" or \"stopped\"?\n> \n> Also, maybe capture_started_ instead of just started_\n\nrenamed it to capture_started but leave it as started. One says capture thread may be used, other says network thread must not be used, so negation doesn't work in this case.","disapproval":false,"date":"2011-01-21 19:18:39.230375","approval":false},{"sender":"hclam@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","ajwong@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","ajwong@chromium.org"],"text":"changed variable names and fixed comments.","disapproval":false,"date":"2011-01-21 19:37:28.604588","approval":false},{"sender":"ajwong@chromium.org","recipients":["hclam@chromium.org","sergeyu@chromium.org","ajwong@chromium.org","chromium-reviews@chromium.org","sergeyu@chromium.org","dmaclach@chromium.org","garykac@chromium.org","phajdan.jr@chromium.org","ajwong@chromium.org"],"text":"LGTM","disapproval":false,"date":"2011-01-21 19:42:19.734333","approval":true}],"owner_email":"hclam@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"Alpha","subject":"Add a done task to ScreenRecorder::Stop()","created":"2011-01-19 02:23:31.067125","patchsets":[1,3001,7001,15001,21001,26001,35001,39001,34002],"modified":"2011-06-22 20:20:39.710693","closed":true,"commit":false,"issue":6282006}