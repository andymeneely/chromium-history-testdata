{"description":"Implement get/set(saveformdata) for chromium based webview.\n\nBUG=b/6335434\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=200197","cc":["chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"reviewers":["benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","joth@chromium.org"],"messages":[{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"Rough patch not ready for a detailed review yet.","disapproval":false,"date":"2013-05-01 20:54:45.418790","approval":false},{"sender":"mnaganov@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"Some comments about the settings part\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/java/src/org/chromium/android_webview/AwSettings.java\nFile android_webview/java/src/org/chromium/android_webview/AwSettings.java (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/java/src/org/chromium/android_webview/AwSettings.java#newcode353\nandroid_webview/java/src/org/chromium/android_webview/AwSettings.java:353: mAutoCompleteEnabled = enable;\nShould we check for (mAutoCompleteEnabled != enabled) first?\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/java/src/org/chromium/android_webview/AwSettings.java#newcode354\nandroid_webview/java/src/org/chromium/android_webview/AwSettings.java:354: ThreadUtils.runOnUiThreadBlocking(new Runnable() {\nIf you are using a parameter, you don't need to execute this inside the 'synchronized', as the C++ part will not be accessing Java object fields.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_contents.cc#newcode161\nandroid_webview/native/aw_contents.cc:161: autofill::AutofillManager::FromWebContents(web_contents_.get()));\nPerhaps, you should cache this at least to make the code a bit shorter.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_settings.cc\nFile android_webview/native/aw_settings.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_settings.cc#newcode377\nandroid_webview/native/aw_settings.cc:377: void AwSettings::SetSaveFormData(JNIEnv* env, jobject obj, jboolean enabled) {\nDoes this work even if there is no RenderView has been created yet? If not, this should be a part of UpdateEverything and instead of getting 'enabled' as a parameter it should read the current value from the java object.","disapproval":false,"date":"2013-05-01 21:15:13.995100","approval":false},{"sender":"benm@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode29\nandroid_webview/browser/aw_autofill_manager_delegate.cc:29: pref_registry_->RegisterBooleanPref(autofill::prefs::kAutofillEnabled, true);\nmaybe this default setting should be passed into the ctor based on the setting from java.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode57\nandroid_webview/browser/aw_autofill_manager_delegate.cc:57: AwAutofillManagerDelegate::~AwAutofillManagerDelegate() { }\nnit: move this up by the ctor.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode64\nandroid_webview/browser/aw_autofill_manager_delegate.cc:64: PrefService* AwAutofillManagerDelegate::GetPrefs() {\nMove this up to where we have other real implementations so it doesn't get ;lost in the no-ops.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.h\nFile android_webview/browser/aw_autofill_manager_delegate.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.h#newcode21\nandroid_webview/browser/aw_autofill_manager_delegate.h:21: namespace autocheckout {\nnit move this new namespace after FormData?\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.h#newcode89\nandroid_webview/browser/aw_autofill_manager_delegate.h:89: scoped_refptr<PrefRegistrySimple> pref_registry_;\ndo these need to be members?\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_pref_store.h\nFile android_webview/browser/aw_pref_store.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_pref_store.h#newcode46\nandroid_webview/browser/aw_pref_store.h:46: // Marks the store as having completed initialization.\nLooks like we can trim some of these methods for our purposes.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_contents.cc#newcode687\nandroid_webview/native/aw_contents.cc:687: \nnit: spurious \\n\n\nhttps://codereview.chromium.org/14637009/diff/2001/components/autofill/browser/autofill_download.cc\nFile components/autofill/browser/autofill_download.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/components/autofill/browser/autofill_download.cc#newcode83\ncomponents/autofill/browser/autofill_download.cc:83: \ncan revert this file?","disapproval":false,"date":"2013-05-02 17:32:58.391350","approval":false},{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode29\nandroid_webview/browser/aw_autofill_manager_delegate.cc:29: pref_registry_->RegisterBooleanPref(autofill::prefs::kAutofillEnabled, true);\nI agree. However, one difficulty is retrieving the java setting at the point we create AwAutoFillManagerDelegate. (It is created by AwContents). \n\nthis default setting has no value, it is always overwritten by the java value during UpdateEverything. Maybe just putting a comment clarifying the issue is good enough.\n\nAnother approach could be creating the AwAutofillManagerDelegate in AwSettings but I did not look at it that carefully. \n\nOn 2013/05/02 17:32:58, benm wrote:\n> maybe this default setting should be passed into the ctor based on the setting\n> from java.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode57\nandroid_webview/browser/aw_autofill_manager_delegate.cc:57: AwAutofillManagerDelegate::~AwAutofillManagerDelegate() { }\nOn 2013/05/02 17:32:58, benm wrote:\n> nit: move this up by the ctor.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode64\nandroid_webview/browser/aw_autofill_manager_delegate.cc:64: PrefService* AwAutofillManagerDelegate::GetPrefs() {\nOn 2013/05/02 17:32:58, benm wrote:\n> Move this up to where we have other real implementations so it doesn't get ;lost\n> in the no-ops.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.h\nFile android_webview/browser/aw_autofill_manager_delegate.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.h#newcode21\nandroid_webview/browser/aw_autofill_manager_delegate.h:21: namespace autocheckout {\nOn 2013/05/02 17:32:58, benm wrote:\n> nit move this new namespace after FormData?\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.h#newcode89\nandroid_webview/browser/aw_autofill_manager_delegate.h:89: scoped_refptr<PrefRegistrySimple> pref_registry_;\ngood point. I chose this as it sounded the safest but I think we can get rid of them (one a stack object and another \nowned by prefservice anyway.\n\nOn 2013/05/02 17:32:58, benm wrote:\n> do these need to be members?\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_pref_store.h\nFile android_webview/browser/aw_pref_store.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_pref_store.h#newcode46\nandroid_webview/browser/aw_pref_store.h:46: // Marks the store as having completed initialization.\nOn 2013/05/02 17:32:58, benm wrote:\n> Looks like we can trim some of these methods for our purposes.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/java/src/org/chromium/android_webview/AwSettings.java\nFile android_webview/java/src/org/chromium/android_webview/AwSettings.java (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/java/src/org/chromium/android_webview/AwSettings.java#newcode353\nandroid_webview/java/src/org/chromium/android_webview/AwSettings.java:353: mAutoCompleteEnabled = enable;\nOn 2013/05/01 21:15:14, Mikhail Naganov (Chromium) wrote:\n> Should we check for (mAutoCompleteEnabled != enabled) first?\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/java/src/org/chromium/android_webview/AwSettings.java#newcode354\nandroid_webview/java/src/org/chromium/android_webview/AwSettings.java:354: ThreadUtils.runOnUiThreadBlocking(new Runnable() {\nchanged this to use updateeverything - so now we do access it from c++.\n\nOn 2013/05/01 21:15:14, Mikhail Naganov (Chromium) wrote:\n> If you are using a parameter, you don't need to execute this inside the\n> 'synchronized', as the C++ part will not be accessing Java object fields.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_contents.cc#newcode161\nandroid_webview/native/aw_contents.cc:161: autofill::AutofillManager::FromWebContents(web_contents_.get()));\nOn 2013/05/01 21:15:14, Mikhail Naganov (Chromium) wrote:\n> Perhaps, you should cache this at least to make the code a bit shorter.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_contents.cc#newcode687\nandroid_webview/native/aw_contents.cc:687: \nOn 2013/05/02 17:32:58, benm wrote:\n> nit: spurious \\n\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_settings.cc\nFile android_webview/native/aw_settings.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/native/aw_settings.cc#newcode377\nandroid_webview/native/aw_settings.cc:377: void AwSettings::SetSaveFormData(JNIEnv* env, jobject obj, jboolean enabled) {\nOn 2013/05/01 21:15:14, Mikhail Naganov (Chromium) wrote:\n> Does this work even if there is no RenderView has been created yet? If not, this\n> should be a part of UpdateEverything and instead of getting 'enabled' as a\n> parameter it should read the current value from the java object.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/2001/components/autofill/browser/autofill_download.cc\nFile components/autofill/browser/autofill_download.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/components/autofill/browser/autofill_download.cc#newcode83\ncomponents/autofill/browser/autofill_download.cc:83: \nOn 2013/05/02 17:32:58, benm wrote:\n> can revert this file?\n\nDone.","disapproval":false,"date":"2013-05-07 00:34:12.743010","approval":false},{"sender":"mnaganov@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"Thanks! The settings part now look sane. Just a few nits.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode34\nandroid_webview/browser/aw_autofill_manager_delegate.cc:34: 0.0);\nnit: this can go with the previous line\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.cc\nFile android_webview/browser/aw_pref_store.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.cc#newcode40\nandroid_webview/browser/aw_pref_store.cc:40: if (prefs_.SetValue(key, value)) {\nnit: I think you can also omit curly brackets here for consistency with \"RemoveValue\".\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.h\nFile android_webview/browser/aw_pref_store.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.h#newcode18\nandroid_webview/browser/aw_pref_store.h:18: // but this seems the only way to satisfy the internal implementation.\nNot sure what \"internal implementation\" means. Is that about requirements imposed by the content layer or by the classic WebView implementation?","disapproval":false,"date":"2013-05-07 08:32:16.232550","approval":false},{"sender":"benm@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"thanks selim!\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode29\nandroid_webview/browser/aw_autofill_manager_delegate.cc:29: pref_registry_->RegisterBooleanPref(autofill::prefs::kAutofillEnabled, true);\nI think it makes sense for this to be managed by AwContents. A comment is probably good enough.\n\nOr... how would it be if we were to only instantiate/set this Delegate once we'd synced across the enabled pref? AwSettings could call back into AwContents to do that.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode34\nandroid_webview/browser/aw_autofill_manager_delegate.cc:34: 0.0);\nand the one below :)\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode67\nandroid_webview/browser/aw_autofill_manager_delegate.cc:67: autofill::PersonalDataManager*\nMaybe add a NOTREACHED() on each of these no-ops.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.h\nFile android_webview/browser/aw_pref_store.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.h#newcode18\nandroid_webview/browser/aw_pref_store.h:18: // but this seems the only way to satisfy the internal implementation.\nI think it's because to use PrefServiceBuilder with UserPrefs you need to supply a PersistentPrefStore. Maybe expand the comment to explain this is only used to enable/disable the autofill functionality in WebView and so doesn't need to persist to disk.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/native/aw_contents.cc#newcode167\nandroid_webview/native/aw_contents.cc:167: AutofillExternalDelegate::FromWebContents(web_contents_.get()));\nnit: Factor this lot out into a private InitAutofill method. Also as per my comment on the previous patch set, can we make this lazy based on the setting synced from java?","disapproval":false,"date":"2013-05-07 11:39:54.767710","approval":false},{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/2001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode29\nandroid_webview/browser/aw_autofill_manager_delegate.cc:29: pref_registry_->RegisterBooleanPref(autofill::prefs::kAutofillEnabled, true);\nOn 2013/05/07 11:39:55, benm wrote:\n> I think it makes sense for this to be managed by AwContents. A comment is\n> probably good enough.\n> \n> Or... how would it be if we were to only instantiate/set this Delegate once we'd\n> synced across the enabled pref? AwSettings could call back into AwContents to do\n> that.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode34\nandroid_webview/browser/aw_autofill_manager_delegate.cc:34: 0.0);\nOn 2013/05/07 08:32:16, Mikhail Naganov (Chromium) wrote:\n> nit: this can go with the previous line\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode34\nandroid_webview/browser/aw_autofill_manager_delegate.cc:34: 0.0);\nOn 2013/05/07 11:39:55, benm wrote:\n> and the one below :)\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode67\nandroid_webview/browser/aw_autofill_manager_delegate.cc:67: autofill::PersonalDataManager*\nOn 2013/05/07 11:39:55, benm wrote:\n> Maybe add a NOTREACHED() on each of these no-ops.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.cc\nFile android_webview/browser/aw_pref_store.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.cc#newcode40\nandroid_webview/browser/aw_pref_store.cc:40: if (prefs_.SetValue(key, value)) {\nOn 2013/05/07 08:32:16, Mikhail Naganov (Chromium) wrote:\n> nit: I think you can also omit curly brackets here for consistency with\n> \"RemoveValue\".\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.h\nFile android_webview/browser/aw_pref_store.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.h#newcode18\nandroid_webview/browser/aw_pref_store.h:18: // but this seems the only way to satisfy the internal implementation.\nThis is to satisfy the Autofill component (of chromium). Autofill retrieves a PrefService() object, which needs a PersistentPrefStore. \n\nadded more comments.\n\nOn 2013/05/07 11:39:55, benm wrote:\n> I think it's because to use PrefServiceBuilder with UserPrefs you need to supply\n> a PersistentPrefStore. Maybe expand the comment to explain this is only used to\n> enable/disable the autofill functionality in WebView and so doesn't need to\n> persist to disk.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/browser/aw_pref_store.h#newcode18\nandroid_webview/browser/aw_pref_store.h:18: // but this seems the only way to satisfy the internal implementation.\nOn 2013/05/07 11:39:55, benm wrote:\n> I think it's because to use PrefServiceBuilder with UserPrefs you need to supply\n> a PersistentPrefStore. Maybe expand the comment to explain this is only used to\n> enable/disable the autofill functionality in WebView and so doesn't need to\n> persist to disk.\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16001/android_webview/native/aw_contents.cc#newcode167\nandroid_webview/native/aw_contents.cc:167: AutofillExternalDelegate::FromWebContents(web_contents_.get()));\nOn 2013/05/07 11:39:55, benm wrote:\n> nit: Factor this lot out into a private InitAutofill method. Also as per my\n> comment on the previous patch set, can we make this lazy based on the setting\n> synced from java?\n\nDone.","disapproval":false,"date":"2013-05-07 22:15:06.594270","approval":false},{"sender":"benm@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/27001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode149\nandroid_webview/browser/aw_autofill_manager_delegate.cc:149: NOTREACHED();\nWell this one should be reached, right? It's how we will get our data out to the java side to be able to show the UI, isn't it?\n\nI may have been wrong to suggest adding these NOTREACHED, might be better to remove them (or we need to check where they are called from and decide if it's appropriate for them to be a no-op in our implementation of the delegate)\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/browser/aw_autofill_manager_delegate.h\nFile android_webview/browser/aw_autofill_manager_delegate.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/browser/aw_autofill_manager_delegate.h#newcode89\nandroid_webview/browser/aw_autofill_manager_delegate.h:89: scoped_refptr<PrefRegistrySimple> pref_registry_;\nThink these can be deleted now?\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/native/aw_contents.cc#newcode164\nandroid_webview/native/aw_contents.cc:164: InitAutofill();\nIf the Init function took the enabled boolean, then we could pass it into the Delegate ctor, and get rid of the hardcoded true there for the initial state, I think?\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/native/aw_contents.cc#newcode174\nandroid_webview/native/aw_contents.cc:174: if (AutofillManager::FromWebContents(web_contents)) {\nI think this check only makes sense for the case that we're setting a new WebContents, so maybe move it up there?\n\nSo in SetWebContents we'd have:\n\nif (save_form_data_ && !AutofillManager::FromWebContents(web_contents))\n  InitAutofill()\n\nwdyt?","disapproval":false,"date":"2013-05-08 09:56:13.297110","approval":false},{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/27001/android_webview/browser/aw_autofill_manager_delegate.cc\nFile android_webview/browser/aw_autofill_manager_delegate.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/browser/aw_autofill_manager_delegate.cc#newcode149\nandroid_webview/browser/aw_autofill_manager_delegate.cc:149: NOTREACHED();\nLet's actually remove them. \n\nOn 2013/05/08 09:56:13, benm wrote:\n> Well this one should be reached, right? It's how we will get our data out to the\n> java side to be able to show the UI, isn't it?\n> \n> I may have been wrong to suggest adding these NOTREACHED, might be better to\n> remove them (or we need to check where they are called from and decide if it's\n> appropriate for them to be a no-op in our implementation of the delegate)\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/browser/aw_autofill_manager_delegate.h\nFile android_webview/browser/aw_autofill_manager_delegate.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/browser/aw_autofill_manager_delegate.h#newcode89\nandroid_webview/browser/aw_autofill_manager_delegate.h:89: scoped_refptr<PrefRegistrySimple> pref_registry_;\nOn 2013/05/08 09:56:13, benm wrote:\n> Think these can be deleted now?\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/native/aw_contents.cc#newcode164\nandroid_webview/native/aw_contents.cc:164: InitAutofill();\nOn 2013/05/08 09:56:13, benm wrote:\n> If the Init function took the enabled boolean, then we could pass it into the\n> Delegate ctor, and get rid of the hardcoded true there for the initial state, I\n> think?\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/27001/android_webview/native/aw_contents.cc#newcode174\nandroid_webview/native/aw_contents.cc:174: if (AutofillManager::FromWebContents(web_contents)) {\nOn 2013/05/08 09:56:13, benm wrote:\n> I think this check only makes sense for the case that we're setting a new\n> WebContents, so maybe move it up there?\n> \n> So in SetWebContents we'd have:\n> \n> if (save_form_data_ && !AutofillManager::FromWebContents(web_contents))\n>   InitAutofill()\n> \n> wdyt?\n\nDone.","disapproval":false,"date":"2013-05-08 20:27:18.047540","approval":false},{"sender":"benm@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"looking overall good, couple suggestions that might simplify the creation flow.\n\nhttps://codereview.chromium.org/14637009/diff/45001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/45001/android_webview/native/aw_contents.cc#newcode164\nandroid_webview/native/aw_contents.cc:164: // webcontents is set and save_form_data_ is false.\nthis asymmetry seems a bit funny. Could we only call InitAutoFill in SetWebContents if there's no AutofillManager (so don't check the value of save_form_data_ in SetWebContents). That way these will match and we'll always have an AutoFillManger created. (but see my other comment too)\n\nalong the same lines, must we create an autofill manager if enabled == false?\n\nif enabled == true\n - InitAutofill (if necessary)\nif enabled == false\n - if autofill manager == null, return\n - else delegate->SetSaceFormData(false)\n\nhttps://codereview.chromium.org/14637009/diff/45001/android_webview/native/aw_contents.cc#newcode172\nandroid_webview/native/aw_contents.cc:172: \nI think we could add a if (AutofillManager::FromWebContents(web_contents_.get()) return;\n\nhere, then we could unconditionally call InitAutoFill from both sites above (maybe rename this function InitAutoFillIfNecessary() )","disapproval":false,"date":"2013-05-09 18:17:46.072360","approval":false},{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/45001/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/45001/android_webview/native/aw_contents.cc#newcode164\nandroid_webview/native/aw_contents.cc:164: // webcontents is set and save_form_data_ is false.\nI thought you suggested lazy creation (which I like). I interpret this as \"create if enabled\". This is why we need to check for save_form_data_ before creating. \n\nI agree that we don't have to create the autofillmanager if it is not disabled and setsaveformdata(false) is called. However don't forget that you need to set the pref to true if enabled = true and autofill manager is already created.\n\nOne thing I would avoid is over-optimizing for the edge cases. I think readability is more important here, which I think what you are also aiming for.\n\nOn 2013/05/09 18:17:46, benm wrote:\n> this asymmetry seems a bit funny. Could we only call InitAutoFill in\n> SetWebContents if there's no AutofillManager (so don't check the value of\n> save_form_data_ in SetWebContents). That way these will match and we'll always\n> have an AutoFillManger created. (but see my other comment too)\n> \n> along the same lines, must we create an autofill manager if enabled == false?\n> \n> if enabled == true\n>  - InitAutofill (if necessary)\n> if enabled == false\n>  - if autofill manager == null, return\n>  - else delegate->SetSaceFormData(false)\n\nhttps://codereview.chromium.org/14637009/diff/45001/android_webview/native/aw_contents.cc#newcode172\nandroid_webview/native/aw_contents.cc:172: \nOn 2013/05/09 18:17:46, benm wrote:\n> I think we could add a if (AutofillManager::FromWebContents(web_contents_.get())\n> return;\n> \n> here, then we could unconditionally call InitAutoFill from both sites above\n> (maybe rename this function InitAutoFillIfNecessary() )\n\nDone.","disapproval":false,"date":"2013-05-09 21:30:58.247910","approval":false},{"sender":"benm@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/16002/android_webview/browser/aw_pref_store.cc\nFile android_webview/browser/aw_pref_store.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16002/android_webview/browser/aw_pref_store.cc#newcode75\nandroid_webview/browser/aw_pref_store.cc:75: AwPrefStore::~AwPrefStore() {}\nnit: move up by constructor\n\nhttps://codereview.chromium.org/14637009/diff/16002/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16002/android_webview/native/aw_contents.cc#newcode161\nandroid_webview/native/aw_contents.cc:161: save_form_data_ = enabled;\nIt's the readability i'm trying to address here I think, not optimising the edge cases. This still doesn't feel quite right to me, sorry for all the churn... :-(\n\nCan we eliminate this save_form_data_ member by passing enabled into InitAutoFillIfNecessary() here, and checking if the autofill_manager_delegate has been created already in the call in SetWebContents, something like this:\n\nvoid AwContents::SetWebContents() {\n...\n  if (autofill_manager_delegate_.get()) {\n    InitAutoFillIfNecessary(delegate->GetSaveFormData())\n  }\n}\n\nThat way I think everything remains lazy (nothing created until we get SetSaveFormData(true)) and the code flows a bit better for readability, wdyt?","disapproval":false,"date":"2013-05-09 23:21:55.617320","approval":false},{"sender":"benm@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/16002/components/autofill.gypi\nFile components/autofill.gypi (right):\n\nhttps://codereview.chromium.org/14637009/diff/16002/components/autofill.gypi#newcode110\ncomponents/autofill.gypi:110: 'user_prefs',\nare the edits here necessary? It doesn't look to me like you've changed anything inside the component in this CL?","disapproval":false,"date":"2013-05-09 23:26:38.262430","approval":false},{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/16002/android_webview/browser/aw_pref_store.cc\nFile android_webview/browser/aw_pref_store.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16002/android_webview/browser/aw_pref_store.cc#newcode75\nandroid_webview/browser/aw_pref_store.cc:75: AwPrefStore::~AwPrefStore() {}\nOn 2013/05/09 23:21:56, benm wrote:\n> nit: move up by constructor\n\nDone.\n\nhttps://codereview.chromium.org/14637009/diff/16002/android_webview/native/aw_contents.cc\nFile android_webview/native/aw_contents.cc (right):\n\nhttps://codereview.chromium.org/14637009/diff/16002/android_webview/native/aw_contents.cc#newcode161\nandroid_webview/native/aw_contents.cc:161: save_form_data_ = enabled;\nsure.\n\nOn 2013/05/09 23:21:56, benm wrote:\n> It's the readability i'm trying to address here I think, not optimising the edge\n> cases. This still doesn't feel quite right to me, sorry for all the churn... :-(\n> \n> Can we eliminate this save_form_data_ member by passing enabled into\n> InitAutoFillIfNecessary() here, and checking if the autofill_manager_delegate\n> has been created already in the call in SetWebContents, something like this:\n> \n> void AwContents::SetWebContents() {\n> ...\n>   if (autofill_manager_delegate_.get()) {\n>     InitAutoFillIfNecessary(delegate->GetSaveFormData())\n>   }\n> }\n> \n> That way I think everything remains lazy (nothing created until we get\n> SetSaveFormData(true)) and the code flows a bit better for readability, wdyt?\n\nhttps://codereview.chromium.org/14637009/diff/16002/components/autofill.gypi\nFile components/autofill.gypi (right):\n\nhttps://codereview.chromium.org/14637009/diff/16002/components/autofill.gypi#newcode110\ncomponents/autofill.gypi:110: 'user_prefs',\nYes. this fixes a bug in the autofill component (autofill_manager and autocomplete_history_manager makes use of these prefs)\n\nOn 2013/05/09 23:26:38, benm wrote:\n> are the edits here necessary? It doesn't look to me like you've changed anything\n> inside the component in this CL?","disapproval":false,"date":"2013-05-10 01:01:46.280060","approval":false},{"sender":"benm@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"lgtm\n\nthanks selim!","disapproval":false,"date":"2013-05-10 07:27:35.660680","approval":true},{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"@joi Need LGTM for components/webdata/common/web_database_service.h\n@isherman Need LGTM for\ncomponents/autofill.gypi","disapproval":false,"date":"2013-05-10 14:39:02.260850","approval":false},{"sender":"joi@chromium.org","recipients":["reply@chromiumcodereview-hr.appspotmail.com"],"text":"LGTM for components/webdata\r\n\r\nOn Fri, May 10, 2013 at 3:39 PM,  <sgurun@chromium.org> wrote:\r\n> @joi Need LGTM for components/webdata/common/web_database_service.h\r\n> @isherman Need LGTM for\r\n> components/autofill.gypi\r\n>\r\n> https://codereview.chromium.org/14637009/\r\n","disapproval":false,"date":"2013-05-10 20:37:58.626920","approval":true},{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"Mikhail, can you please take a look at the settings part once again.","disapproval":false,"date":"2013-05-10 20:38:48.033960","approval":false},{"sender":"isherman@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"autofill.gypi lgtm","disapproval":false,"date":"2013-05-10 21:02:39.372370","approval":true},{"sender":"commit-bot@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/sgurun@chromium.org/14637009/83001","disapproval":false,"date":"2013-05-13 14:29:50.975600","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/sgurun@chromium.org/14637009/110001","disapproval":false,"date":"2013-05-14 23:14:53.403440","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"Change committed as 200197","disapproval":false,"date":"2013-05-15 08:38:46.205060","approval":false},{"sender":"joth@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","joth@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/110001/android_webview/browser/aw_pref_store.h\nFile android_webview/browser/aw_pref_store.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/110001/android_webview/browser/aw_pref_store.h#newcode20\nandroid_webview/browser/aw_pref_store.h:20: class AwPrefStore : public PersistentPrefStore {\nin passing.... looks like we could factor out a bunch of this logic to share with TestingPrefStore if we wanted. InMemoryPersistentPrefStore or something... ?","disapproval":false,"date":"2013-05-21 02:02:17.903020","approval":false},{"sender":"sgurun@chromium.org","recipients":["sgurun@chromium.org","benm@chromium.org","mnaganov@chromium.org","isherman@chromium.org","joi@chromium.org","joth@chromium.org","chromium-reviews@chromium.org","ramankk@chromium.org","benquan@chromium.org","ahutter@chromium.org","browser-components-watch@chromium.org","dbeam+watch-autofill@chromium.org","dgwallinga@chromium.org","dyu@chromium.org","estade+watch@chromium.org","abodenha@chromium.org","isherman@chromium.org","android-webview-reviews@chromium.org"],"text":"https://codereview.chromium.org/14637009/diff/110001/android_webview/browser/aw_pref_store.h\nFile android_webview/browser/aw_pref_store.h (right):\n\nhttps://codereview.chromium.org/14637009/diff/110001/android_webview/browser/aw_pref_store.h#newcode20\nandroid_webview/browser/aw_pref_store.h:20: class AwPrefStore : public PersistentPrefStore {\nYep, we definitely can. once we enable the feature, I will get to this.\n\nOn 2013/05/21 02:02:18, joth wrote:\n> in passing.... looks like we could factor out a bunch of this logic to share\n> with TestingPrefStore if we wanted. InMemoryPersistentPrefStore or something...\n> ?","disapproval":false,"date":"2013-05-21 15:55:47.246160","approval":false}],"owner_email":"sgurun@chromium.org","private":false,"base_url":"https://chromium.googlesource.com/chromium/src.git@hasFormDataBase","owner":"sgurun","subject":"Implement get/set(saveformdata) for chromium based webview.","created":"2013-05-01 20:46:26.110830","patchsets":[1,2001,13001,16001,27001,34001,42001,45001,56002,16002,18005,83001,110001],"modified":"2013-05-21 15:55:47.246160","closed":true,"commit":false,"issue":14637009}