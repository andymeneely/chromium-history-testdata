{"description":"Libjingle-based TransportFactory implementation.\n\nThe new TransportFactory will be used on the host side first and then\nlater on the client side too when we ready to switch to Pepper UDP APIs.\n\nBUG=110485\n\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=122877","cc":["chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"reviewers":["wez@chromium.org","simonmorris@chromium.org"],"messages":[{"sender":"sergeyu@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"","disapproval":false,"date":"2012-02-08 00:52:55.532325","approval":false},{"sender":"sergeyu@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"+Simon","disapproval":false,"date":"2012-02-08 19:11:46.970750","approval":false},{"sender":"simonmorris@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"On 2012/02/08 19:11:46, sergeyu wrote:\n> +Simon\n\nI'd prefer to wait for Wez to review this CL.","disapproval":false,"date":"2012-02-08 21:26:43.220507","approval":false},{"sender":"sergeyu@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"wez: ping","disapproval":false,"date":"2012-02-16 21:41:27.533865","approval":false},{"sender":"wez@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"http://codereview.chromium.org/9365002/diff/2001/jingle/glue/channel_socket_adapter.h\nFile jingle/glue/channel_socket_adapter.h (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/jingle/glue/channel_socket_adapter.h#newcode32\njingle/glue/channel_socket_adapter.h:32: // Sets callback that should be called when the adapter is being destroyed.\nnit: Are there limitations on what the callback can touch/do?\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc\nFile remoting/protocol/libjingle_transport_factory.cc (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode80\nremoting/protocol/libjingle_transport_factory.cc:80: jingle_glue::PseudoTcpAdapter* socket_;\nI don't think we actually need this to be a member, do we?\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode83\nremoting/protocol/libjingle_transport_factory.cc:83: bool connected_;\nnit: connected_ -> is_connected_\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode95\nremoting/protocol/libjingle_transport_factory.cc:95: connected_(false) {\nInitialise |socket_| here, too.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode134\nremoting/protocol/libjingle_transport_factory.cc:134: // so we explicitly disables TCP connections.\nnit: disables -> disable\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode139\nremoting/protocol/libjingle_transport_factory.cc:139: network_manager_, socket_factory_, \"transp2\");\nWhere does \"transp2\" come from?\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode148\nremoting/protocol/libjingle_transport_factory.cc:148: \nnit: Remove either this blank line, or the one before \"if (config_.nat_travesal)\"...\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode151\nremoting/protocol/libjingle_transport_factory.cc:151: // Create P2PTransportChannel.\nnit: Create P2PTransportChannel and attached signal handlers.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode160\nremoting/protocol/libjingle_transport_factory.cc:160: channel_->Connect();\nnit: Prefix this with a comment like \"Connect P2PTransportChannel and adapt it to provide the net::Socket interface\"\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode167\nremoting/protocol/libjingle_transport_factory.cc:167: // Setup PseudoTCP adapter.\nnit: Configure and connect the PseudoTcp adapter.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode200\nremoting/protocol/libjingle_transport_factory.cc:200: channel_->OnSignalingReady();\nNo thread check?\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode238\nremoting/protocol/libjingle_transport_factory.cc:238: delete this;\nThe StreamTransport is returned to the caller via a scoped_ptr<>, so how is it ever appropriate for it to delete itself?\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode245\nremoting/protocol/libjingle_transport_factory.cc:245: callback_.Run(socket.Pass());\nnit: You could clear |callback_| here, and have is_connected() depend on whether |callback_.is_null()|, to avoid the extra state variable and ensure consistency.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.h\nFile remoting/protocol/libjingle_transport_factory.h (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.h#newcode18\nremoting/protocol/libjingle_transport_factory.h:18: class LibjingleTransportFactory : public TransportFactory {\nWhy are you calling this LibjingleTransportFactory rather than JingleTransportFactory?\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/pepper_session_unittest.cc\nFile remoting/protocol/pepper_session_unittest.cc (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/pepper_session_unittest.cc#newcode56\nremoting/protocol/pepper_session_unittest.cc:56: (*counter)--;\nnit: --(*counter) ?\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/pepper_session_unittest.cc#newcode237\nremoting/protocol/pepper_session_unittest.cc:237: .WillOnce(QuitThreadOnCounter(&counter));\nWon't this crash if the expectations end up being met after this function has returned, since they are attached to the mock, while |counter| will no longer be in scope?\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/pepper_session_unittest.cc#newcode324\nremoting/protocol/pepper_session_unittest.cc:324: // Verify that data can connect a TCP channel.\nnit: This comment makes no sense. :P\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/transport_config.h\nFile remoting/protocol/transport_config.h (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/transport_config.h#newcode23\nremoting/protocol/transport_config.h:23: // P2P sessions. Any port can be used when both values are set to 0.\nnit: Specifying the range as inclusive does mean that you can't set min_port=max_port to disable port allocation entirely.  Probably not an issue here, though.","disapproval":false,"date":"2012-02-17 20:58:01.613875","approval":false},{"sender":"sergeyu@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"http://codereview.chromium.org/9365002/diff/2001/jingle/glue/channel_socket_adapter.h\nFile jingle/glue/channel_socket_adapter.h (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/jingle/glue/channel_socket_adapter.h#newcode32\njingle/glue/channel_socket_adapter.h:32: // Sets callback that should be called when the adapter is being destroyed.\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: Are there limitations on what the callback can touch/do?\n\nNo except that it cannot access adapter object that's being destroyed, but I think it's obvious and not worth mentioning here.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc\nFile remoting/protocol/libjingle_transport_factory.cc (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode80\nremoting/protocol/libjingle_transport_factory.cc:80: jingle_glue::PseudoTcpAdapter* socket_;\nOn 2012/02/17 20:58:01, Wez wrote:\n> I don't think we actually need this to be a member, do we?\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode83\nremoting/protocol/libjingle_transport_factory.cc:83: bool connected_;\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: connected_ -> is_connected_\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode95\nremoting/protocol/libjingle_transport_factory.cc:95: connected_(false) {\nOn 2012/02/17 20:58:01, Wez wrote:\n> Initialise |socket_| here, too.\n\nNot necessary since i removed |socket_|\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode134\nremoting/protocol/libjingle_transport_factory.cc:134: // so we explicitly disables TCP connections.\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: disables -> disable\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode139\nremoting/protocol/libjingle_transport_factory.cc:139: network_manager_, socket_factory_, \"transp2\");\nOn 2012/02/17 20:58:01, Wez wrote:\n> Where does \"transp2\" come from?\n\nThis is the same value that JingleSessionManager uses, and it came there from libjingle examples. This is a user-agent string that is used when with HTTP proxies, but we currently don't connect over HTTP proxies, so this value does't matter at all. I've changed it to an empty string.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode148\nremoting/protocol/libjingle_transport_factory.cc:148: \nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: Remove either this blank line, or the one before \"if\n> (config_.nat_travesal)\"...\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode151\nremoting/protocol/libjingle_transport_factory.cc:151: // Create P2PTransportChannel.\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: Create P2PTransportChannel and attached signal handlers.\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode160\nremoting/protocol/libjingle_transport_factory.cc:160: channel_->Connect();\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: Prefix this with a comment like \"Connect P2PTransportChannel and adapt it\n> to provide the net::Socket interface\"\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode167\nremoting/protocol/libjingle_transport_factory.cc:167: // Setup PseudoTCP adapter.\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: Configure and connect the PseudoTcp adapter.\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode200\nremoting/protocol/libjingle_transport_factory.cc:200: channel_->OnSignalingReady();\nOn 2012/02/17 20:58:01, Wez wrote:\n> No thread check?\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode238\nremoting/protocol/libjingle_transport_factory.cc:238: delete this;\nOn 2012/02/17 20:58:01, Wez wrote:\n> The StreamTransport is returned to the caller via a scoped_ptr<>, so how is it\n> ever appropriate for it to delete itself?\nTransport creator (PepperSession) owns the transport initially but then drop ownership once the channel is connected. We could fix that by returning transport instance from Session::Create*Channel(). We considered that solution but then decided to add Session::RemoveChannel() instead. Perhaps we should reconsider it.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.cc#newcode245\nremoting/protocol/libjingle_transport_factory.cc:245: callback_.Run(socket.Pass());\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: You could clear |callback_| here, and have is_connected() depend on whether\n> |callback_.is_null()|, to avoid the extra state variable and ensure consistency.\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.h\nFile remoting/protocol/libjingle_transport_factory.h (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/libjingle_transport_factory.h#newcode18\nremoting/protocol/libjingle_transport_factory.h:18: class LibjingleTransportFactory : public TransportFactory {\nOn 2012/02/17 20:58:01, Wez wrote:\n> Why are you calling this LibjingleTransportFactory rather than\n> JingleTransportFactory?\n\nBecause JingleTransportFactory would be confusing. Jingle is a name of a protocol. Libjingle is a library that implements jingle protocol and bunch of other stuff (ICE/XMPP). This particular class is not related to Jingle protocol in any way, but uses P2P transport implementation provided by libjingle.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/pepper_session_unittest.cc\nFile remoting/protocol/pepper_session_unittest.cc (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/pepper_session_unittest.cc#newcode56\nremoting/protocol/pepper_session_unittest.cc:56: (*counter)--;\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: --(*counter) ?\n\nDone, but there is nothing in the style guide that requires this.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/pepper_session_unittest.cc#newcode237\nremoting/protocol/pepper_session_unittest.cc:237: .WillOnce(QuitThreadOnCounter(&counter));\nOn 2012/02/17 20:58:01, Wez wrote:\n> Won't this crash if the expectations end up being met after this function has\n> returned, since they are attached to the mock, while |counter| will no longer be\n> in scope?\n\nMessageLoop::Run() below will not return until both expectations are met.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/pepper_session_unittest.cc#newcode324\nremoting/protocol/pepper_session_unittest.cc:324: // Verify that data can connect a TCP channel.\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: This comment makes no sense. :P\n\nDone.\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/transport_config.h\nFile remoting/protocol/transport_config.h (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/remoting/protocol/transport_config.h#newcode23\nremoting/protocol/transport_config.h:23: // P2P sessions. Any port can be used when both values are set to 0.\nOn 2012/02/17 20:58:01, Wez wrote:\n> nit: Specifying the range as inclusive does mean that you can't set\n> min_port=max_port to disable port allocation entirely.  Probably not an issue\n> here, though.\n\nYou can always set min_port=1000, max_port=999.","disapproval":false,"date":"2012-02-17 23:02:33.536622","approval":false},{"sender":"wez@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"lgtm\n\nhttp://codereview.chromium.org/9365002/diff/2001/jingle/glue/channel_socket_adapter.h\nFile jingle/glue/channel_socket_adapter.h (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/jingle/glue/channel_socket_adapter.h#newcode32\njingle/glue/channel_socket_adapter.h:32: // Sets callback that should be called when the adapter is being destroyed.\nOn 2012/02/17 23:02:33, sergeyu wrote:\n> On 2012/02/17 20:58:01, Wez wrote:\n> > nit: Are there limitations on what the callback can touch/do?\n> \n> No except that it cannot access adapter object that's being destroyed, but I\n> think it's obvious and not worth mentioning here.\n\nThat may be obvious, but it's not obvious whether there are any other structures that should not be touched; clarifying that there are no other limits here helps avoid future changes to the API implementation breaking things.","disapproval":false,"date":"2012-02-19 22:26:51.478558","approval":true},{"sender":"sergeyu@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"http://codereview.chromium.org/9365002/diff/2001/jingle/glue/channel_socket_adapter.h\nFile jingle/glue/channel_socket_adapter.h (right):\n\nhttp://codereview.chromium.org/9365002/diff/2001/jingle/glue/channel_socket_adapter.h#newcode32\njingle/glue/channel_socket_adapter.h:32: // Sets callback that should be called when the adapter is being destroyed.\nOn 2012/02/19 22:26:51, Wez wrote:\n> On 2012/02/17 23:02:33, sergeyu wrote:\n> > On 2012/02/17 20:58:01, Wez wrote:\n> > > nit: Are there limitations on what the callback can touch/do?\n> > \n> > No except that it cannot access adapter object that's being destroyed, but I\n> > think it's obvious and not worth mentioning here.\n> \n> That may be obvious, but it's not obvious whether there are any other structures\n> that should not be touched; clarifying that there are no other limits here helps\n> avoid future changes to the API implementation breaking things.\n\nDone.","disapproval":false,"date":"2012-02-21 19:38:53.440304","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/sergeyu@chromium.org/9365002/6003","disapproval":false,"date":"2012-02-21 19:39:11.558170","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sergeyu@chromium.org","wez@chromium.org","simonmorris@chromium.org","chromium-reviews@chromium.org","jamiewalch+watch@chromium.org","dcaiafa+watch@chromium.org","simonmorris+watch@chromium.org","hclam+watch@chromium.org","wez+watch@chromium.org","amit@chromium.org","sanjeevr@chromium.org","garykac+watch@chromium.org","lambroslambrou+watch@chromium.org","alexeypa+watch@chromium.org","sergeyu+watch@chromium.org"],"text":"Change committed as 122877","disapproval":false,"date":"2012-02-21 21:20:04.905434","approval":false}],"owner_email":"sergeyu@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"Sergey Ulanov","subject":"Libjingle-based TransportFactory implementation.","created":"2012-02-08 00:49:41.624062","patchsets":[2001,9001,6002,6003],"modified":"2012-02-21 21:20:05.153166","closed":true,"commit":false,"issue":9365002}