{"description":"Persist the Instant API to committed search result pages.\n\nWhenever the active tab is an Instant search results page,\n|instant_tab_| is used to talk the Instant API with it.\n\nAlso:\n+ Replace uses of TabContents with WebContents as much as possible (in\n  service of @avi's goal, http://crbug.com/107201).\n+ Aggressively create the InstantLoader in many situations; update\n  browser tests accordingly.\n+ Don't send an initial resize on page load. This was only relevant for\n  the erstwhile hidden Instant modes.\n+ Delay delete the loader only when strictly necessary, such as when an\n  InstantLoader method is on the call stack. At other times, prefer the\n  much simpler loader_.reset().\n+ Don't bother resetting state. Resetting state has no practical\n  benefit, since we already only use state variables when they are\n  valid. Instead, this avoids tricky situations where we should NOT\n  reset state just because the |loader_| is deleted (since the\n  |instant_tab_| may still be in use).\n+ Given the above two, remove DeleteLoader() entirely.\n+ Separate out the magic in Hide() into three pieces: Hide(),\n  HideInternal() and a couple of places where we want to preserve\n  |last_full_text_|. I think this makes things slightly clearer.\n\nBUG=158942\nR=jered@chromium.org,samarth@chromium.org,sky@chromium.org\nTEST=Commit a query. Change mode to News. Type another query. You should\nsee results in News mode.\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=171018","cc":["chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"reviewers":["jered@chromium.org","samarth@chromium.org","sky@chromium.org"],"messages":[{"sender":"sreeram@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","jered@chromium.org","shishir@chromium.org"],"text":"This is a somewhat big change in functionality, so I'd like as many eyeballs as possible (i.e., everybody please review everything).\n\nThe basic idea is that if and only if |InstantController::client_| is non-NULL, we're talking to a committed page.\n\nKnown issues:\n+ The CL needs more comments and a more comprehensive description. Will add them soon.\n+ The search mode incorrectly changes when the active tab navigates, taking you out of suggestions mode. Will file a bug for this and track it. For now, if you are on a committed page, perform all actions quickly.\n+ Google.com has bugs to do with logo placement, not closing the on-page popup on submit, etc. Again, will file bugs internally tracking these soon.\n\nPlease review, while I get some sleep!","disapproval":false,"date":"2012-11-26 22:07:07.813520","approval":false},{"sender":"sky@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","jered@chromium.org","shishir@chromium.org"],"text":"https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.cc\nFile chrome/browser/instant/instant_client.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.cc#newcode56\nchrome/browser/instant/instant_client.cc:56: void InstantClient::NotifyInstantSupportDetermined(bool supports_instant) {\nI would name this SetInstantSupportDetermined.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode49\nchrome/browser/instant/instant_client.h:49: void DetermineIfPageSupportsInstant();\nSeem weird that this is public.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode57\nchrome/browser/instant/instant_client.h:57: content::WebContents* contents() const { return web_contents(); }\nnit: one of:\n\nconst content::WebContents* contents() const\ncontent::WebContents* contents()\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode64\nchrome/browser/instant/instant_client.h:64: // page supports the Instant API.\nYou should also add a comment that once invoked with true subsequent calls are ignored, and why that's ok.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode67\nchrome/browser/instant/instant_client.h:67: InstantController* const controller_;\nstyle guide says no protected members.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode366\nchrome/browser/instant/instant_controller.cc:366: \nShouldn't we early out if no client?\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h\nFile chrome/browser/instant/instant_controller.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode97\nchrome/browser/instant/instant_controller.h:97: // The user switched tabs. Hide the preview if needed.\nUpdate comment.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode203\nchrome/browser/instant/instant_controller.h:203: scoped_ptr<InstantClient> client_;\nSince InstantLoader is also an InstantClient using the name client_ here is mildly confusing.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_loader.cc\nFile chrome/browser/instant/instant_loader.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_loader.cc#newcode186\nchrome/browser/instant/instant_loader.cc:186: : InstantClient(controller, NULL),\nI get why you subclassed here, but it feels a bit iffy. It seems like InstantLoader and what is InstantClient want to have an InstantClient rather than be InstantClient.","disapproval":false,"date":"2012-11-27 01:07:51.443560","approval":false},{"sender":"samarth@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","jered@chromium.org","shishir@chromium.org"],"text":"[I need to make another pass over the code but here are some initial comments.]\n\nOverall, it's looking good. The main thing that I'm finding confusing and tricky in InstantController is the logic for what actions apply to CurrentClient() vs what apply to only client_ or only loader_.\n\nI have a couple of suggestions below about trying to make this clearer (1. being more explicit what are actions are no-ops in some of these cases, 2. perhaps moving some of this logic out of InstantController). Not sure if that'll help too much -- this seems inherently tricky until we switch to the model where instant is always committed.\n\nThanks,\nSamarth\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode27\nchrome/browser/instant/instant_client.h:27: InstantClient(InstantController* controller, content::WebContents* contents);\nComment either here for below (where the member is) that this doesn't take ownership of controller.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode251\nchrome/browser/instant/instant_controller.cc:251: Hide(true);  // #2\nMostly for my understanding: Hide() will be a no-op here if client_ is set, right? If so, it might be clearer to make that explicit by checking if (!client_) before calling it.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode386\nchrome/browser/instant/instant_controller.cc:386: if (InstantClient* client = CurrentClient())\nnit: does the Chrome style guide allow this? I haven't seen assignment in conditionals elsewhere.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode406\nchrome/browser/instant/instant_controller.cc:406: bool InstantController::IsCurrent() const {\nWhat should IsCurrent return if client_ is set? For instance, part of the check you have below for client_ in CommitIfCurrent could be moved here.\n\nThe only other place where IsCurrent is used is in OmniboxLostFocus. Is there any reason that isn't just a no-op (beyond updating if_focused) when client_ is set?\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode564\nchrome/browser/instant/instant_controller.cc:564: if (new_mode.is_search_suggestions()) {\nIs this code path relevant when client_ is set? In general, I think we should be more explicit here about only doing things that are necessary when using client_ or using loader_. Even if it's functionally equivalent, it makes it harder to read the code because you can't tell what matters and what doesn't.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h\nFile chrome/browser/instant/instant_controller.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode201\nchrome/browser/instant/instant_controller.h:201: InstantModel model_;\nWorth clarifying somewhere that model_ only reflects the model for loader_.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_loader.cc\nFile chrome/browser/instant/instant_loader.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_loader.cc#newcode186\nchrome/browser/instant/instant_loader.cc:186: : InstantClient(controller, NULL),\nOn 2012/11/27 01:07:51, sky wrote:\n> I get why you subclassed here, but it feels a bit iffy. It seems like\n> InstantLoader and what is InstantClient want to have an InstantClient rather\n> than be InstantClient.\n\nThis might be what sky is already saying, but what about having InstantClient (or some other name) be in charge of multiplexing between the active tab and the preview contents? That has two benefits:\n1) You don't need to split up the loader functionality into two places (which will make things harder to find and understand later)\n2) We can reduce the burden on InstantController which is already handling tons of state and tricky logic.","disapproval":false,"date":"2012-11-27 18:09:43.589880","approval":false},{"sender":"jered@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","jered@chromium.org","shishir@chromium.org"],"text":"I am still reading the meaty bits and will have more comments in a bit.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_browsertest.cc\nFile chrome/browser/instant/instant_browsertest.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_browsertest.cc#newcode403\nchrome/browser/instant/instant_browsertest.cc:403: // This makes Instant load the preview, along with an initial onresize() (see\nUpdate comment.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode81\nchrome/browser/instant/instant_client.h:81: // Message from the page determining whether it supports the Instant API.\ndetermining -> indicating\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/ui/omnibox/omnibox_edit_model.cc\nFile chrome/browser/ui/omnibox/omnibox_edit_model.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/ui/omnibox/omnibox_edit_model.cc#newcode1194\nchrome/browser/ui/omnibox/omnibox_edit_model.cc:1194: string16 full_text = view_->GetText();\nI am mildly terrified by GetText(). It's platform dependent and has a vague comment. Is it what we want here? (Do we not need DisplayTextFromUserText()?)\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/renderer/searchbox/searchbox.cc\nFile chrome/renderer/searchbox/searchbox.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/renderer/searchbox/searchbox.cc#newcode183\nchrome/renderer/searchbox/searchbox.cc:183: extensions_v8::SearchBoxExtension::DispatchUpOrDownKeyPress(\nWhy not DVLOG here? Too spammy?","disapproval":false,"date":"2012-11-27 18:19:53.286970","approval":false},{"sender":"sreeram@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","jered@chromium.org","shishir@chromium.org"],"text":"Responding to the bigger question of composition vs inheritance first. Will respond to other comments soon.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_loader.cc\nFile chrome/browser/instant/instant_loader.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_loader.cc#newcode186\nchrome/browser/instant/instant_loader.cc:186: : InstantClient(controller, NULL),\nI understand the style guide's preference for composition over inheritance. If we do that here, I think we'll have something like this (say the new stuff is called InstantTab; and the object that both InstantTab and InstantLoader hold is called InstantClient):\n\nvoid InstantController::SetSuggestions(InstantClient* client, ...) {\n  if (CurrentClient()->client() != client || ...)\n    return;\n\nI.e., when calling back from the loader to InstantController, we'll have to pass in something that's common to both InstantTab and InstantLoader, and then do this roundabout check to see which one actually called the InstantController. (\"roundabout\" because there's really no reason for InstantTab/InstantLoader to expose their client() to InstantController otherwise.)\n\nThe above is a somewhat small point, but overall I think inheritance makes the code leaner in this case. I think composition will just give us a whole bunch of shim methods for no good reason.\n\nTo samarth's point: I don't think we can do the multiplexing outside the InstantController easily. The logic is quite complex, and depends on InstantController state (such as search_mode_ and is_focused_ and such), so we'd have to expose all of that as well.","disapproval":false,"date":"2012-11-27 18:41:32.988690","approval":false},{"sender":"jered@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","jered@chromium.org","shishir@chromium.org"],"text":"I like the splitting out of the WebContentsObserver from InstantLoader, but am now very confused by the mixing of roles of loader_ and client_ in InstantController.\n\nPerhaps InstantLoader should create an InstantClient but not be one. InstantController::GetClient() would either get the one from the active tab (where it is put on commit), or get a new one from the loader.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode216\nchrome/browser/instant/instant_controller.cc:216: if (!ResetLoader(match.GetTemplateURL(profile, false), active_tab) &&\nWhy reset the loader here if client_ is set?\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode314\nchrome/browser/instant/instant_controller.cc:314: if (loader_ == CurrentClient() && first_interaction_time_.is_null())\nPlease extract a method like IsCommitted() for loader_ == CurrentClient() and client_ == CurrentClient().\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode414\nchrome/browser/instant/instant_controller.cc:414: if (client_ == CurrentClient() && last_match_was_search_ &&\nI am very confused. Why doesn't this cancel sometimes? What is the business about loader_ below?\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h\nFile chrome/browser/instant/instant_controller.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode118\nchrome/browser/instant/instant_controller.h:118: // Invoked by InstantLoader when it has suggested text.\nInstantLoader -> client\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode131\nchrome/browser/instant/instant_controller.h:131: // Invoked by InstantLoader when it has determined whether or not the page\nInstantLoader -> client\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode204\nchrome/browser/instant/instant_controller.h:204: scoped_ptr<InstantLoader> loader_;\nIt feels funny to me that InstantController owns client_. Instead, is there somehow it could be tethered to the active tab? Then if the active tab has a client, use it, otherwise use the loader. (The client flakes off from the loader on commit.)","disapproval":false,"date":"2012-11-27 19:21:57.310160","approval":false},{"sender":"jered@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"sreeram, samarth and I were chatting, and I thought we ought to continue here to loop +sky in. We were discussing the possibility of having the interface support a superset of functionality for committed and uncommitted tabs (and changing the name from client to say something about InstantTab, either InstantCommittedTab or InstantPreviewTab). We thought this might make some of the dispatch clearer in InstantController...\n\nOn 2012/11/27 19:21:57, Jered wrote:\n> I like the splitting out of the WebContentsObserver from InstantLoader, but am\n> now very confused by the mixing of roles of loader_ and client_ in\n> InstantController.\n> \n> Perhaps InstantLoader should create an InstantClient but not be one.\n> InstantController::GetClient() would either get the one from the active tab\n> (where it is put on commit), or get a new one from the loader.\n> \n> https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc\n> File chrome/browser/instant/instant_controller.cc (right):\n> \n> https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode216\n> chrome/browser/instant/instant_controller.cc:216: if\n> (!ResetLoader(match.GetTemplateURL(profile, false), active_tab) &&\n> Why reset the loader here if client_ is set?\n> \n> https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode314\n> chrome/browser/instant/instant_controller.cc:314: if (loader_ == CurrentClient()\n> && first_interaction_time_.is_null())\n> Please extract a method like IsCommitted() for loader_ == CurrentClient() and\n> client_ == CurrentClient().\n> \n> https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode414\n> chrome/browser/instant/instant_controller.cc:414: if (client_ == CurrentClient()\n> && last_match_was_search_ &&\n> I am very confused. Why doesn't this cancel sometimes? What is the business\n> about loader_ below?\n> \n> https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h\n> File chrome/browser/instant/instant_controller.h (right):\n> \n> https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode118\n> chrome/browser/instant/instant_controller.h:118: // Invoked by InstantLoader\n> when it has suggested text.\n> InstantLoader -> client\n> \n> https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode131\n> chrome/browser/instant/instant_controller.h:131: // Invoked by InstantLoader\n> when it has determined whether or not the page\n> InstantLoader -> client\n> \n> https://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode204\n> chrome/browser/instant/instant_controller.h:204: scoped_ptr<InstantLoader>\n> loader_;\n> It feels funny to me that InstantController owns client_. Instead, is there\n> somehow it could be tethered to the active tab? Then if the active tab has a\n> client, use it, otherwise use the loader. (The client flakes off from the loader\n> on commit.)","disapproval":false,"date":"2012-11-27 20:09:02.969520","approval":false},{"sender":"sky@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"I still vote for composition over inheritance. I think your concern can be alleviated by having the callbacks take an identifier so you know where its from.","disapproval":false,"date":"2012-11-27 21:46:30.632250","approval":false},{"sender":"samarth@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"Just to be clear, what we were discussing was something like a \"InstantAPI\" interface with pure virtual methods for all the things that current reside in InstantLoader/Client.  And then there would be two implementations of that interface--say InstantCommittedTab and InstantPreview.  The latter would implement the full interface while the former would have stubs for methods that don't apply to committed tabs.  Does that sound better to you?\n\nThanks,\nSamarth\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode348\nchrome/browser/instant/instant_controller.cc:348: if (omnibox_bounds_ == bounds)\nThis no longer works correctly.  Well, we don't care about these bounds for extended mode, but in general, we can no longer keep a copy of state here to compare against since we now care about what was the last value sent to CurrentClient().\n\nOne option is to stashed the cached values either in InstantLoader or in per-tab profile data.  For committed tabs, you can check for changes and dispatch the appropriate events when ResetClient is called.","disapproval":false,"date":"2012-11-28 06:31:15.518950","approval":false},{"sender":"sky@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"Ben was griping today about a review he was looking at (not this one) and happened to say, 'god calls a kitten every time you subclass a concrete type.' It made me think of this patch.","disapproval":false,"date":"2012-11-28 22:47:50.123820","approval":false},{"sender":"sreeram@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"Uploaded patchset #2, addressing the following comments. PTAL.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_browsertest.cc\nFile chrome/browser/instant/instant_browsertest.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_browsertest.cc#newcode403\nchrome/browser/instant/instant_browsertest.cc:403: // This makes Instant load the preview, along with an initial onresize() (see\nOn 2012/11/27 18:19:53, Jered wrote:\n> Update comment.\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.cc\nFile chrome/browser/instant/instant_client.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.cc#newcode56\nchrome/browser/instant/instant_client.cc:56: void InstantClient::NotifyInstantSupportDetermined(bool supports_instant) {\nOn 2012/11/27 01:07:51, sky wrote:\n> I would name this SetInstantSupportDetermined.\n\nDone. Now it's just \"InstantSupportDetermined\".\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode27\nchrome/browser/instant/instant_client.h:27: InstantClient(InstantController* controller, content::WebContents* contents);\nOn 2012/11/27 18:09:43, samarth wrote:\n> Comment either here for below (where the member is) that this doesn't take\n> ownership of controller.\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode49\nchrome/browser/instant/instant_client.h:49: void DetermineIfPageSupportsInstant();\nOn 2012/11/27 01:07:51, sky wrote:\n> Seem weird that this is public.\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode57\nchrome/browser/instant/instant_client.h:57: content::WebContents* contents() const { return web_contents(); }\nOn 2012/11/27 01:07:51, sky wrote:\n> nit: one of:\n> \n> const content::WebContents* contents() const\n> content::WebContents* contents()\n\nI don't understand this rule. Are you saying that we can't legitimately return any non-const pointer from a const method (even if the pointer is NOT to a data member)? That seems draconian to me. For example, would you similarly restrict InstantController::GetPreviewContents() from returning a non-const object?\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode64\nchrome/browser/instant/instant_client.h:64: // page supports the Instant API.\nOn 2012/11/27 01:07:51, sky wrote:\n> You should also add a comment that once invoked with true subsequent calls are\n> ignored, and why that's ok.\n\nI've moved this stuff into private sections now, and so the comments are in the .cc files.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode67\nchrome/browser/instant/instant_client.h:67: InstantController* const controller_;\nOn 2012/11/27 01:07:51, sky wrote:\n> style guide says no protected members.\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_client.h#newcode81\nchrome/browser/instant/instant_client.h:81: // Message from the page determining whether it supports the Instant API.\nOn 2012/11/27 18:19:53, Jered wrote:\n> determining -> indicating\n\nRemoved. No longer applicable.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode216\nchrome/browser/instant/instant_controller.cc:216: if (!ResetLoader(match.GetTemplateURL(profile, false), active_tab) &&\nOn 2012/11/27 19:21:57, Jered wrote:\n> Why reset the loader here if client_ is set?\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode251\nchrome/browser/instant/instant_controller.cc:251: Hide(true);  // #2\nOn 2012/11/27 18:09:43, samarth wrote:\n> Mostly for my understanding: Hide() will be a no-op here if client_ is set,\n> right? If so, it might be clearer to make that explicit by checking if\n> (!client_) before calling it.\n\nNo, Hide() won't be a no-op. For one, it will actually hide the preview (i.e., owned by |loader_|). It will also reset last_full_text_, which also isn't a no-op.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode314\nchrome/browser/instant/instant_controller.cc:314: if (loader_ == CurrentClient() && first_interaction_time_.is_null())\nOn 2012/11/27 19:21:57, Jered wrote:\n> Please extract a method like IsCommitted() for loader_ == CurrentClient() and\n> client_ == CurrentClient().\n\nI've gone with the simpler \"if (instant_tab_)\" idiom everywhere. I think this reads reasonably well (\"if [there's] an instant tab, ...\").\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode348\nchrome/browser/instant/instant_controller.cc:348: if (omnibox_bounds_ == bounds)\nOn 2012/11/28 06:31:15, samarth wrote:\n> This no longer works correctly.  Well, we don't care about these bounds for\n> extended mode, but in general, we can no longer keep a copy of state here to\n> compare against since we now care about what was the last value sent to\n> CurrentClient().\n> \n> One option is to stashed the cached values either in InstantLoader or in per-tab\n> profile data.  For committed tabs, you can check for changes and dispatch the\n> appropriate events when ResetClient is called. \n\nAs discussed offline, this does work correctly (because the bounds are always sent to |loader_|). Further CLs, such as @melevin's, that need to send to either |instant_tab_| or |loader_| should just send to both, and make sure that the state is sent again when they are recreated.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode366\nchrome/browser/instant/instant_controller.cc:366: \nOn 2012/11/27 01:07:51, sky wrote:\n> Shouldn't we early out if no client?\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode386\nchrome/browser/instant/instant_controller.cc:386: if (InstantClient* client = CurrentClient())\nOn 2012/11/27 18:09:43, samarth wrote:\n> nit: does the Chrome style guide allow this? I haven't seen assignment in\n> conditionals elsewhere.\n\nThe style guide doesn't mention it. @sky hates it. I like this style, but am cognizant that I might be overdoing it. I think it helps in some cases; for example, see InstantLoader::SetupPreviewContents().\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode406\nchrome/browser/instant/instant_controller.cc:406: bool InstantController::IsCurrent() const {\nOn 2012/11/27 18:09:43, samarth wrote:\n> What should IsCurrent return if client_ is set? For instance, part of the check\n> you have below for client_ in CommitIfCurrent could be moved here.\n\nIf |instant_tab_| is non-NULL, IsCurrent() should be false, since the preview should have been hidden by then. I don't see a need to check instant_tab_ here explicitly.\n\n> The only other place where IsCurrent is used is in OmniboxLostFocus. Is there\n> any reason that isn't just a no-op (beyond updating if_focused) when client_ is\n> set?\n\nNot sure what you mean, but OmniboxLostFocus() could lead to the |loader_| getting refreshed if IsCurrent() is false (among other things).\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode414\nchrome/browser/instant/instant_controller.cc:414: if (client_ == CurrentClient() && last_match_was_search_ &&\nOn 2012/11/27 19:21:57, Jered wrote:\n> I am very confused. Why doesn't this cancel sometimes? What is the business\n> about loader_ below?\n\nCancel() isn't applicable in the case of a committed tab. I've added a short comment about why this block exists here; let me know if it is still unclear.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.cc#newcode564\nchrome/browser/instant/instant_controller.cc:564: if (new_mode.is_search_suggestions()) {\nOn 2012/11/27 18:09:43, samarth wrote:\n> Is this code path relevant when client_ is set? In general, I think we should be\n> more explicit here about only doing things that are necessary when using client_\n> or using loader_. Even if it's functionally equivalent, it makes it harder to\n> read the code because you can't tell what matters and what doesn't.\n\nI think there's a balance to be struck here. I don't want to see \"if (instant_tab_) return;\" all over the place. I think you feel this way because instant_tab_ is a new piece being introduced. Once it has been around a while, I think we'll get used to the idea.\n\nFor example, why do we not have \"if (!loader_) return;\" or \"if (model_.mode().is_default()) return;\" all over the place too? In many places, we go ahead with the logic, end up calling Hide(), knowing that it might be redundant - the preview may already be hidden, or worse still, we may not even have a loader.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h\nFile chrome/browser/instant/instant_controller.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode97\nchrome/browser/instant/instant_controller.h:97: // The user switched tabs. Hide the preview if needed.\nOn 2012/11/27 01:07:51, sky wrote:\n> Update comment.\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode118\nchrome/browser/instant/instant_controller.h:118: // Invoked by InstantLoader when it has suggested text.\nOn 2012/11/27 19:21:57, Jered wrote:\n> InstantLoader -> client\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode131\nchrome/browser/instant/instant_controller.h:131: // Invoked by InstantLoader when it has determined whether or not the page\nOn 2012/11/27 19:21:57, Jered wrote:\n> InstantLoader -> client\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode201\nchrome/browser/instant/instant_controller.h:201: InstantModel model_;\nOn 2012/11/27 18:09:43, samarth wrote:\n> Worth clarifying somewhere that model_ only reflects the model for loader_.\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode203\nchrome/browser/instant/instant_controller.h:203: scoped_ptr<InstantClient> client_;\nOn 2012/11/27 01:07:51, sky wrote:\n> Since InstantLoader is also an InstantClient using the name client_ here is\n> mildly confusing.\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_controller.h#newcode204\nchrome/browser/instant/instant_controller.h:204: scoped_ptr<InstantLoader> loader_;\nOn 2012/11/27 19:21:57, Jered wrote:\n> It feels funny to me that InstantController owns client_. Instead, is there\n> somehow it could be tethered to the active tab? Then if the active tab has a\n> client, use it, otherwise use the loader. (The client flakes off from the loader\n> on commit.)\n\nAck. As per previous comments, I've kept the ownership the same.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_loader.cc\nFile chrome/browser/instant/instant_loader.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/instant/instant_loader.cc#newcode186\nchrome/browser/instant/instant_loader.cc:186: : InstantClient(controller, NULL),\nDone. Composition wins.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/ui/omnibox/omnibox_edit_model.cc\nFile chrome/browser/ui/omnibox/omnibox_edit_model.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/browser/ui/omnibox/omnibox_edit_model.cc#newcode1194\nchrome/browser/ui/omnibox/omnibox_edit_model.cc:1194: string16 full_text = view_->GetText();\nOn 2012/11/27 18:19:53, Jered wrote:\n> I am mildly terrified by GetText(). It's platform dependent and has a vague\n> comment. Is it what we want here? (Do we not need DisplayTextFromUserText()?)\n\nYeah. user_text_ (and things derived from it, such as DisplayTextFromUserText()) will return a blank string if the user is not typing. As you can see from the table in InstantController::Update(), there are situations where user_input_in_progress is false, yet we need to know what the omnibox is showing.\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/renderer/searchbox/searchbox.cc\nFile chrome/renderer/searchbox/searchbox.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/1/chrome/renderer/searchbox/searchbox.cc#newcode183\nchrome/renderer/searchbox/searchbox.cc:183: extensions_v8::SearchBoxExtension::DispatchUpOrDownKeyPress(\nOn 2012/11/27 18:19:53, Jered wrote:\n> Why not DVLOG here? Too spammy?\n\nDone. I had simply not cared enough about this particular event to add a DVLOG for it.","disapproval":false,"date":"2012-11-29 07:33:19.385370","approval":false},{"sender":"jered@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"Man that's quite a change. Looks pretty good overall, I think I follow what's going on in InstantController better.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode221\nchrome/browser/instant/instant_controller.cc:221: ((match_is_search && !user_text.empty()) || !CreateDefaultLoader())) {\nShould this check full_text.empty() as it used to?\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode221\nchrome/browser/instant/instant_controller.cc:221: ((match_is_search && !user_text.empty()) || !CreateDefaultLoader())) {\nIt took me a second to unwind this if. Maybe\nbool PrepareToUpdate(...) {\n  if (instant_tab_)\n    return true;\n  if (!ResetLoader(template_url, active_tab))\n    return false;\n  if (!match_is_search || full_text.empty())\n    return !CreateDefaultLoader();\n  return true;\n}\n\nthen if (!PrepareToUpdate(...)) ...\n\nor fold in the other branch below\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode232\nchrome/browser/instant/instant_controller.cc:232: // Legend: OPIO == |omnibox_popup_is_open|, UIIP = |user_input_in_progress|.\nI'd love to extract everything from this table down to the bottom of the next if into a separate method, too, if that were somehow possible.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode262\nchrome/browser/instant/instant_controller.cc:262: // original results by resending the query. If the user was not on a\nWhat \"original\" results? Do you mean the committed results? I don't understand why full_text is the correct query.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode270\nchrome/browser/instant/instant_controller.cc:270: return false;  // #1\nNote this is both #1 and #2.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode417\nchrome/browser/instant/instant_controller.cc:417: return false;\nShould this be return true;?\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode433\nchrome/browser/instant/instant_controller.cc:433: // page, but otherwise, nothing else to do.\nFrom the \"nothing else to do\" part, I would expect:\nif (instant_tab_) {\n  if (last_match_was_search_ && type == INSTANT_COMMIT_PRESSED_ENTER) {\n    instant_tab->Submit(last_full_text_);\n    return true;\n  }\n  return false;\n}\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode734\nchrome/browser/instant/instant_controller.cc:734: if (!supports_instant)\nWow, I hope not. Do we not want to update the blacklist in this case?\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode747\nchrome/browser/instant/instant_controller.cc:747: CreateDefaultLoader();\nIs this CreateDefaultLoader() call new? I think this is safe because of blacklisted_urls_, but initially I was worried this might result in an infinite loop of creating and deleting the default loader... that can't happen, right?\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode834\nchrome/browser/instant/instant_controller.cc:834: // latter, but preserve |last_full_text_|.\nThis happens in 3 places. Perhaps extract a method.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode965\nchrome/browser/instant/instant_controller.cc:965: std::string new_scheme = \"https\";\nThere is probably a constant for this somewhere.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode966\nchrome/browser/instant/instant_controller.cc:966: std::string new_port = \"443\";\nThis too I'd expect.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_tab.cc\nFile chrome/browser/instant/instant_tab.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_tab.cc#newcode16\nchrome/browser/instant/instant_tab.cc:16: client_.DetermineIfPageSupportsInstant();\nI am uneasy about Observe() and sending an IPC in the constructor. Can a separate Init() method do this work?","disapproval":false,"date":"2012-11-29 19:57:04.898190","approval":false},{"sender":"samarth@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"LGTM\n\nThanks for the refactoring--this is much easier to follow now!\n\nA few minor comments below but I didn't see any big issues besides those that Jered already brought up.\n\nThanks,\nSamarth\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h#newcode71\nchrome/browser/instant/instant_client.h:71: // Tells the page that the user clicked on it.\nA little more explanation please. Otherwise the comment is confusing (why does clicking on the page cause Cancel()?)\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode93\nchrome/browser/instant/instant_controller.cc:93: string16 norm_prefix = Normalize(prefix);\nFWIW, I find this kind of const usage useful (as opposed to say, const bool function parameters) but your call.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode660\nchrome/browser/instant/instant_controller.cc:660: (!instant_tab_ && loader_ && loader_->contents() != contents))\nYikes! The last two clauses appear all over the place--worth making utilities for them for clarity? For example, IsLoaderActive() and IsTabActive()? (There's probably better names you could use here.)","disapproval":false,"date":"2012-12-03 19:46:03.369960","approval":true},{"sender":"sky@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"Thanks for separating things out. I only have high level comments.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h#newcode36\nchrome/browser/instant/instant_client.h:36: class Delegate {\nThe style guide says classes like this should be in their owner header: \"Prefer putting delegate classes in their own header files. Implementors of the delegate interface will often be included elsewhere, which will often cause more coupling with the header of the main class.\"\n\nAlso, add a virtual destructor in the protected section.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h#newcode56\nchrome/browser/instant/instant_client.h:56: virtual ~InstantClient();\nDoes this need to be virtual?","disapproval":false,"date":"2012-12-03 22:22:22.721660","approval":false},{"sender":"sreeram@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"Uploaded patchset #3, addressing the following comments and fixing a bunch of other issues. PTAL.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h\nFile chrome/browser/instant/instant_client.h (right):\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h#newcode36\nchrome/browser/instant/instant_client.h:36: class Delegate {\nOn 2012/12/03 22:22:23, sky wrote:\n> The style guide says classes like this should be in their owner header: \"Prefer\n> putting delegate classes in their own header files. Implementors of the delegate\n> interface will often be included elsewhere, which will often cause more coupling\n> with the header of the main class.\"\n\nRight. However, all the implementors of this interface include instant_client.h anyway (because they each have an \"InstantClient client_;\" object member). So I didn't see the value in separating this out. Let me know if you still feel strongly.\n\n> Also, add a virtual destructor in the protected section.\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h#newcode56\nchrome/browser/instant/instant_client.h:56: virtual ~InstantClient();\nOn 2012/12/03 22:22:23, sky wrote:\n> Does this need to be virtual?\n\nNo. But without it, the clang style plugin or some such gives an error saying that \"all classes that override a virtual method must have a virtual destructor\" (and this class does have a couple of OVERRIDE declarations).\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_client.h#newcode71\nchrome/browser/instant/instant_client.h:71: // Tells the page that the user clicked on it.\nOn 2012/12/03 19:46:03, samarth wrote:\n> A little more explanation please. Otherwise the comment is confusing (why does\n> clicking on the page cause Cancel()?)\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode93\nchrome/browser/instant/instant_controller.cc:93: string16 norm_prefix = Normalize(prefix);\nOn 2012/12/03 19:46:03, samarth wrote:\n> FWIW, I find this kind of const usage useful (as opposed to say, const bool\n> function parameters) but your call.\n\nAck. I do vacillate between too much and too little const, but for now, I'll keep my change.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode221\nchrome/browser/instant/instant_controller.cc:221: ((match_is_search && !user_text.empty()) || !CreateDefaultLoader())) {\nOn 2012/11/29 19:57:05, Jered wrote:\n> Should this check full_text.empty() as it used to?\n\nNo, user_text is the right thing here. If we are in case #2, full_text won't be empty, but user_text will be, and match_is_search will be true. We don't want to create a loader in that case.\n\nPreviously, full_text worked because case #2 never triggered (i.e., recall the changes in this CL to use view_->GetText() instead of user_text + inline_autocomplete_text_ in omnibox_edit_model.cc).\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode221\nchrome/browser/instant/instant_controller.cc:221: ((match_is_search && !user_text.empty()) || !CreateDefaultLoader())) {\nOn 2012/11/29 19:57:05, Jered wrote:\n> It took me a second to unwind this if. Maybe\n> bool PrepareToUpdate(...) {\n>   if (instant_tab_)\n>     return true;\n>   if (!ResetLoader(template_url, active_tab))\n>     return false;\n>   if (!match_is_search || full_text.empty())\n>     return !CreateDefaultLoader();\n>   return true;\n> }\n> \n> then if (!PrepareToUpdate(...)) ...\n> \n> or fold in the other branch below\n\nDone.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode232\nchrome/browser/instant/instant_controller.cc:232: // Legend: OPIO == |omnibox_popup_is_open|, UIIP = |user_input_in_progress|.\nOn 2012/11/29 19:57:05, Jered wrote:\n> I'd love to extract everything from this table down to the bottom of the next if\n> into a separate method, too, if that were somehow possible.\n\nI've removed the table and made the section much better, I think. PTAL at the new patch.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode262\nchrome/browser/instant/instant_controller.cc:262: // original results by resending the query. If the user was not on a\nOn 2012/11/29 19:57:05, Jered wrote:\n> What \"original\" results? Do you mean the committed results? I don't understand\n> why full_text is the correct query.\n\nI've tried to explain this better in the new patch. PTAL.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode270\nchrome/browser/instant/instant_controller.cc:270: return false;  // #1\nOn 2012/11/29 19:57:05, Jered wrote:\n> Note this is both #1 and #2.\n\nAck. See new patch.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode417\nchrome/browser/instant/instant_controller.cc:417: return false;\nOn 2012/11/29 19:57:05, Jered wrote:\n> Should this be return true;?\n\nIndeed. Done. ('Twas a typo.)\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode433\nchrome/browser/instant/instant_controller.cc:433: // page, but otherwise, nothing else to do.\nOn 2012/11/29 19:57:05, Jered wrote:\n> From the \"nothing else to do\" part, I would expect:\n> if (instant_tab_) {\n>   if (last_match_was_search_ && type == INSTANT_COMMIT_PRESSED_ENTER) {\n>     instant_tab->Submit(last_full_text_);\n>     return true;\n>   }\n>   return false;\n> }\n\nDone. It worked the way it was before, since IsCurrent() would return false, but I've made it more explicit, the way you suggested.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode660\nchrome/browser/instant/instant_controller.cc:660: (!instant_tab_ && loader_ && loader_->contents() != contents))\nOn 2012/12/03 19:46:03, samarth wrote:\n> Yikes! The last two clauses appear all over the place--worth making utilities\n> for them for clarity? For example, IsLoaderActive() and IsTabActive()? (There's\n> probably better names you could use here.)\n\nActually, it's just in two places - the only two callbacks that are applicable to both InstantTab and InstantLoader, viz., SetSuggestions() and InstantSupportDetermined(). Until this proliferates, I think it's simpler to just keep them as they are.\n\nThe other similar checks, such as the ones in Update(), are conceptually different. They are not checking whether instant_tab_ or loader_ match the caller's contents; rather that the instant_tab_ contents match the active tab contents. I think it might lead to more confusion if we tried to share code across them.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode734\nchrome/browser/instant/instant_controller.cc:734: if (!supports_instant)\nOn 2012/11/29 19:57:05, Jered wrote:\n> Wow, I hope not. Do we not want to update the blacklist in this case?\n\nNo. The blacklist is to make sure that we are not causing unnecessary and repeated page loads. In the case of a committed tab, we are not actually causing any loads. We are just using what's already there. No resources wasted, so no need to blacklist.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode747\nchrome/browser/instant/instant_controller.cc:747: CreateDefaultLoader();\nOn 2012/11/29 19:57:05, Jered wrote:\n> Is this CreateDefaultLoader() call new? I think this is safe because of\n> blacklisted_urls_, but initially I was worried this might result in an infinite\n> loop of creating and deleting the default loader... that can't happen, right?\n\nYeah, the call is new. The infinite loop can't happen because of kMaxInstantSupportFailures, but this code will eventually be overhauled when http://crbug.com/143722 is fixed. So, I'll keep this change for now.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode834\nchrome/browser/instant/instant_controller.cc:834: // latter, but preserve |last_full_text_|.\nOn 2012/11/29 19:57:05, Jered wrote:\n> This happens in 3 places. Perhaps extract a method.\n\nAck. No longer repeated in the new patch.\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode965\nchrome/browser/instant/instant_controller.cc:965: std::string new_scheme = \"https\";\nOn 2012/11/29 19:57:05, Jered wrote:\n> There is probably a constant for this somewhere.\n\nI'd think so too, but I couldn't find one!\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_controller.cc#newcode966\nchrome/browser/instant/instant_controller.cc:966: std::string new_port = \"443\";\nOn 2012/11/29 19:57:05, Jered wrote:\n> This too I'd expect.\n\nLikewise. (Note that this is worse, since it needs to be a string; 443 as an int doesn't cut it.)\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_tab.cc\nFile chrome/browser/instant/instant_tab.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/12001/chrome/browser/instant/instant_tab.cc#newcode16\nchrome/browser/instant/instant_tab.cc:16: client_.DetermineIfPageSupportsInstant();\nOn 2012/11/29 19:57:05, Jered wrote:\n> I am uneasy about Observe() and sending an IPC in the constructor. Can a\n> separate Init() method do this work?\n\nDone.","disapproval":false,"date":"2012-12-04 08:10:51.489220","approval":false},{"sender":"sky@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"LGTM","disapproval":false,"date":"2012-12-04 16:57:08.477640","approval":true},{"sender":"commit-bot@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","sreeram@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/sreeram@chromium.org/11421079/5004","disapproval":false,"date":"2012-12-04 17:08:29.027400","approval":false},{"sender":"sreeram@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"On 2012/12/04 16:57:08, sky wrote:\n> LGTM\n\nThanks! I appreciate your super-responsive review, despite the fact that this CL mixed a bunch of changes together. I don't like bunching things (or big CLs in general), but am going OOO for a month starting Thursday, so thanks for helping get this out!","disapproval":false,"date":"2012-12-04 17:12:48.084420","approval":false},{"sender":"jered@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"lgtm\n\nI am convinced that whatever problems remain are better addressed in new changes. Thanks for all the awesome cleanup.\n\nhttps://codereview.chromium.org/11421079/diff/5004/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/5004/chrome/browser/instant/instant_controller.cc#newcode895\nchrome/browser/instant/instant_controller.cc:895: !allow_preview_to_show_search_suggestions_)\nWhen is allow_preview_to_show_search_suggestions != search_mode_.is_search_suggestions() ?","disapproval":false,"date":"2012-12-04 19:05:03.664500","approval":true},{"sender":"sreeram@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"https://codereview.chromium.org/11421079/diff/5004/chrome/browser/instant/instant_controller.cc\nFile chrome/browser/instant/instant_controller.cc (right):\n\nhttps://codereview.chromium.org/11421079/diff/5004/chrome/browser/instant/instant_controller.cc#newcode895\nchrome/browser/instant/instant_controller.cc:895: !allow_preview_to_show_search_suggestions_)\nOn 2012/12/04 19:05:03, Jered wrote:\n> When is allow_preview_to_show_search_suggestions !=\n> search_mode_.is_search_suggestions() ?\n\nWhenever we call HideLoader() when the search_mode_ is still search suggestions. This happens in the following cases:\n+ When you backspace everything on a non-NTP page (line 243)\n+ When you switch to a tab with a partial query already in the omnibox (line 247)\n+ When you type a solitary \"?\" on a non-NTP page (line 268)\n+ When the omnibox loses focus (line 557)\n+ When you are typing on a committed tab (line 819)","disapproval":false,"date":"2012-12-04 19:12:37.377710","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","gideonwald@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"Change committed as 171018","disapproval":false,"date":"2012-12-04 19:15:02.401710","approval":false},{"sender":"gideonwald@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"On 2012/12/04 19:15:02, I haz the power (commit-bot) wrote:\n> Change committed as 171018\n\n+1 - huge thanks, sky.","disapproval":false,"date":"2012-12-04 19:24:21.357660","approval":false},{"sender":"avi@chromium.org","recipients":["sreeram@chromium.org","jered@chromium.org","samarth@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","melevin@chromium.org","samarth@chromium.org","dominich@chromium.org","aa@chromium.org","dcblack@chromium.org","chromium-apps-reviews@chromium.org","darin-cc@chromium.org","shishir@chromium.org"],"text":"Thanks for the TabContent killing.","disapproval":false,"date":"2012-12-04 19:41:31.484560","approval":false}],"owner_email":"sreeram@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"sreeram","subject":"Persist the Instant API to committed search result pages.","created":"2012-11-26 22:00:38.293200","patchsets":[1,12001,5004],"modified":"2012-12-04 19:41:31.624870","closed":true,"commit":false,"issue":11421079}