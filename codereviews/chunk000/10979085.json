{"description":"Don't call app.window.create callback until after DidCreateDocumentElement.\n\nThis means that in the callback of chrome.app.window.create, the contentWindow.document element will be the final target document, not the initial 'about:blank' document. The callback will still be guaranteed to be called before the child window's onload event happens, and before any scripts run in the child.\n\n\nR=mihaip@chromium.org,darin@chromium.org\nBUG=148857,130465\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=163518","cc":["chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org","ager@chromium.org"],"reviewers":["mihaip@chromium.org","darin@chromium.org","ager@google.com"],"messages":[{"sender":"jeremya@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","koz@chromium.org","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org"],"text":"mihaip- general extensionsy review\nkoz- v8 shenanigans\ndarin- will this break everything? :)","disapproval":false,"date":"2012-09-28 21:29:49.630040","approval":false},{"sender":"mihaip@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","koz@chromium.org","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org"],"text":"Can this be tested? Is there any property of the window object in the callback that you can examine to prove that it's committed the load (document.readyState?)\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/extensions/app_window_custom_bindings.cc\nFile chrome/renderer/extensions/app_window_custom_bindings.cc (right):\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/extensions/app_window_custom_bindings.cc#newcode91\nchrome/renderer/extensions/app_window_custom_bindings.cc:91: virtual void DidCommitProvisionalLoad(WebKit::WebFrame* frame,\nWhat will happen when calling chrome.app.window.create('bogusURL.html')? If the provisional load will fail, then you'll never invoke the callback. Would it make sense to also listen for DidFailProvisionalLoad, and invoke the callback with NULL?\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/extensions/app_window_custom_bindings.cc#newcode91\nchrome/renderer/extensions/app_window_custom_bindings.cc:91: virtual void DidCommitProvisionalLoad(WebKit::WebFrame* frame,\nNit: add newlines between methods definitions.\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/extensions/app_window_custom_bindings.cc#newcode99\nchrome/renderer/extensions/app_window_custom_bindings.cc:99: // XXX do i need to do anything with the try_catch? do i even need it?\nhttps://developers.google.com/v8/embed#exceptions makes it sound like they're not needed.\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/resources/extensions/app_window_custom_bindings.js\nFile chrome/renderer/resources/extensions/app_window_custom_bindings.js (right):\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/resources/extensions/app_window_custom_bindings.js#newcode25\nchrome/renderer/resources/extensions/app_window_custom_bindings.js:25: return callback(undefined);\nNit: since this function doesn't actually have a return value, it's easier to read the intent of this if it were two separate lines:\ncallback(undefined);\nreturn;","disapproval":false,"date":"2012-09-28 21:55:34.630810","approval":false},{"sender":"jeremya@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","koz@chromium.org","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org"],"text":"https://codereview.chromium.org/10979085/diff/1/chrome/renderer/extensions/app_window_custom_bindings.cc\nFile chrome/renderer/extensions/app_window_custom_bindings.cc (right):\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/extensions/app_window_custom_bindings.cc#newcode91\nchrome/renderer/extensions/app_window_custom_bindings.cc:91: virtual void DidCommitProvisionalLoad(WebKit::WebFrame* frame,\nOn 2012/09/28 21:55:34, Mihai Parparita wrote:\n> Nit: add newlines between methods definitions.\n\nDone.\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/extensions/app_window_custom_bindings.cc#newcode91\nchrome/renderer/extensions/app_window_custom_bindings.cc:91: virtual void DidCommitProvisionalLoad(WebKit::WebFrame* frame,\nOn 2012/09/28 21:55:34, Mihai Parparita wrote:\n> What will happen when calling chrome.app.window.create('bogusURL.html')? If the\n> provisional load will fail, then you'll never invoke the callback. Would it make\n> sense to also listen for DidFailProvisionalLoad, and invoke the callback with\n> NULL?\n\nYep. Done.\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/extensions/app_window_custom_bindings.cc#newcode99\nchrome/renderer/extensions/app_window_custom_bindings.cc:99: // XXX do i need to do anything with the try_catch? do i even need it?\nOn 2012/09/28 21:55:34, Mihai Parparita wrote:\n> https://developers.google.com/v8/embed#exceptions makes it sound like they're\n> not needed.\n\nYeah, since we don't do anything with the result, it seems like it should be fine. Removed.\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/resources/extensions/app_window_custom_bindings.js\nFile chrome/renderer/resources/extensions/app_window_custom_bindings.js (right):\n\nhttps://codereview.chromium.org/10979085/diff/1/chrome/renderer/resources/extensions/app_window_custom_bindings.js#newcode25\nchrome/renderer/resources/extensions/app_window_custom_bindings.js:25: return callback(undefined);\nOn 2012/09/28 21:55:34, Mihai Parparita wrote:\n> Nit: since this function doesn't actually have a return value, it's easier to\n> read the intent of this if it were two separate lines:\n> callback(undefined);\n> return;\n\nDone.","disapproval":false,"date":"2012-10-08 20:52:35.047450","approval":false},{"sender":"jeremya@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","koz@chromium.org","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org"],"text":"PS, with the most recent patch I switched from listening to DidCommitProvisionalLoad to listening to DidCreateDocumentElement, because DCPL was not meant for JS to be called from (specifically, calling window.close() from DCPL hits an ASSERT in WebKit). Plus this way, the callback will be called after the titlebar has been injected.","disapproval":false,"date":"2012-10-08 20:54:02.285660","approval":false},{"sender":"mihaip@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","koz@chromium.org","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org"],"text":"LGTM\n\nhttps://codereview.chromium.org/10979085/diff/5001/chrome/renderer/resources/extensions/app_window_custom_bindings.js\nFile chrome/renderer/resources/extensions/app_window_custom_bindings.js (right):\n\nhttps://codereview.chromium.org/10979085/diff/5001/chrome/renderer/resources/extensions/app_window_custom_bindings.js#newcode47\nchrome/renderer/resources/extensions/app_window_custom_bindings.js:47: })\nNit: missing semi-colon.","disapproval":false,"date":"2012-10-08 23:15:57.901150","approval":true},{"sender":"jeremya@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","koz@chromium.org","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org"],"text":"https://codereview.chromium.org/10979085/diff/5001/chrome/renderer/resources/extensions/app_window_custom_bindings.js\nFile chrome/renderer/resources/extensions/app_window_custom_bindings.js (right):\n\nhttps://codereview.chromium.org/10979085/diff/5001/chrome/renderer/resources/extensions/app_window_custom_bindings.js#newcode47\nchrome/renderer/resources/extensions/app_window_custom_bindings.js:47: })\nOn 2012/10/08 23:15:58, Mihai Parparita wrote:\n> Nit: missing semi-colon.\n\nDone.","disapproval":false,"date":"2012-10-19 01:00:48.293760","approval":false},{"sender":"jeremya@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org","ager@chromium.org"],"text":"+ager for v8 api hackery","disapproval":false,"date":"2012-10-19 04:07:39.508940","approval":false},{"sender":"ager@google.com","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","ager@google.com","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org","ager@chromium.org"],"text":"V8 bindings LGTM\n\nhttp://codereview.chromium.org/10979085/diff/12001/chrome/test/data/extensions/platform_apps/windows_api/test.js\nFile chrome/test/data/extensions/platform_apps/windows_api/test.js (right):\n\nhttp://codereview.chromium.org/10979085/diff/12001/chrome/test/data/extensions/platform_apps/windows_api/test.js#newcode36\nchrome/test/data/extensions/platform_apps/windows_api/test.js:36: })\nAdd explicit semicolon?","disapproval":false,"date":"2012-10-19 05:39:04.961140","approval":true},{"sender":"jeremya@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","ager@google.com","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org","ager@chromium.org"],"text":"http://codereview.chromium.org/10979085/diff/12001/chrome/test/data/extensions/platform_apps/windows_api/test.js\nFile chrome/test/data/extensions/platform_apps/windows_api/test.js (right):\n\nhttp://codereview.chromium.org/10979085/diff/12001/chrome/test/data/extensions/platform_apps/windows_api/test.js#newcode36\nchrome/test/data/extensions/platform_apps/windows_api/test.js:36: })\nOn 2012/10/19 05:39:05, Mads Ager wrote:\n> Add explicit semicolon?\n\nDone.","disapproval":false,"date":"2012-10-22 00:31:05.505950","approval":false},{"sender":"commit-bot@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","ager@google.com","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org","ager@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/jeremya@chromium.org/10979085/18001","disapproval":false,"date":"2012-10-22 00:32:57.801890","approval":false},{"sender":"commit-bot@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","ager@google.com","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org","ager@chromium.org"],"text":"Failed to apply patch for chrome/renderer/resources/extensions/app_window_custom_bindings.js:\nWhile running patch -p1 --forward --force --no-backup-if-mismatch;\n  patching file chrome/renderer/resources/extensions/app_window_custom_bindings.js\n  Hunk #3 FAILED at 66.\n  1 out of 3 hunks FAILED -- saving rejects to file chrome/renderer/resources/extensions/app_window_custom_bindings.js.rej\n\nPatch:       chrome/renderer/resources/extensions/app_window_custom_bindings.js\nIndex: chrome/renderer/resources/extensions/app_window_custom_bindings.js\ndiff --git a/chrome/renderer/resources/extensions/app_window_custom_bindings.js b/chrome/renderer/resources/extensions/app_window_custom_bindings.js\nindex a75f6e6f25f5a96504b241a767628f0abb19956b..2b20ac959cf8b2252d1c3afaf24cf99508737177 100644\n--- a/chrome/renderer/resources/extensions/app_window_custom_bindings.js\n+++ b/chrome/renderer/resources/extensions/app_window_custom_bindings.js\n@@ -9,6 +9,7 @@ var sendRequest = require('sendRequest').sendRequest;\n var appWindowNatives = requireNative('app_window');\n var forEach = require('utils').forEach;\n var GetView = appWindowNatives.GetView;\n+var OnContextReady = appWindowNatives.OnContextReady;\n \n chromeHidden.registerCustomHook('app.window', function(bindingsAPI) {\n   var apiFunctions = bindingsAPI.apiFunctions;\n@@ -31,9 +32,24 @@ chromeHidden.registerCustomHook('app.window', function(bindingsAPI) {\n     // Initialize appWindowData in the newly created JS context\n     view.chrome.app.window.initializeAppWindow(windowParams);\n \n-    if (request.callback) {\n-      request.callback(view.chrome.app.window.current());\n+    var callback = request.callback;\n+    if (callback) {\n       delete request.callback;\n+      if (!view) {\n+        callback(undefined);\n+        return;\n+      }\n+\n+      var willCallback = OnContextReady(windowParams.viewId, function(success) {\n+        if (success) {\n+          callback(view.chrome.app.window.current());\n+        } else {\n+          callback(undefined);\n+        }\n+      });\n+      if (!willCallback) {\n+        callback(undefined);\n+      }\n     }\n   });\n \n@@ -50,7 +66,7 @@ chromeHidden.registerCustomHook('app.window', function(bindingsAPI) {\n     if (!chromeHidden.currentAppWindow)\n       return;\n     chromeHidden.currentAppWindow.onClose.dispatch();\n-  }\n+  };\n \n   // This is an internal function, but needs to be bound with setHandleRequest\n   // because it is called from a different JS context","disapproval":false,"date":"2012-10-22 00:32:59.798740","approval":false},{"sender":"commit-bot@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","ager@google.com","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org","ager@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/jeremya@chromium.org/10979085/25001","disapproval":false,"date":"2012-10-23 04:31:53.712440","approval":false},{"sender":"commit-bot@chromium.org","recipients":["jeremya@chromium.org","mihaip@chromium.org","darin@chromium.org","ager@google.com","chromium-reviews@chromium.org","aa@chromium.org","mihaip-chromium-reviews@chromium.org","darin-cc@chromium.org","tapted@chromium.org","benwells@chromium.org","ager@chromium.org"],"text":"Change committed as 163518","disapproval":false,"date":"2012-10-23 07:31:08.885590","approval":false}],"owner_email":"jeremya@chromium.org","private":false,"base_url":"http://git.chromium.org/chromium/src.git@master","owner":"jeremya","subject":"Don't call window callback until after DidCreateDocumentElement","created":"2012-09-28 21:16:05.417970","patchsets":[1,5001,12001,18001,23001,25001],"modified":"2012-10-23 07:31:09.026330","closed":true,"commit":false,"issue":10979085}