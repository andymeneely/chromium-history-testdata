{"description":"Fix crash caused by URLRequest accessing members of its URLRequestContext after\nthey have been deleted.\n\nBecause ProfileIOData is destroyed through the IO thread's MessageLoop, it is\npossible for URLRequests to be destroyed after ProfileIOData.\n\nBUG=http://crosbug.com/24911\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=117355","cc":["chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"reviewers":["eroman@chromium.org","jam@chromium.org"],"messages":[{"sender":"darin@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"Eric, I decided to go ahead with this fix since I confirmed that the ProfileIOData is destroyed via the IO thread's MessageLoop (before IOThread::CleanUp).","disapproval":false,"date":"2012-01-11 01:05:52.767645","approval":false},{"sender":"eroman@chromium.org","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"lgtm\n\nOn Tue, Jan 10, 2012 at 5:05 PM, <darin@chromium.org> wrote:\n\n> Reviewers: eroman, John Abd-El-Malek,\n>\n> Message:\n> Eric, I decided to go ahead with this fix since I confirmed that the\n> ProfileIOData is destroyed via the IO thread's MessageLoop (before\n> IOThread::CleanUp).\n>\n> Description:\n> Fix crash caused by URLRequest accessing members of its URLRequestContext\n> after\n> they have been deleted.\n>\n> Because ProfileIOData is destroyed through the IO thread's MessageLoop, it\n> is\n> possible for URLRequests to be destroyed after ProfileIOData.\n>\n> BUG=http://crosbug.com/24911\n>\n> Please review this at http://codereview.chromium.**org/9158032/<http://codereview.chromium.org/9158032/>\n>\n> SVN Base: svn://svn.chromium.org/chrome/**trunk/src/<http://svn.chromium.org/chrome/trunk/src/>\n>\n> Affected files:\n>  M     content/browser/renderer_host/**resource_dispatcher_host.h\n>  M     content/browser/renderer_host/**resource_dispatcher_host.cc\n>\n>\n> Index: content/browser/renderer_host/**resource_dispatcher_host.cc\n> ==============================**==============================**=======\n> --- content/browser/renderer_host/**resource_dispatcher_host.cc\n> (revision 117133)\n> +++ content/browser/renderer_host/**resource_dispatcher_host.cc\n> (working copy)\n> @@ -1265,8 +1265,7 @@\n>   // Delete lazily as this will also delete |info|, triggering the\n>   // ResourceHandler::**OnRequestClosed notification.  This way we avoid\n>   // re-entering a ResourceHandler that is calling CancelRequest.\n> -  iter->second->set_delegate(**NULL);\n> -  MessageLoop::current()->**DeleteSoon(FROM_HERE, iter->second);\n> +  DeleteRequestSoon(iter->**second);\n>\n>   pending_requests_.erase(iter);\n>\n> @@ -1721,6 +1720,14 @@\n>   }\n>  }\n>\n> +void ResourceDispatcherHost::**DeleteRequestSoon(net::**URLRequest*\n> request) {\n> +  // Drop external references as these may be deleted before the request.\n> +  request->set_delegate(NULL);\n> +  request->set_context(NULL);\n> +\n> +  MessageLoop::current()->**DeleteSoon(FROM_HERE, request);\n> +}\n> +\n>  void ResourceDispatcherHost::**StartReading(net::URLRequest* request) {\n>   // Start reading.\n>   int bytes_read = 0;\n> Index: content/browser/renderer_host/**resource_dispatcher_host.h\n> ==============================**==============================**=======\n> --- content/browser/renderer_host/**resource_dispatcher_host.h\n>  (revision 117133)\n> +++ content/browser/renderer_host/**resource_dispatcher_host.h\n>  (working copy)\n> @@ -298,6 +298,8 @@\n>   // Resumes the given request by calling OnResponseStarted or\n> OnReadCompleted.\n>   void ResumeRequest(const content::GlobalRequestID& request_id);\n>\n> +  void DeleteRequestSoon(net::**URLRequest* request);\n> +\n>   // Internal function to start reading for the first time.\n>   void StartReading(net::URLRequest* request);\n>\n>\n>\n>\n","disapproval":false,"date":"2012-01-11 01:27:37.215469","approval":true},{"sender":"jam@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"i defer to you guys, you know this code better than me","disapproval":false,"date":"2012-01-11 01:42:23.546500","approval":false},{"sender":"commit-bot@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/darin@chromium.org/9158032/1","disapproval":false,"date":"2012-01-11 05:59:30.256712","approval":false},{"sender":"commit-bot@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"Try job failure for 9158032-1 (retry) on mac_rel for step \"ui_tests\".\nIt's a second try, previously, step \"ui_tests\" failed.\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=mac_rel&number=8611","disapproval":false,"date":"2012-01-11 07:43:20.650260","approval":false},{"sender":"commit-bot@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/darin@chromium.org/9158032/1","disapproval":false,"date":"2012-01-11 18:17:44.234712","approval":false},{"sender":"commit-bot@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"Try job failure for 9158032-1 (retry) on win_rel for step \"base_unittests\".\nIt's a second try, previously, step \"base_unittests\" failed.\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=win_rel&number=9063","disapproval":false,"date":"2012-01-11 20:25:27.857200","approval":false},{"sender":"commit-bot@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/darin@chromium.org/9158032/1","disapproval":false,"date":"2012-01-11 20:27:04.253414","approval":false},{"sender":"commit-bot@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"Try job failure for 9158032-1 (retry) on win_rel for step \"browser_tests\".\nIt's a second try, previously, steps \"browser_tests, ui_tests\" failed.\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=win_rel&number=9099","disapproval":false,"date":"2012-01-11 22:20:22.794161","approval":false},{"sender":"commit-bot@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/darin@chromium.org/9158032/1","disapproval":false,"date":"2012-01-11 23:30:05.362663","approval":false},{"sender":"commit-bot@chromium.org","recipients":["darin@chromium.org","eroman@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","dpranke-watch+content@chromium.org"],"text":"Change committed as 117355","disapproval":false,"date":"2012-01-12 01:51:47.766551","approval":false}],"owner_email":"darin@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src/","owner":"darin","subject":"Fix crash caused by URLRequest accessing members of its URLRequestContext after","created":"2012-01-11 01:04:21.860116","patchsets":[1],"modified":"2012-01-12 01:51:47.892020","closed":true,"commit":false,"issue":9158032}