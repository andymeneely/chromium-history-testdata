{"description":"Fixes use after free during drag and drop.\n\nApparently under windows requesting focus can trigger capture lost,\nwhich caused all sorts of problems with tab dragging. When you've\ndragged enough to initiate a real tab drag we save focus. The code\nnever expected saving focus to trigger a capture lost (which stops tab\ndragging), which triggered the crash. The fix is to make the code\nallow for saving focus to delete the TabDragController.\n\nI'm also converting from storing a raw View* for the previously focused view to a ViewStorage id. This way if the previously focused view is deleted no crashes.\n\nI had to add a bit of infrastructure for the test.\n\nBUG=275931\nTEST=covered by test now.\nR=ben@chromium.org\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=221456","cc":["chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"reviewers":["ben@chromium.org"],"messages":[{"sender":"sky@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"","disapproval":false,"date":"2013-09-03 23:44:00.533270","approval":false},{"sender":"ben@chromium.org","recipients":["reply@chromiumcodereview-hr.appspotmail.com"],"text":"patch is malformed\r\n\r\n\r\nOn Tue, Sep 3, 2013 at 4:44 PM, <sky@chromium.org> wrote:\r\n\r\n> Reviewers: Ben Goodger (Google),\r\n>\r\n> Description:\r\n> Fixes use after free during drag and drop.\r\n>\r\n> Apparently under windows requesting focus can trigger capture lost,\r\n> which caused all sorts of problems with tab dragging. When you've\r\n> dragged enough to initiate a real tab drag we save focus. The code\r\n> never expected saving focus to trigger a capture lost (which stops tab\r\n> dragging), which triggered the crash. The fix is to make the code\r\n> allow for saving focus to delete the TabDragController.\r\n>\r\n> I'm also converting from storing a raw View* for the previously focused\r\n> view to\r\n> a ViewStorage id. This way if the previously focused view is deleted no\r\n> crashes.\r\n>\r\n> I had to add a bit of infrastructure for the test.\r\n>\r\n> BUG=275931\r\n> TEST=covered by test now.\r\n> R=ben@chromium.org\r\n>\r\n> Please review this at https://codereview.chromium.**org/23523018/<https://codereview.chromium.org/23523018/>\r\n>\r\n> SVN Base: svn://svn.chromium.org/chrome/**trunk/src<http://svn.chromium.org/chrome/trunk/src>\r\n>\r\n> Affected files:\r\n>   M chrome/browser/ui/views/frame/**browser_frame.cc\r\n>   M chrome/browser/ui/views/frame/**browser_frame_aura.cc\r\n>   M chrome/browser/ui/views/frame/**browser_frame_win.cc\r\n>   M chrome/browser/ui/views/frame/**desktop_browser_frame_aura.h\r\n>   M chrome/browser/ui/views/frame/**desktop_browser_frame_aura.cc\r\n>   M chrome/browser/ui/views/frame/**native_browser_frame.h\r\n>   A chrome/browser/ui/views/frame/**native_browser_frame_factory.h\r\n>   A chrome/browser/ui/views/frame/**native_browser_frame_factory.**cc\r\n>   A chrome/browser/ui/views/frame/**native_browser_frame_factory_**aura.cc\r\n>   A chrome/browser/ui/views/frame/**native_browser_frame_factory_**win.cc\r\n>   M chrome/browser/ui/views/tabs/**tab_drag_controller.h\r\n>   M chrome/browser/ui/views/tabs/**tab_drag_controller.cc\r\n>   M chrome/browser/ui/views/tabs/**tab_drag_controller_**\r\n> interactive_uitest.cc\r\n>   M chrome/chrome_browser_ui.gypi\r\n>\r\n>\r\n>\r\n\r\nTo unsubscribe from this group and stop receiving emails from it, send an email to chromium-reviews+unsubscribe@chromium.org.\r\n","disapproval":false,"date":"2013-09-04 03:15:35.458240","approval":false},{"sender":"sky@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"GAH! Try agian.","disapproval":false,"date":"2013-09-04 14:07:21.234010","approval":false},{"sender":"ben@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"lgtm","disapproval":false,"date":"2013-09-04 17:08:59.271290","approval":true},{"sender":"commit-bot@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/sky@chromium.org/23523018/46001","disapproval":false,"date":"2013-09-04 17:15:39.556920","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"Failed to apply patch for chrome/browser/ui/views/tabs/tab_drag_controller.cc:\nWhile running patch -p1 --forward --force --no-backup-if-mismatch;\n  patching file chrome/browser/ui/views/tabs/tab_drag_controller.cc\n  Hunk #1 succeeded at 43 (offset -1 lines).\n  Hunk #2 succeeded at 361 (offset -1 lines).\n  Hunk #3 FAILED at 385.\n  Hunk #4 succeeded at 500 (offset -3 lines).\n  Hunk #5 FAILED at 756.\n  2 out of 5 hunks FAILED -- saving rejects to file chrome/browser/ui/views/tabs/tab_drag_controller.cc.rej\n\nPatch:       chrome/browser/ui/views/tabs/tab_drag_controller.cc\nIndex: chrome/browser/ui/views/tabs/tab_drag_controller.cc\ndiff --git a/chrome/browser/ui/views/tabs/tab_drag_controller.cc b/chrome/browser/ui/views/tabs/tab_drag_controller.cc\nindex 7ceb529be3ded59d679e6b2daa5f974741f046e8..197d9229799c087f49f17b8101a2e72a802fafdd 100644\n--- a/chrome/browser/ui/views/tabs/tab_drag_controller.cc\n+++ b/chrome/browser/ui/views/tabs/tab_drag_controller.cc\n@@ -44,6 +44,7 @@\n #include \"ui/gfx/canvas.h\"\n #include \"ui/gfx/image/image_skia.h\"\n #include \"ui/gfx/screen.h\"\n+#include \"ui/views/focus/view_storage.h\"\n #include \"ui/views/widget/root_view.h\"\n #include \"ui/views/widget/widget.h\"\n \n@@ -361,7 +362,8 @@ TabDragController::TabDragController()\n       screen_(NULL),\n       host_desktop_type_(chrome::HOST_DESKTOP_TYPE_NATIVE),\n       offset_to_width_ratio_(0),\n-      old_focused_view_(NULL),\n+      old_focused_view_id_(\n+          views::ViewStorage::GetInstance()->CreateStorageID()),\n       last_move_screen_loc_(0),\n       started_drag_(false),\n       active_(true),\n@@ -383,6 +385,9 @@ TabDragController::TabDragController()\n \n TabDragController::~TabDragController() {\n   CHECK(!saving_focus_);\n+\n+  views::ViewStorage::GetInstance()->RemoveView(old_focused_view_id_);\n+\n   if (instance_ == this)\n     instance_ = NULL;\n \n@@ -501,8 +506,16 @@ void TabDragController::Drag(const gfx::Point& point_in_screen) {\n     if (!CanStartDrag(point_in_screen))\n       return;  // User hasn't dragged far enough yet.\n \n+    // On windows SaveFocus() may trigger a capture lost, which destroys us.\n+    {\n+      bool destroyed = false;\n+      destroyed_ = &destroyed;\n+      SaveFocus();\n+      if (destroyed)\n+        return;\n+      destroyed_ = NULL;\n+    }\n     started_drag_ = true;\n-    SaveFocus();\n     Attach(source_tabstrip_, gfx::Point());\n     if (detach_into_browser_ && static_cast<int>(drag_data_.size()) ==\n         GetModel(source_tabstrip_)->count()) {\n@@ -746,24 +759,25 @@ void TabDragController::UpdateDockInfo(const gfx::Point& point_in_screen) {\n }\n \n void TabDragController::SaveFocus() {\n-  DCHECK(!old_focused_view_);  // This should only be invoked once.\n   DCHECK(source_tabstrip_);\n-  old_focused_view_ = source_tabstrip_->GetFocusManager()->GetFocusedView();\n-  // TODO(sky): used in tracking crash; see 275931.\n-  const char* old_focused_view_class_name =\n-      old_focused_view_ ? old_focused_view_->GetClassName() : NULL;\n-  base::debug::Alias(old_focused_view_class_name);\n-  const int old_focused_view_id =\n-      old_focused_view_ ? old_focused_view_->id() : 0;\n-  base::debug::Alias(&old_focused_view_id);\n-  base::AutoReset<bool> setter(&saving_focus_, true);\n+  views::View* focused_view =\n+      source_tabstrip_->GetFocusManager()->GetFocusedView();\n+  if (focused_view)\n+    views::ViewStorage::GetInstance()->StoreView(old_focused_view_id_,\n+                                                 focused_view);\n   source_tabstrip_->GetFocusManager()->SetFocusedView(source_tabstrip_);\n+  // WARNING: we may have been deleted.\n }\n \n void TabDragController::RestoreFocus() {\n-  if (old_focused_view_ && attached_tabstrip_ == source_tabstrip_)\n-    old_focused_view_->GetFocusManager()->SetFocusedView(old_focused_view_);\n-  old_focused_view_ = NULL;\n+  if (attached_tabstrip_ != source_tabstrip_)\n+    return;\n+  views::View* old_focused_view =\n+      views::ViewStorage::GetInstance()->RetrieveView(\n+      old_focused_view_id_);\n+  if (!old_focused_view)\n+    return;\n+  old_focused_view->GetFocusManager()->SetFocusedView(old_focused_view);\n }\n \n bool TabDragController::CanStartDrag(const gfx::Point& point_in_screen) const {","disapproval":false,"date":"2013-09-04 17:15:49.951000","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/sky@chromium.org/23523018/2001","disapproval":false,"date":"2013-09-04 18:16:20.695540","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"Step \"update\" is always a major failure.\nLook at the try server FAQ for more details.\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=android_clang_dbg&number=73816","disapproval":false,"date":"2013-09-04 18:24:08.593880","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/sky@chromium.org/23523018/2001","disapproval":false,"date":"2013-09-05 15:32:36.359990","approval":false},{"sender":"commit-bot@chromium.org","recipients":["sky@chromium.org","ben@chromium.org","chromium-reviews@chromium.org","tfarina@chromium.org","dcheng@chromium.org"],"text":"Change committed as 221456","disapproval":false,"date":"2013-09-05 18:09:38.038290","approval":false}],"owner_email":"sky@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"sky","subject":"Fixes use after free during drag and drop.","created":"2013-09-03 23:33:38.290220","patchsets":[1,3001,20001,46001,2001],"modified":"2013-09-05 18:09:38.496070","closed":true,"commit":false,"issue":23523018}