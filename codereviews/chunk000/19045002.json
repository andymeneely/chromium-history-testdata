{"description":"Use Blink support to watch CSS selectors directly instead of using a MutationObserver.\n\nWebKit::WebDocument::watchCSSSelectors was added in https://src.chromium.org/viewvc/blink?view=rev&revision=158582.\n\nThis CL also threads the WebFrameClient::didMatchCSS call back through the Content API.\n\nBUG=172011\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=226938","cc":["chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"reviewers":["kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","thakis@chromium.org"],"messages":[{"sender":"jyasskin@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org"],"text":"Extension folks, could you take an initial look before I send this to the Content owners?","disapproval":false,"date":"2013-10-02 02:58:43.288180","approval":false},{"sender":"mpcomplete@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org"],"text":"https://codereview.chromium.org/19045002/diff/35001/chrome/browser/extensions/api/declarative_content/declarative_content_apitest.cc\nFile chrome/browser/extensions/api/declarative_content/declarative_content_apitest.cc (right):\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/browser/extensions/api/declarative_content/declarative_content_apitest.cc#newcode102\nchrome/browser/extensions/api/declarative_content/declarative_content_apitest.cc:102: ASSERT_TRUE(content::ExecuteScript(tab, std::string()));\nThis double call looks fishy. Are you just calling it again to force a RunMessageLoop()?\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/renderer/extensions/content_watcher.cc\nFile chrome/renderer/extensions/content_watcher.cc (right):\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/renderer/extensions/content_watcher.cc#newcode29\nchrome/renderer/extensions/content_watcher.cc:29: bool unchanged = new_css_selectors.size() == css_selectors_.size();\nnit: negative bools always confuse me. how about \"changed\"\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/renderer/extensions/content_watcher.cc#newcode40\nchrome/renderer/extensions/content_watcher.cc:40: css_selectors_ = new_css_selectors;\nmore efficient to do css_selectors_.swap(new_css_selectors)?\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/renderer/extensions/content_watcher.cc#newcode83\nchrome/renderer/extensions/content_watcher.cc:83: std::set<std::string> ContentWatcher::FindMatchingSelectors(\nI don't see this method called anywhere in this CL, which confuses me how its signature can change.","disapproval":false,"date":"2013-10-02 22:20:21.762100","approval":false},{"sender":"jyasskin@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org"],"text":"https://codereview.chromium.org/19045002/diff/35001/chrome/browser/extensions/api/declarative_content/declarative_content_apitest.cc\nFile chrome/browser/extensions/api/declarative_content/declarative_content_apitest.cc (right):\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/browser/extensions/api/declarative_content/declarative_content_apitest.cc#newcode102\nchrome/browser/extensions/api/declarative_content/declarative_content_apitest.cc:102: ASSERT_TRUE(content::ExecuteScript(tab, std::string()));\nOn 2013/10/02 22:20:22, Matt Perry wrote:\n> This double call looks fishy. Are you just calling it again to force a\n> RunMessageLoop()?\n\nIt's to force a RunMessageLoop in the Blink process. That's icky, but the technique using Notifications was flaky.\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/renderer/extensions/content_watcher.cc\nFile chrome/renderer/extensions/content_watcher.cc (right):\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/renderer/extensions/content_watcher.cc#newcode29\nchrome/renderer/extensions/content_watcher.cc:29: bool unchanged = new_css_selectors.size() == css_selectors_.size();\nOn 2013/10/02 22:20:22, Matt Perry wrote:\n> nit: negative bools always confuse me. how about \"changed\"\n\nSounds good. Done.\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/renderer/extensions/content_watcher.cc#newcode40\nchrome/renderer/extensions/content_watcher.cc:40: css_selectors_ = new_css_selectors;\nOn 2013/10/02 22:20:22, Matt Perry wrote:\n> more efficient to do css_selectors_.swap(new_css_selectors)?\n\nAh, it does work now to build new_css_selectors as a WebVector. Done.\n\nhttps://codereview.chromium.org/19045002/diff/35001/chrome/renderer/extensions/content_watcher.cc#newcode83\nchrome/renderer/extensions/content_watcher.cc:83: std::set<std::string> ContentWatcher::FindMatchingSelectors(\nOn 2013/10/02 22:20:22, Matt Perry wrote:\n> I don't see this method called anywhere in this CL, which confuses me how its\n> signature can change.\n\nYou're right, it's obsolete. Deleted.","disapproval":false,"date":"2013-10-03 00:31:57.450450","approval":false},{"sender":"mpcomplete@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org"],"text":"lgtm","disapproval":false,"date":"2013-10-03 00:34:54.347340","approval":true},{"sender":"jyasskin@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org"],"text":"+jam to look at threading WebFrameClient::didMatchCSS through Content. I'm not certain I got the RenderFrameImpl bit right.\nDo you want to approve renderer_resources.grd too, or should I get another top-level owner to catch that?","disapproval":false,"date":"2013-10-03 01:08:56.729580","approval":false},{"sender":"jam@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org"],"text":"+Charlie for his thoughts on how this will interact with site isolation, in particular this is an API on WebDocument which leads to callbacks on WebFrameClient. Charlie: are we going to have to change this in a big way in the near term, or is this fine? I guess we also will have a lot of fun figuring out how to split/morph RenderViewObserver.\n\nminor nit: newlyMatchingSelectors should be newly_matching_selectors, as the variable names switch to google style outside blink","disapproval":false,"date":"2013-10-03 17:19:14.608720","approval":false},{"sender":"creis@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"On 2013/10/03 17:19:14, jam wrote:\n> +Charlie for his thoughts on how this will interact with site isolation, in\n> particular this is an API on WebDocument which leads to callbacks on\n> WebFrameClient. Charlie: are we going to have to change this in a big way in the\n> near term, or is this fine? I guess we also will have a lot of fun figuring out\n> how to split/morph RenderViewObserver.\n> \n> minor nit: newlyMatchingSelectors should be newly_matching_selectors, as the\n> variable names switch to google style outside blink\n\n[CC'ing Nasko as FYI on RenderFrame change.]\n\nThis looks fine to me, since WebDocument is per-frame.  WebFrameClient and then RenderFrame seems like the right way to route it.  (WebCore::Page is the top-level one, which would have been problematic.)  content/ LGTM.\n\nAlso, yes, splitting up RenderViewObserver for site isolation is going to be fun.  :)","disapproval":false,"date":"2013-10-03 17:37:55.371180","approval":true},{"sender":"jyasskin@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","jam@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"On 2013/10/03 17:19:14, jam wrote:\n> minor nit: newlyMatchingSelectors should be newly_matching_selectors, as the\n> variable names switch to google style outside blink\n\nThis is fixed; thanks.","disapproval":false,"date":"2013-10-03 18:41:34.059870","approval":false},{"sender":"jam@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"On 2013/10/03 17:37:55, creis wrote:\n> On 2013/10/03 17:19:14, jam wrote:\n> > +Charlie for his thoughts on how this will interact with site isolation, in\n> > particular this is an API on WebDocument which leads to callbacks on\n> > WebFrameClient. Charlie: are we going to have to change this in a big way in\n> the\n> > near term, or is this fine? I guess we also will have a lot of fun figuring\n> out\n> > how to split/morph RenderViewObserver.\n> > \n> > minor nit: newlyMatchingSelectors should be newly_matching_selectors, as the\n> > variable names switch to google style outside blink\n> \n> [CC'ing Nasko as FYI on RenderFrame change.]\n> \n> This looks fine to me, since WebDocument is per-frame.  WebFrameClient and then\n> RenderFrame seems like the right way to route it.  (WebCore::Page is the\n> top-level one, which would have been problematic.)  content/ LGTM.\n> \n> Also, yes, splitting up RenderViewObserver for site isolation is going to be\n> fun.  :)\n\nthanks for the lookover. to be explicit, since Charlie reviewed this is fine by me, so no need to wait for me.","disapproval":false,"date":"2013-10-03 21:24:35.994100","approval":false},{"sender":"commit-bot@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/jyasskin@chromium.org/19045002/54001","disapproval":false,"date":"2013-10-03 21:34:18.020890","approval":false},{"sender":"jyasskin@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","thakis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"I still need an LGTM for chrome/renderer/resources/renderer_resources.grd. Nico, since you approved the addition of content_watcher.js, want to approve its removal?","disapproval":false,"date":"2013-10-03 21:54:10.402290","approval":false},{"sender":"thakis@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","thakis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"grd change / js removal lgtm","disapproval":false,"date":"2013-10-03 22:02:21.113550","approval":true},{"sender":"commit-bot@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","thakis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"Retried try job too often on chromium_presubmit for step(s) presubmit\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=chromium_presubmit&number=28785","disapproval":false,"date":"2013-10-03 22:02:48.189500","approval":false},{"sender":"commit-bot@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","thakis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/jyasskin@chromium.org/19045002/54001","disapproval":false,"date":"2013-10-03 22:03:59.703920","approval":false},{"sender":"commit-bot@chromium.org","recipients":["jyasskin@chromium.org","kalman@chromium.org","yoz@chromium.org","mpcomplete@chromium.org","jam@chromium.org","creis@chromium.org","thakis@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","extensions-reviews@chromium.org","chromium-apps-reviews@chromium.org","mpcomplete@chromium.org","nasko@chromium.org"],"text":"Change committed as 226938","disapproval":false,"date":"2013-10-04 02:42:56.852770","approval":false}],"owner_email":"jyasskin@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"Jeffrey Yasskin","subject":"Use Blink support to watch CSS selectors directly instead of using a MutationObserver.","created":"2013-07-11 05:23:24.889510","patchsets":[35001,40001,54001],"modified":"2013-10-04 02:42:57.430130","closed":true,"commit":false,"issue":19045002}