{"description":"Send a notification when the signed-in user is about to sign out.\n\nThis notification gives features that rely on authentication the chance to do some best-effort clean up before the token is cleared. This change will be used in chrome-to-mobile; upon the reception of this notification, chrome-to-mobile receiving service will send request to fetch oauth2 access token using the oauth2 refresh token maintained by TokenService to do server side clean up before the oauth2 refresh token is deleted when the signed-in user signs out.\n\nBUG=NONE\n\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=168275","cc":["chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"reviewers":["stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org"],"messages":[{"sender":"chenyu@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","chromium-reviews@chromium.org","qsr@chromium.org"],"text":"Starting with stuartmorgan for initial look. Thanks!","disapproval":false,"date":"2012-11-07 21:11:48.635580","approval":false},{"sender":"stuartmorgan@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","chromium-reviews@chromium.org","qsr@chromium.org","stuartmorgan@chromium.org"],"text":"No need to run new code by me, just upstreaming of existing code.\n\nOne comment though: please add more information to the CL description explaining specifically what this code will be used for in the changes that will be following after this CL; CLs that add new code without callers/observers need clear, specific motivation.","disapproval":false,"date":"2012-11-08 12:16:33.469400","approval":false},{"sender":"chenyu@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","qsr@chromium.org","stuartmorgan@chromium.org"],"text":"Thanks! cl description updated.","disapproval":false,"date":"2012-11-08 12:55:50.288190","approval":false},{"sender":"atwilson@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","qsr@chromium.org","stuartmorgan@chromium.org"],"text":"https://codereview.chromium.org/11312124/diff/2001/chrome/browser/signin/signin_manager.cc\nFile chrome/browser/signin/signin_manager.cc (right):\n\nhttps://codereview.chromium.org/11312124/diff/2001/chrome/browser/signin/signin_manager.cc#newcode367\nchrome/browser/signin/signin_manager.cc:367: content::Details<const GoogleServiceSignoutDetails>(&details));\nI'm not a huge fan of having this extra notification.\n\nInstead, can we just move the calls to ResetCredentialsInMemory() and EraseTokensFromDB() below until *after* GOOGLE_SIGNED_OUT is called?\n\nAlso, what if we change TokenService to invalidate its oauth login token when the user logs out (as I think has been discussed) - will that impact services that now rely on access tokens living past the logout process?\n\nFinally, if that service has a cached access token, won't it do something like this:\n\n1) Get GOOGLE_SIGNED_OUT\n2) Try using the access token (async network call)\n3) TokenService blows away tokens\n4) Server returns \"token expired\" error\n5) Service tries to mint a new access token, but TokenService no longer has a login token due to step #3, so it can't.\n\nThis attempt to hit the server after logout seems destined to be pretty unreliable - so much so that I am unconvinced we should be doing it.\n\nI don't see a downside to clearing the tokens post-notification, though, even though I don't think your intended use is valid.","disapproval":false,"date":"2012-11-08 13:43:54.855700","approval":false},{"sender":"chenyu@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","qsr@chromium.org","stuartmorgan@chromium.org"],"text":"Yes, I agreed it will be problematic if we change TokenService to invalidate its oauth login token when the user logs out. And in this case, it seems the only solution is to wait for the services that need authentication to clean up to finish before oauth token is invalidated. ?\n\nOn 2012/11/08 13:43:54, Andrew T Wilson wrote:\n> https://codereview.chromium.org/11312124/diff/2001/chrome/browser/signin/signin_manager.cc\n> File chrome/browser/signin/signin_manager.cc (right):\n> \n> https://codereview.chromium.org/11312124/diff/2001/chrome/browser/signin/signin_manager.cc#newcode367\n> chrome/browser/signin/signin_manager.cc:367: content::Details<const\n> GoogleServiceSignoutDetails>(&details));\n> I'm not a huge fan of having this extra notification.\n> \n> Instead, can we just move the calls to ResetCredentialsInMemory() and\n> EraseTokensFromDB() below until *after* GOOGLE_SIGNED_OUT is called?\n> \n> Also, what if we change TokenService to invalidate its oauth login token when\n> the user logs out (as I think has been discussed) - will that impact services\n> that now rely on access tokens living past the logout process?\n> \n> Finally, if that service has a cached access token, won't it do something like\n> this:\n> \n> 1) Get GOOGLE_SIGNED_OUT\n> 2) Try using the access token (async network call)\n> 3) TokenService blows away tokens\n> 4) Server returns \"token expired\" error\n> 5) Service tries to mint a new access token, but TokenService no longer has a\n> login token due to step #3, so it can't.\n> \n> This attempt to hit the server after logout seems destined to be pretty\n> unreliable - so much so that I am unconvinced we should be doing it.\n> \n> I don't see a downside to clearing the tokens post-notification, though, even\n> though I don't think your intended use is valid.","disapproval":false,"date":"2012-11-08 15:31:01.271820","approval":false},{"sender":"qsr@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"I really don't think waiting when signing out is a good idea, especially when waiting mean waiting for a network connection.","disapproval":false,"date":"2012-11-08 15:32:57.758720","approval":false},{"sender":"atwilson@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"On 2012/11/08 15:32:57, qsr wrote:\n> I really don't think waiting when signing out is a good idea, especially when\n> waiting mean waiting for a network connection.\n\nYeah, I keep coming back around to the conclusion that \"trying to take actions at logout time is a bad idea\".","disapproval":false,"date":"2012-11-08 15:34:51.394440","approval":false},{"sender":"chenyu@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"On 2012/11/08 15:32:57, qsr wrote:\n> I really don't think waiting when signing out is a good idea, especially when\n> waiting mean waiting for a network connection.\n\nSorry if this question is silly: we do need network connection to invalidate auth token, right?","disapproval":false,"date":"2012-11-08 15:35:36.820540","approval":false},{"sender":"atwilson@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"On 2012/11/08 15:35:36, Chen Yu wrote:\n> Sorry if this question is silly: we do need network connection to invalidate\n> auth token, right?\nThat's not silly at all :) Yes, it seems like we'd need a network connection. I don't know how munjal was planning to do this (http://crbug.com/152536) - it's possible he was just planning to do a best-effort attempt (make a network request to invalidate the token, and if it fails, don't worry about it).\n\nIt's possible that this kind of \"best-effort\" server call is sufficient for chrome2mobile - my point is that somehow you'd need to coordinate this use with any upcoming change to invalidate the token, because if the token invalidation happens before your request is processed then your request will always fail.","disapproval":false,"date":"2012-11-08 15:50:19.640980","approval":false},{"sender":"chenyu@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"On 2012/11/08 15:50:19, Andrew T Wilson wrote:\n> On 2012/11/08 15:35:36, Chen Yu wrote:\n> > Sorry if this question is silly: we do need network connection to invalidate\n> > auth token, right?\n> That's not silly at all :) Yes, it seems like we'd need a network connection. I\n> don't know how munjal was planning to do this (http://crbug.com/152536) - it's\n> possible he was just planning to do a best-effort attempt (make a network\n> request to invalidate the token, and if it fails, don't worry about it).\n> \n> It's possible that this kind of \"best-effort\" server call is sufficient for\n> chrome2mobile - my point is that somehow you'd need to coordinate this use with\n> any upcoming change to invalidate the token, because if the token invalidation\n> happens before your request is processed then your request will always fail.\n\nThank you very much for the information! \n\nIf there is no concern on clearing the tokens post-notifications, how about we moving on with this change (and the one on OAuthTokenService), while thinking of a better solution? My feeling is best-effort should be sufficient for chrome-to-mobile. (And when we change to invalidate token, can we do it with one second delay?)","disapproval":false,"date":"2012-11-08 16:03:28.381800","approval":false},{"sender":"rogerta@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"lgtm","disapproval":false,"date":"2012-11-08 16:04:28.519840","approval":true},{"sender":"atwilson@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"LGTM.\n\nI would recommend that you update http://crbug.com/152536 to note what chrome2mobile is doing with the tokens after logout, with your suggested workaround (invalidate the token after a time delay) so Munjal is aware of your requirement.","disapproval":false,"date":"2012-11-09 07:33:42.657540","approval":true},{"sender":"commit-bot@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/chenyu@chromium.org/11312124/8001","disapproval":false,"date":"2012-11-13 14:39:54.354090","approval":false},{"sender":"commit-bot@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"Retried try job too often for step(s) browser_tests","disapproval":false,"date":"2012-11-13 17:42:23.871110","approval":false},{"sender":"commit-bot@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/chenyu@chromium.org/11312124/8001","disapproval":false,"date":"2012-11-14 06:54:05.556790","approval":false},{"sender":"commit-bot@chromium.org","recipients":["chenyu@chromium.org","stuartmorgan@chromium.org","rogerta@chromium.org","atwilson@chromium.org","chromium-reviews@chromium.org","stuartmorgan@chromium.org"],"text":"Change committed as 168275","disapproval":false,"date":"2012-11-16 20:19:15.548240","approval":false}],"owner_email":"chenyu@chromium.org","private":false,"base_url":"http://git.chromium.org/chromium/src.git@master","owner":"Chen Yu","subject":"Send a notification when the signed-in user is about to sign out.","created":"2012-11-07 17:44:11.095520","patchsets":[1,2001,8001],"modified":"2012-11-16 20:19:15.691370","closed":true,"commit":false,"issue":11312124}