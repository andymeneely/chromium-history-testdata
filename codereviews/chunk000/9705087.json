{"description":"Change power button and screenlocker behavior for Kiosk Mode.\nIn Kiosk mode, we don't have a screen locker - so any calls that may try to invoke the screenlocker will have undefined results.\nWe want to change all interfaces to the screenlocker itself to invoke more appropriate actions for Kiosk mode but just in case, I've nop'ed out calling of the screenlocker for kiosk mode.\n\nThe power button is one such interface - replaced the default behavior for kiosk mode for it to log the user out instead.\n\nR=satorux@chromium.org\nBUG=chromium-os:27647\nTEST=Tested on a machine with pressing the power button during the login screensaver and once the user is logged in.\n\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=127588","cc":["chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"reviewers":["satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","nkostylev@chromium.org"],"messages":[{"sender":"rkc@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"","disapproval":false,"date":"2012-03-16 00:31:47.219426","approval":false},{"sender":"satorux@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"http://codereview.chromium.org/9705087/diff/1/chrome/browser/chromeos/dbus/power_manager_client.cc\nFile chrome/browser/chromeos/dbus/power_manager_client.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/1/chrome/browser/chromeos/dbus/power_manager_client.cc#newcode233\nchrome/browser/chromeos/dbus/power_manager_client.cc:233: if (KioskModeHelper::IsKioskModeEnabled()) {\nThis doesn't seem to be the right place to do this. The D-Bus client shouldn't know about the kiosk mode. Could you fix the caller of this method instead?","disapproval":false,"date":"2012-03-16 16:13:36.163329","approval":false},{"sender":"rkc@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"On 2012/03/16 16:13:36, satorux1 wrote:\n> http://codereview.chromium.org/9705087/diff/1/chrome/browser/chromeos/dbus/power_manager_client.cc\n> File chrome/browser/chromeos/dbus/power_manager_client.cc (right):\n> \n> http://codereview.chromium.org/9705087/diff/1/chrome/browser/chromeos/dbus/power_manager_client.cc#newcode233\n> chrome/browser/chromeos/dbus/power_manager_client.cc:233: if\n> (KioskModeHelper::IsKioskModeEnabled()) {\n> This doesn't seem to be the right place to do this. The D-Bus client shouldn't\n> know about the kiosk mode. Could you fix the caller of this method instead?\n\nHi Satoru, I specifically added this code here so that even by accident, the screensaver is not invoked for KioskMode. Is there a downside to the power manager knowing about Kiosk Mode?","disapproval":false,"date":"2012-03-16 16:57:27.770430","approval":false},{"sender":"satorux@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"On 2012/03/16 16:57:27, Rahul Chaturvedi wrote:\n> On 2012/03/16 16:13:36, satorux1 wrote:\n> >\n> http://codereview.chromium.org/9705087/diff/1/chrome/browser/chromeos/dbus/power_manager_client.cc\n> > File chrome/browser/chromeos/dbus/power_manager_client.cc (right):\n> > \n> >\n> http://codereview.chromium.org/9705087/diff/1/chrome/browser/chromeos/dbus/power_manager_client.cc#newcode233\n> > chrome/browser/chromeos/dbus/power_manager_client.cc:233: if\n> > (KioskModeHelper::IsKioskModeEnabled()) {\n> > This doesn't seem to be the right place to do this. The D-Bus client shouldn't\n> > know about the kiosk mode. Could you fix the caller of this method instead?\n> \n> Hi Satoru, I specifically added this code here so that even by accident, the\n> screensaver is not invoked for KioskMode. Is there a downside to the power\n> manager knowing about Kiosk Mode?\n\nThe 'dbus' code will be moved to src/chromeos/dbus or somewhere in the near future, so we want to minimize dependencies.\n\nInstead please feel free to add some comment in power_manager_client.h, that  NotifyScreenLockRequested() shouldn't be called directly, and the caller should check if the kiosk mode is turned on. Of course, it's not fool-proof, but better than nothing, I think. How many callers of NotifyScreenLockRequested() are there?\n\n\nAnother approach, which is rather ugly, is to add something like to PowerManagerClient:\n\nvoid DisableScreenLocking();\n\nand called it when the object is created, if the kiosk mode id turned on. However, I generally want D-Bus clients to be stateless, so I'd rather suggest not to do this. :)","disapproval":false,"date":"2012-03-16 17:26:58.036837","approval":false},{"sender":"rkc@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"Adding sky@ and davemoore@ for OWNERS reviews for,\n\nsky@\nchrome/browser/ui/browser.cc\n\ndavemoore@\nchrome/browser/chromeos/login/screen_locker.cc\nchrome/browser/chromeos/login/user.cc\nchrome/browser/chromeos/login/user.h\n\nhttp://codereview.chromium.org/9705087/diff/1/chrome/browser/chromeos/dbus/power_manager_client.cc\nFile chrome/browser/chromeos/dbus/power_manager_client.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/1/chrome/browser/chromeos/dbus/power_manager_client.cc#newcode233\nchrome/browser/chromeos/dbus/power_manager_client.cc:233: if (KioskModeHelper::IsKioskModeEnabled()) {\nOn 2012/03/16 16:13:36, satorux1 wrote:\n> This doesn't seem to be the right place to do this. The D-Bus client shouldn't\n> know about the kiosk mode. Could you fix the caller of this method instead?\n\nDone.","disapproval":false,"date":"2012-03-16 20:59:23.504975","approval":false},{"sender":"satorux@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"http://codereview.chromium.org/9705087/diff/5001/chrome/browser/chromeos/login/screen_locker.cc\nFile chrome/browser/chromeos/login/screen_locker.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/5001/chrome/browser/chromeos/login/screen_locker.cc#newcode352\nchrome/browser/chromeos/login/screen_locker.cc:352: // Note(rkc): For a demo user, we should never, ever show the lock screen.\nnit: Drop Note(rkc):\n\nhttp://codereview.chromium.org/9705087/diff/5001/chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc\nFile chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/5001/chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc#newcode17\nchrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc:17: BrowserList::AttemptUserExit();\nWhy should we attempt exit here? Could you add some comment?","disapproval":false,"date":"2012-03-16 21:03:44.315340","approval":false},{"sender":"rkc@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"http://codereview.chromium.org/9705087/diff/5001/chrome/browser/chromeos/login/screen_locker.cc\nFile chrome/browser/chromeos/login/screen_locker.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/5001/chrome/browser/chromeos/login/screen_locker.cc#newcode352\nchrome/browser/chromeos/login/screen_locker.cc:352: // Note(rkc): For a demo user, we should never, ever show the lock screen.\nOn 2012/03/16 21:03:44, satorux1 wrote:\n> nit: Drop Note(rkc):\nRestructured the comment adding the bug number for reference.\nDone.\n\nhttp://codereview.chromium.org/9705087/diff/5001/chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc\nFile chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/5001/chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc#newcode17\nchrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc:17: BrowserList::AttemptUserExit();\nOn 2012/03/16 21:03:44, satorux1 wrote:\n> Why should we attempt exit here? Could you add some comment?\nPM's requested that we should replace the screen locking with logging the user out. Doing nothing or shutting down the machine weren't good options.\n\nAdded a comment to explain our intention here.\n\nDone.","disapproval":false,"date":"2012-03-16 21:12:35.161325","approval":false},{"sender":"satorux@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"LGTM\n\nhttp://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc\nFile chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc#newcode19\nchrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc:19: // button for Kiosk mode users.\nThank you for adding this. Very useful comment.","disapproval":false,"date":"2012-03-16 21:16:11.235594","approval":true},{"sender":"rkc@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","nkostylev@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"Added Nikita for an owners review.\n\nOn 2012/03/16 21:16:11, satorux1 wrote:\n> LGTM\n> \n> http://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc\n> File chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc\n> (right):\n> \n> http://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc#newcode19\n> chrome/browser/chromeos/power/power_button_controller_delegate_chromeos.cc:19:\n> // button for Kiosk mode users.\n> Thank you for adding this. Very useful comment.","disapproval":false,"date":"2012-03-19 16:29:09.970630","approval":false},{"sender":"nkostylev@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","nkostylev@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"lgtm\n\nhttp://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc\nFile chrome/browser/chromeos/login/screen_locker.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc#newcode353\nchrome/browser/chromeos/login/screen_locker.cc:353: if (UserManager::Get()->GetLoggedInUser().is_guest() ||\nPlease use these methods instead:\nUserManager::Get()->IsLoggedInAsGuest() ||\nUserManager::Get()->IsLoggedInAsDemoUser()\n\nhttp://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc#newcode386\nchrome/browser/chromeos/login/screen_locker.cc:386: if (UserManager::Get()->GetLoggedInUser().is_guest() ||\nSame here.","disapproval":false,"date":"2012-03-19 16:34:14.887785","approval":true},{"sender":"sky@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","nkostylev@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"LGTM","disapproval":false,"date":"2012-03-19 22:18:50.640887","approval":true},{"sender":"commit-bot@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","nkostylev@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/rkc@chromium.org/9705087/7005","disapproval":false,"date":"2012-03-19 22:20:29.713885","approval":false},{"sender":"commit-bot@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","nkostylev@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"Change committed as 127588","disapproval":false,"date":"2012-03-20 00:24:10.584189","approval":false},{"sender":"nkostylev@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","nkostylev@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"http://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc\nFile chrome/browser/chromeos/login/screen_locker.cc (right):\n\nhttp://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc#newcode353\nchrome/browser/chromeos/login/screen_locker.cc:353: if (UserManager::Get()->GetLoggedInUser().is_guest() ||\nOn 2012/03/19 16:34:15, Nikita Kostylev wrote:\n> Please use these methods instead:\n> UserManager::Get()->IsLoggedInAsGuest() ||\n> UserManager::Get()->IsLoggedInAsDemoUser()\n> \n\nWhy this comment has been ignored?\n\nhttp://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc#newcode386\nchrome/browser/chromeos/login/screen_locker.cc:386: if (UserManager::Get()->GetLoggedInUser().is_guest() ||\nOn 2012/03/19 16:34:15, Nikita Kostylev wrote:\n> Same here.\n\nAnd this one.\n\nWe have special methods like IsLoggedInAsDemoUser() and should use those instead of accessing user instance directly. Reason for that is that in some cases user instance might not be initialized if you access it before sign in and you'll get a crash.\n\nPlease fix in a follow up CL.","disapproval":false,"date":"2012-03-20 06:11:30.087762","approval":false},{"sender":"rkc@chromium.org","recipients":["rkc@chromium.org","satorux@chromium.org","sky@chromium.org","davemoore@chromium.org","nkostylev@chromium.org","chromium-reviews@chromium.org","stevenjb+watch@chromium.org","nkostylev+watch@chromium.org","davemoore+watch@chromium.org"],"text":"I am so sorry, I meant to actually fix these within these CL's before I hit the commit queue; but it slipped my mind among the several CL's I was working on.\n\nI'll fix this first thing tomorrow morning in a follow on CL.\n\nOn 2012/03/20 06:11:30, Nikita Kostylev wrote:\n> http://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc\n> File chrome/browser/chromeos/login/screen_locker.cc (right):\n> \n> http://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc#newcode353\n> chrome/browser/chromeos/login/screen_locker.cc:353: if\n> (UserManager::Get()->GetLoggedInUser().is_guest() ||\n> On 2012/03/19 16:34:15, Nikita Kostylev wrote:\n> > Please use these methods instead:\n> > UserManager::Get()->IsLoggedInAsGuest() ||\n> > UserManager::Get()->IsLoggedInAsDemoUser()\n> > \n> \n> Why this comment has been ignored?\n> \n> http://codereview.chromium.org/9705087/diff/7005/chrome/browser/chromeos/login/screen_locker.cc#newcode386\n> chrome/browser/chromeos/login/screen_locker.cc:386: if\n> (UserManager::Get()->GetLoggedInUser().is_guest() ||\n> On 2012/03/19 16:34:15, Nikita Kostylev wrote:\n> > Same here.\n> \n> And this one.\n> \n> We have special methods like IsLoggedInAsDemoUser() and should use those instead\n> of accessing user instance directly. Reason for that is that in some cases user\n> instance might not be initialized if you access it before sign in and you'll get\n> a crash.\n> \n> Please fix in a follow up CL.","disapproval":false,"date":"2012-03-20 06:48:24.941019","approval":false}],"owner_email":"rkc@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"Rahul Chaturvedi","subject":"Change power button and screenlocker behavior for Kiosk Mode.","created":"2012-03-16 00:31:45.712808","patchsets":[1,5001,7005],"modified":"2012-03-20 06:48:25.088464","closed":true,"commit":false,"issue":9705087}