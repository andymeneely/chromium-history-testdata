{"description":"Add histogram to track prerender sessions\r\n\r\nBUG=70401\r\nTEST=nope\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=72800","cc":["chromium-reviews@chromium.org","brettw-cc@chromium.org","cbentzel+watch@chromium.org"],"reviewers":["cbentzel@chromium.org","jar@chromium.org","tburkard@chromium.org"],"messages":[{"sender":"gavinp@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"","disapproval":false,"date":"2011-01-23 00:05:57.684149","approval":false},{"sender":"cbentzel@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"LGTM\n\nFor test, make sure to at least validate that reasonable values show up in about:histograms locally.\n\nhttp://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc\nFile chrome/browser/browser_main.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc#newcode1584\nchrome/browser/browser_main.cc:1584: UMA_HISTOGRAM_ENUMERATION(\nCould you put this in PrefetchFieldTrial so it's more tied with the other prerender/prefetch?\n\nThis is OK as well since near other UMA calls.\n\nhttp://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc#newcode1586\nchrome/browser/browser_main.cc:1586: parsed_command_line.HasSwitch(switches::kEnablePagePrerender), 2);\nEventually I think this histogram will want more buckets such as off, manually disabled, manually enabled, trial-enabled.","disapproval":false,"date":"2011-01-23 12:32:47.535593","approval":true},{"sender":"gavinp@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"On 2011/01/23 12:32:47, cbentzel wrote:\n> \n> For test, make sure to at least validate that reasonable values show up in\n> about:histograms locally.\n> \n\nI've done that, for both settings, and against the command line & about_flags.  Sorry if my test message was more glib above: I meant there were no automatic tests.\n\n> http://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc\n> File chrome/browser/browser_main.cc (right):\n> \n> http://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc#newcode1584\n> chrome/browser/browser_main.cc:1584: UMA_HISTOGRAM_ENUMERATION(\n> Could you put this in PrefetchFieldTrial so it's more tied with the other\n> prerender/prefetch?\n> \n> This is OK as well since near other UMA calls.\n\nThere were a few places that I thought of.\n\nA) where it is\n\nB) in ProfileImpl::GetPrerenderManager()  (call out to a static function from here, that\n   static function having a guard.)  I thought that was a bit sketchy...\n\nC) Closer to other prerender material in the command line flags.  I weighed the UMAs as the place, but I can look and see if we can clump all of our prerender logic in browser_main in one place.\n   \n> \n> http://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc#newcode1586\n> chrome/browser/browser_main.cc:1586:\n> parsed_command_line.HasSwitch(switches::kEnablePagePrerender), 2);\n> Eventually I think this histogram will want more buckets such as off, manually\n> disabled, manually enabled, trial-enabled.\n\nHrrrm.  We might; or we might just use the field trial mechanism to split the histograms we care about (including this one).\n\n- Gavin","disapproval":false,"date":"2011-01-23 14:27:10.715243","approval":false},{"sender":"cbentzel@chromium.org","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"Still LGTM\n\nOn Sun, Jan 23, 2011 at 9:27 AM, <gavinp@chromium.org> wrote:\n\n>\n> B) in ProfileImpl::GetPrerenderManager()  (call out to a static function\n> from\n> here, that\n>   static function having a guard.)  I thought that was a bit sketchy...\n>\n\nThis is probably the wrong place, since the configuration is currently\ncontrolled per-browser rather than per-profile.  If it moves to per-profile\nconfiguration, that may be a better location.\n","disapproval":false,"date":"2011-01-23 14:30:59.740639","approval":true},{"sender":"jar@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"Be sure to validate on try bots.  See comment below.\n\nhttp://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc\nFile chrome/browser/browser_main.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc#newcode1586\nchrome/browser/browser_main.cc:1586: parsed_command_line.HasSwitch(switches::kEnablePagePrerender), 2);\nI think HasSwitch returns a boolean, but the HISTOGRAM is expected an integer sample.  I'd like to see a more explicit selection of 0 vs 1.","disapproval":false,"date":"2011-01-23 20:15:53.348868","approval":false},{"sender":"gavinp@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"Thanks for the reviews!\n\nI've now remediated to Jim's review; I created an enumeration to describe the mapping from bool --> 0, 1.\n\nhttp://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc\nFile chrome/browser/browser_main.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/1/chrome/browser/browser_main.cc#newcode1586\nchrome/browser/browser_main.cc:1586: parsed_command_line.HasSwitch(switches::kEnablePagePrerender), 2);\nOn 2011/01/23 20:15:53, jar wrote:\n> I think HasSwitch returns a boolean, but the HISTOGRAM is expected an integer\n> sample.  I'd like to see a more explicit selection of 0 vs 1.\n\nOK, I've now created an enumeration (which I put in the prerendering directory), and I use that to seed the histogram.  That should also allow expansion of the types in this histogram for different session types.  Chris suggested we'd want this if we don't use the UMA field trial mechanism, and there might well be other reasons.","disapproval":false,"date":"2011-01-24 06:01:46.616261","approval":false},{"sender":"cbentzel@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"So, I had a misunderstanding for how about:flags worked.\n\nBasically, there is a per-profile preference which stores the value of enabled flags. In the ProfileImpl constructor, the shared switches are overwritten with the value in the local preferences. This means that we should probably create the PrerenderManager then, and the histogram for this should be done per-profile rather than per-session [with the exception of off-the-record profiles].","disapproval":false,"date":"2011-01-25 17:49:04.604110","approval":false},{"sender":"cbentzel@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"And, it looks like r72404 landed yesterday which moves about:flags eval to browser_main [using browser local state] rather than per-profile.","disapproval":false,"date":"2011-01-25 18:02:04.891478","approval":false},{"sender":"gavinp@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"Jar: *ping* ?\n\nChris, I think r72404 is a good thing.  Also, this patch still applies to trunk, and I've tested all combinations just now of the about:flags & the command line option, it seems to capture correctly.","disapproval":false,"date":"2011-01-26 01:54:10.910251","approval":false},{"sender":"cbentzel@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6340013/diff/8001/chrome/browser/browser_main.cc\nFile chrome/browser/browser_main.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/8001/chrome/browser/browser_main.cc#newcode1585\nchrome/browser/browser_main.cc:1585: UMA_HISTOGRAM_ENUMERATION(\nI'd really like this to be placed in PrefetchFieldTrial now so flag reading happens in one centralized place, rather than both in PrefetchFieldTrial and GetSessionType","disapproval":false,"date":"2011-01-26 16:55:46.486721","approval":false},{"sender":"jar@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org"],"text":"http://codereview.chromium.org/6340013/diff/8001/chrome/browser/prerender/prerender_manager.cc\nFile chrome/browser/prerender/prerender_manager.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/8001/chrome/browser/prerender/prerender_manager.cc#newcode21\nchrome/browser/prerender/prerender_manager.cc:21: switches::kEnablePagePrerender))\nnit: (I think) indent only 4 spaces from previous line.","disapproval":false,"date":"2011-01-26 21:31:32.353133","approval":false},{"sender":"gavinp@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","tburkard@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","cbentzel+watch@chromium.org"],"text":"Thanks for the reviews everyone!  This latest upload changes the way the enumeration is initialized, again.  I've also merged in some changes of Timo's that were touching on similar work.\n\nhttp://codereview.chromium.org/6340013/diff/8001/chrome/browser/browser_main.cc\nFile chrome/browser/browser_main.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/8001/chrome/browser/browser_main.cc#newcode1585\nchrome/browser/browser_main.cc:1585: UMA_HISTOGRAM_ENUMERATION(\nOn 2011/01/26 16:55:46, cbentzel wrote:\n> I'd really like this to be placed in PrefetchFieldTrial now so flag reading\n> happens in one centralized place, rather than both in PrefetchFieldTrial and\n> GetSessionType\n\nDone.\n\nhttp://codereview.chromium.org/6340013/diff/8001/chrome/browser/prerender/prerender_manager.cc\nFile chrome/browser/prerender/prerender_manager.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/8001/chrome/browser/prerender/prerender_manager.cc#newcode21\nchrome/browser/prerender/prerender_manager.cc:21: switches::kEnablePagePrerender))\nOn 2011/01/26 21:31:32, jar wrote:\n> nit: (I think) indent only 4 spaces from previous line.\n\njar & I followed up on this: brettw said that indent by 8 here is acceptable, as is indent by four based on readability.  However, this is informational only, as this function doesn't exist in the new upload.","disapproval":false,"date":"2011-01-27 04:29:29.162965","approval":false},{"sender":"cbentzel@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","tburkard@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","cbentzel+watch@chromium.org"],"text":"LGTM\n\nI wish there was a way we could avoid the static'ness of mode, but I couldn't think of a good alternative.\n\nhttp://codereview.chromium.org/6340013/diff/21001/chrome/browser/browser_main.cc\nFile chrome/browser/browser_main.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/21001/chrome/browser/browser_main.cc#newcode453\nchrome/browser/browser_main.cc:453: PrerenderManager::PrerenderManagerMode prerender_mode;\nUninitialized values always scare me. Maybe change if/else to ternary, or initialize to DISABLED.\n\nhttp://codereview.chromium.org/6340013/diff/21001/chrome/browser/browser_main.cc#newcode460\nchrome/browser/browser_main.cc:460: UMA_HISTOGRAM_ENUMERATION(\"Prerender.Sessions\", prerender_mode,\nDo we have other Prerender-prefixed histograms at this point, or is this the first one?","disapproval":false,"date":"2011-01-27 04:38:34.195735","approval":true},{"sender":"gavinp@chromium.org","recipients":["gavinp@chromium.org","cbentzel@chromium.org","jar@chromium.org","tburkard@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","cbentzel+watch@chromium.org"],"text":"This latest upload fixes the initialization, and it's what I'll commit tomorrow morning if the tree's green.  :)\n\nhttp://codereview.chromium.org/6340013/diff/21001/chrome/browser/browser_main.cc\nFile chrome/browser/browser_main.cc (right):\n\nhttp://codereview.chromium.org/6340013/diff/21001/chrome/browser/browser_main.cc#newcode453\nchrome/browser/browser_main.cc:453: PrerenderManager::PrerenderManagerMode prerender_mode;\nOn 2011/01/27 04:38:34, cbentzel wrote:\n> Uninitialized values always scare me. Maybe change if/else to ternary, or\n> initialize to DISABLED. \n\nDone.\n\nhttp://codereview.chromium.org/6340013/diff/21001/chrome/browser/browser_main.cc#newcode460\nchrome/browser/browser_main.cc:460: UMA_HISTOGRAM_ENUMERATION(\"Prerender.Sessions\", prerender_mode,\nOn 2011/01/27 04:38:34, cbentzel wrote:\n> Do we have other Prerender-prefixed histograms at this point, or is this the\n> first one?\n\nThis is the first one.  I couldn't think of another group to put it in reviewing them: ultimately I guess our histograms will be split between PLT and Prerender?","disapproval":false,"date":"2011-01-27 05:25:26.747976","approval":false}],"owner_email":"gavinp@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"gavinp","subject":"Add histogram to track prerender sessions","created":"2011-01-23 00:05:15.725167","patchsets":[1,8001,21001,22005],"modified":"2011-06-24 19:21:08.513606","closed":true,"commit":false,"issue":6340013}