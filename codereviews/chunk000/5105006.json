{"description":"Resize synchronization for Linux.\r\n\r\nThis patch makes synchronous calls from the GPU to the Browser process to resize windows. It must be synchronous because we must be sure when the resize happens, it must be initiated by the GPU because we have to time the resize with GL drawing, and the resize must be done by the Browser because of how GDK/GTK is structured. Specifically, when a window that a GL context is associated with is resized, the back buffer gets blanked. So it is important that we synchronize the resize with the drawing to the back buffer. On Linux, the X window that we are drawing to is wrapped in a GdkWindow inside the Browser process. GDK/GTK assumes that all changes to the window happen via GDK calls. In particular, the size of the window is cached inside the GdkWindow object so that it does not have to make a call to the X server in order to get window geometry. Unfortunately, this necessitates resizing the window inside of the Browser process.\r\n\r\nFor more discussion of this approach and (some unsuccessfully attempted) alternatives see https://docs.google.com/a/google.com/document/d/1ZNouL-X_Ml1x8sqy-sofz63pDAeo36VWi_yQihaE2YI/edit?hl=en\r\n\r\nThis patch set uncovered another bug:\r\n- open in two separate windows http://webkit.org/blog/386/3d-transforms/ and http://webkit.org/blog-files/3d-transforms/poster-circle.html\r\n- resize the former until it is smallish\r\n- watch the root layer of the former show up as the root layer of the later.\r\n\r\nTo my knowledge, this is first trigger of this bug. If and when this patch is accepted, I will file the bug.\r\n\r\nBUG=http://code.google.com/p/chromium/issues/detail?id=54430\r\n\r\nTEST=Go to http://peter.sh/2010/06/chromium-now-features-gpu-acceleration-and-css-3d-transforms/ . Rotate Z with the slider to trigger the compositor. Resize the window. The resize may be janky (we're uploading large textures), but it should display properly.\r\n\r\nContributed by backer@chromium.org\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=67416","cc":["chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","apatrick@chromium.org"],"reviewers":["vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","nduca@chromium.org"],"messages":[{"sender":"backer@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","nduca@chromium.org"],"text":"","disapproval":false,"date":"2010-11-19 22:46:07.649408","approval":false},{"sender":"kbr@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","nduca@chromium.org"],"text":"http://codereview.chromium.org/5105006/diff/1/app/gfx/gl/gl_context_linux.cc\nFile app/gfx/gl/gl_context_linux.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/1/app/gfx/gl/gl_context_linux.cc#newcode329\napp/gfx/gl/gl_context_linux.cc:329: new GpuHostMsg_ResizeXID(window_, size.width(), size.height(), &result));\nThis violates a large number of abstraction barriers. app/ isn't allowed to reach up and touch chrome/ . You'll need to figure out a different structuring. If the message needs to be sent in response to setting the context's size, then I suggest adding a callback to the GLContext class and setting that callback (which would do this work) in gpu_processor_linux.cc.","disapproval":false,"date":"2010-11-22 22:49:52.454893","approval":false},{"sender":"backer@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","nduca@chromium.org","apatrick@chromium.org"],"text":"http://codereview.chromium.org/5105006/diff/1/app/gfx/gl/gl_context_linux.cc\nFile app/gfx/gl/gl_context_linux.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/1/app/gfx/gl/gl_context_linux.cc#newcode329\napp/gfx/gl/gl_context_linux.cc:329: new GpuHostMsg_ResizeXID(window_, size.width(), size.height(), &result));\nOn 2010/11/22 22:49:52, kbr wrote:\n> This violates a large number of abstraction barriers. app/ isn't allowed to\n> reach up and touch chrome/ . You'll need to figure out a different structuring.\n> If the message needs to be sent in response to setting the context's size, then\n> I suggest adding a callback to the GLContext class and setting that callback\n> (which would do this work) in gpu_processor_linux.cc.\n\nDone. Thanks for catching this. I used your callback suggestion, but I had to go one level higher up to GpuCommandBufferStub to satisfy checkdeps.","disapproval":false,"date":"2010-11-23 16:41:12.661933","approval":false},{"sender":"nduca@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","nduca@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","apatrick@chromium.org"],"text":"http://codereview.chromium.org/5105006/diff/5001/app/gfx/gl/gl_context.h\nFile app/gfx/gl/gl_context.h (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/app/gfx/gl/gl_context.h#newcode42\napp/gfx/gl/gl_context.h:42: // Set the size of the back buffer. Calls the callback.\nIs there a way to put this callback on the GL-specific implementation? Its a bit awkward to have this on the global GL context.\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.cc\nFile chrome/browser/gpu_process_host.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.cc#newcode220\nchrome/browser/gpu_process_host.cc:220: void ResizeXIDDispatcher(unsigned long xid, int32 width, int32 height,\nsame comments about in32\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.cc#newcode245\nchrome/browser/gpu_process_host.cc:245: }\nint32\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.h\nFile chrome/browser/gpu_process_host.h (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.h#newcode85\nchrome/browser/gpu_process_host.h:85: void OnResizeXID(unsigned long xid, int32 width, int32 height,\njam@ has been pushing me to use ints instead of int32s in this file. I've changed the rest of the file in my cl, but might be good to keept his addition consistent with that [yet-to-be-landed change]\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/renderer_host/render_widget_host.cc\nFile chrome/browser/renderer_host/render_widget_host.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/renderer_host/render_widget_host.cc#newcode956\nchrome/browser/renderer_host/render_widget_host.cc:956: #elif defined(TOOLKIT_USES_GTK)\nSuggeset calling this didAcceleratedCompositingActivated to be consistent with the naming. In issue 4815001, I've renamed this function to OnMsgAcceleratedCompositingActivated [I think, I might have the name slightly wrong...]\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/renderer_host/render_widget_host_view.h\nFile chrome/browser/renderer_host/render_widget_host_view.h (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/renderer_host/render_widget_host_view.h#newcode236\nchrome/browser/renderer_host/render_widget_host_view.h:236: virtual void GpuRenderingActivated(bool activated) = 0;\ns/GpuRenderingActivated/AcceleratedCompositingActivated/?\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/gpu/gpu_command_buffer_stub.cc\nFile chrome/gpu/gpu_command_buffer_stub.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/gpu/gpu_command_buffer_stub.cc#newcode115\nchrome/gpu/gpu_command_buffer_stub.cc:115: }\nHow does the Macosx SetSwapBuffersCallback get implemented? It seems that's done without touching the main Gl context?","disapproval":false,"date":"2010-11-23 16:59:48.431328","approval":false},{"sender":"kbr@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","nduca@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","apatrick@chromium.org"],"text":"Nat has a good point that the resize callback could be handled entirely on the GLES2Decoder rather than touching the GLContext classes. I'll LGTM this pending addressing of Nat's other review feedback, but if you want to wire it up through the GLES2Decoder I think that would be cleaner and will be happy to review that.\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/gpu/gpu_command_buffer_stub.cc\nFile chrome/gpu/gpu_command_buffer_stub.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/gpu/gpu_command_buffer_stub.cc#newcode115\nchrome/gpu/gpu_command_buffer_stub.cc:115: }\nOn 2010/11/23 16:59:49, nduca wrote:\n> How does the Macosx SetSwapBuffersCallback get implemented? It seems that's done\n> without touching the main Gl context?\n\nIt's wired up through the GLES2Decoder. It does seem that that would be an alternative; the callback could be called from DoResizeCHROMIUM before calling GLContext::SetSize(), and would avoid changes to the GLContext.\n\nhttp://codereview.chromium.org/5105006/diff/5001/gfx/gtk_preserve_window.cc\nFile gfx/gtk_preserve_window.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/gfx/gtk_preserve_window.cc#newcode179\ngfx/gtk_preserve_window.cc:179: // Just update the state. Someone else with gdk_window_resize the\nwith -> will","disapproval":false,"date":"2010-11-23 19:17:55.687824","approval":true},{"sender":"backer@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","nduca@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","apatrick@chromium.org"],"text":"http://codereview.chromium.org/5105006/diff/5001/app/gfx/gl/gl_context.h\nFile app/gfx/gl/gl_context.h (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/app/gfx/gl/gl_context.h#newcode42\napp/gfx/gl/gl_context.h:42: // Set the size of the back buffer. Calls the callback.\nOn 2010/11/23 16:59:49, nduca wrote:\n> Is there a way to put this callback on the GL-specific implementation? Its a bit\n> awkward to have this on the global GL context.\n\nDone.\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.cc\nFile chrome/browser/gpu_process_host.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.cc#newcode220\nchrome/browser/gpu_process_host.cc:220: void ResizeXIDDispatcher(unsigned long xid, int32 width, int32 height,\nOn 2010/11/23 16:59:49, nduca wrote:\n> same comments about in32\n\nDone.\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.cc#newcode245\nchrome/browser/gpu_process_host.cc:245: }\nOn 2010/11/23 16:59:49, nduca wrote:\n> int32\n\nDone.\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.h\nFile chrome/browser/gpu_process_host.h (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/gpu_process_host.h#newcode85\nchrome/browser/gpu_process_host.h:85: void OnResizeXID(unsigned long xid, int32 width, int32 height,\nOn 2010/11/23 16:59:49, nduca wrote:\n> jam@ has been pushing me to use ints instead of int32s in this file. I've\n> changed the rest of the file in my cl, but might be good to keept his addition\n> consistent with that [yet-to-be-landed change]\n\nDone. I'm switching to gfx::Size because it is more consistent with some of the other messages in gpu_messages_internal.h\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/renderer_host/render_widget_host.cc\nFile chrome/browser/renderer_host/render_widget_host.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/renderer_host/render_widget_host.cc#newcode956\nchrome/browser/renderer_host/render_widget_host.cc:956: #elif defined(TOOLKIT_USES_GTK)\nOn 2010/11/23 16:59:49, nduca wrote:\n> Suggeset calling this didAcceleratedCompositingActivated to be consistent with\n> the naming. In issue 4815001, I've renamed this function to\n> OnMsgAcceleratedCompositingActivated [I think, I might have the name slightly\n> wrong...]\n\nDone.\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/renderer_host/render_widget_host_view.h\nFile chrome/browser/renderer_host/render_widget_host_view.h (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/browser/renderer_host/render_widget_host_view.h#newcode236\nchrome/browser/renderer_host/render_widget_host_view.h:236: virtual void GpuRenderingActivated(bool activated) = 0;\nOn 2010/11/23 16:59:49, nduca wrote:\n> s/GpuRenderingActivated/AcceleratedCompositingActivated/?\n\nDone.\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/gpu/gpu_command_buffer_stub.cc\nFile chrome/gpu/gpu_command_buffer_stub.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/chrome/gpu/gpu_command_buffer_stub.cc#newcode115\nchrome/gpu/gpu_command_buffer_stub.cc:115: }\nOn 2010/11/23 19:17:55, kbr wrote:\n> On 2010/11/23 16:59:49, nduca wrote:\n> > How does the Macosx SetSwapBuffersCallback get implemented? It seems that's\n> done\n> > without touching the main Gl context?\n> \n> It's wired up through the GLES2Decoder. It does seem that that would be an\n> alternative; the callback could be called from DoResizeCHROMIUM before calling\n> GLContext::SetSize(), and would avoid changes to the GLContext.\n\nDone.\n\nhttp://codereview.chromium.org/5105006/diff/5001/gfx/gtk_preserve_window.cc\nFile gfx/gtk_preserve_window.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/5001/gfx/gtk_preserve_window.cc#newcode179\ngfx/gtk_preserve_window.cc:179: // Just update the state. Someone else with gdk_window_resize the\nOn 2010/11/23 19:17:55, kbr wrote:\n> with -> will\n\nDone.","disapproval":false,"date":"2010-11-23 21:00:18.526255","approval":false},{"sender":"nduca@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","nduca@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","apatrick@chromium.org"],"text":"lgtm, mod nits\n\nhttp://codereview.chromium.org/5105006/diff/18001/chrome/gpu/gpu_command_buffer_stub.cc\nFile chrome/gpu/gpu_command_buffer_stub.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/18001/chrome/gpu/gpu_command_buffer_stub.cc#newcode117\nchrome/gpu/gpu_command_buffer_stub.cc:117: #if defined(OS_LINUX)\nhmm, elif?","disapproval":false,"date":"2010-11-23 21:03:51.522398","approval":true},{"sender":"kbr@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","nduca@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","apatrick@chromium.org"],"text":"http://codereview.chromium.org/5105006/diff/36001/gpu/command_buffer/service/gles2_cmd_decoder.cc\nFile gpu/command_buffer/service/gles2_cmd_decoder.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/36001/gpu/command_buffer/service/gles2_cmd_decoder.cc#newcode2561\ngpu/command_buffer/service/gles2_cmd_decoder.cc:2561: #if defined(LINUX)\n#if defined(OS_LINUX)\n\nhttp://codereview.chromium.org/5105006/diff/36001/gpu/command_buffer/service/gles2_cmd_decoder.h\nFile gpu/command_buffer/service/gles2_cmd_decoder.h (right):\n\nhttp://codereview.chromium.org/5105006/diff/36001/gpu/command_buffer/service/gles2_cmd_decoder.h#newcode94\ngpu/command_buffer/service/gles2_cmd_decoder.h:94: virtual void SetResizeCallback(Callback1<gfx::Size>::Type* callback) = 0;\nYou're going to need to modify gles2_cmd_decoder_mock.h too, and possibly other files. Please build and run the gpu_unit_tests target.","disapproval":false,"date":"2010-11-23 22:01:17.545156","approval":false},{"sender":"backer@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","nduca@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","apatrick@chromium.org"],"text":"http://codereview.chromium.org/5105006/diff/36001/gpu/command_buffer/service/gles2_cmd_decoder.cc\nFile gpu/command_buffer/service/gles2_cmd_decoder.cc (right):\n\nhttp://codereview.chromium.org/5105006/diff/36001/gpu/command_buffer/service/gles2_cmd_decoder.cc#newcode2561\ngpu/command_buffer/service/gles2_cmd_decoder.cc:2561: #if defined(LINUX)\nOn 2010/11/23 22:01:17, kbr wrote:\n> #if defined(OS_LINUX)\n\nDone.\n\nhttp://codereview.chromium.org/5105006/diff/36001/gpu/command_buffer/service/gles2_cmd_decoder.h\nFile gpu/command_buffer/service/gles2_cmd_decoder.h (right):\n\nhttp://codereview.chromium.org/5105006/diff/36001/gpu/command_buffer/service/gles2_cmd_decoder.h#newcode94\ngpu/command_buffer/service/gles2_cmd_decoder.h:94: virtual void SetResizeCallback(Callback1<gfx::Size>::Type* callback) = 0;\nOn 2010/11/23 22:01:17, kbr wrote:\n> You're going to need to modify gles2_cmd_decoder_mock.h too, and possibly other\n> files. Please build and run the gpu_unit_tests target.\n\nDone.","disapproval":false,"date":"2010-11-24 14:14:45.303161","approval":false},{"sender":"kbr@chromium.org","recipients":["backer@chromium.org","vangelis@chromium.org","kbr@chromium.org","piman@chromium.org","nduca@chromium.org","chromium-reviews@chromium.org","brettw-cc@chromium.org","darin-cc@chromium.org","ben+cc@chromium.org","thakis@chromium.org","apatrick@chromium.org"],"text":"LGTM","disapproval":false,"date":"2010-11-24 21:00:11.976788","approval":true}],"owner_email":"backer@chromium.org","private":false,"base_url":"http://git.chromium.org/git/chromium.git@trunk","owner":"jonathan.backer","subject":"Resize synchronization for Linux.","created":"2010-11-19 22:35:08.703198","patchsets":[1,5001,18001,36001,39001,44001,48001],"modified":"2011-05-26 14:42:38.757417","closed":true,"commit":false,"issue":5105006}