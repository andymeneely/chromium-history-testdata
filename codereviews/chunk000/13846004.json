{"description":"Remembers the current reposition target.\n\nFurther OnNotificationUpdated() can happen after the repositioning,\nwhich will cancel the repositioning status and moves toasts to\nwrong positions.\n\nBUG=233318\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=195561","cc":["chromium-reviews@chromium.org"],"reviewers":["dewittj@chromium.org","dharcourt@chromium.org"],"messages":[{"sender":"mukai@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"","disapproval":false,"date":"2013-04-19 21:59:36.946220","approval":false},{"sender":"dharcourt@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"lgtm","disapproval":false,"date":"2013-04-19 23:34:29.138160","approval":true},{"sender":"dewittj@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"lgtm\n\nIt'd be nice if in a future CL we used a timer as well to clear the reposition target.","disapproval":false,"date":"2013-04-19 23:48:19.912900","approval":true},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/mukai@chromium.org/13846004/1","disapproval":false,"date":"2013-04-19 23:57:14.145600","approval":false},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"Sorry for I got bad news for ya.\nCompile failed with a clobber build on android_clang_dbg.\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=android_clang_dbg&number=36403\nYour code is likely broken or HEAD is junk. Please ensure your\ncode is not broken then alert the build sheriffs.\nLook at the try server FAQ for more details.","disapproval":false,"date":"2013-04-20 00:22:05.031960","approval":false},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/mukai@chromium.org/13846004/1","disapproval":false,"date":"2013-04-20 00:29:19.703270","approval":false},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/mukai@chromium.org/13846004/25001","disapproval":false,"date":"2013-04-20 00:47:48.791840","approval":false},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"Sorry for I got bad news for ya.\nCompile failed with a clobber build on win.\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=win&number=66328\nYour code is likely broken or HEAD is junk. Please ensure your\ncode is not broken then alert the build sheriffs.\nLook at the try server FAQ for more details.","disapproval":false,"date":"2013-04-20 01:17:01.760090","approval":false},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/mukai@chromium.org/13846004/25001","disapproval":false,"date":"2013-04-22 16:34:13.535120","approval":false},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"Failed to apply patch for ui/message_center/views/message_popup_collection.cc:\nWhile running patch -p1 --forward --force --no-backup-if-mismatch;\n  patching file ui/message_center/views/message_popup_collection.cc\n  Hunk #1 succeeded at 249 (offset 6 lines).\n  Hunk #2 FAILED at 302.\n  Hunk #3 succeeded at 318 (offset 6 lines).\n  Hunk #4 succeeded at 335 (offset 6 lines).\n  Hunk #5 succeeded at 365 (offset 6 lines).\n  Hunk #6 succeeded at 382 (offset 6 lines).\n  1 out of 6 hunks FAILED -- saving rejects to file ui/message_center/views/message_popup_collection.cc.rej\n\nPatch:       ui/message_center/views/message_popup_collection.cc\nIndex: ui/message_center/views/message_popup_collection.cc\ndiff --git a/ui/message_center/views/message_popup_collection.cc b/ui/message_center/views/message_popup_collection.cc\nindex b2f239f6196b0260de94bc175eb4cd4ad815d3bf..63f10dc40d343d392f2e97f99c7d1f40a7bba052 100644\n--- a/ui/message_center/views/message_popup_collection.cc\n+++ b/ui/message_center/views/message_popup_collection.cc\n@@ -243,6 +243,7 @@ void MessagePopupCollection::OnMouseExited() {\n        iter != toasts_.end(); ++iter) {\n     iter->second->RestartTimer();\n   }\n+  reposition_target_ = gfx::Rect();\n   RepositionWidgets();\n   // Reposition could create extra space which allows additional widgets.\n   UpdateWidgets();\n@@ -301,6 +302,11 @@ gfx::Point MessagePopupCollection::GetWorkAreaBottomRight() {\n }\n \n void MessagePopupCollection::RepositionWidgets() {\n+  if (!reposition_target_.IsEmpty()) {\n+    RepositionWidgetsWithTarget();\n+    return;\n+  }\n+\n   int bottom = GetWorkAreaBottomRight().y() - kMarginBetweenItems;\n   for (std::list<views::Widget*>::iterator iter = widgets_.begin();\n        iter != widgets_.end(); ++iter) {\n@@ -311,15 +317,14 @@ void MessagePopupCollection::RepositionWidgets() {\n   }\n }\n \n-void MessagePopupCollection::RepositionWidgetsWithTarget(\n-    const gfx::Rect& target_bounds) {\n+void MessagePopupCollection::RepositionWidgetsWithTarget() {\n   if (widgets_.empty())\n     return;\n \n-  if (widgets_.back()->GetWindowBoundsInScreen().y() > target_bounds.y()) {\n+  if (widgets_.back()->GetWindowBoundsInScreen().y() > reposition_target_.y()) {\n     // No widgets are above, thus slides up the widgets.\n     int slide_length =\n-        widgets_.back()->GetWindowBoundsInScreen().y() - target_bounds.y();\n+        widgets_.back()->GetWindowBoundsInScreen().y() - reposition_target_.y();\n     for (std::list<views::Widget*>::iterator iter = widgets_.begin();\n          iter != widgets_.end(); ++iter) {\n       gfx::Rect bounds((*iter)->GetWindowBoundsInScreen());\n@@ -329,12 +334,12 @@ void MessagePopupCollection::RepositionWidgetsWithTarget(\n   } else {\n     std::list<views::Widget*>::reverse_iterator iter = widgets_.rbegin();\n     for (; iter != widgets_.rend(); ++iter) {\n-      if ((*iter)->GetWindowBoundsInScreen().y() > target_bounds.y())\n+      if ((*iter)->GetWindowBoundsInScreen().y() > reposition_target_.y())\n         break;\n     }\n     --iter;\n     int slide_length =\n-        target_bounds.y() - (*iter)->GetWindowBoundsInScreen().y();\n+        reposition_target_.y() - (*iter)->GetWindowBoundsInScreen().y();\n     for (; ; --iter) {\n       gfx::Rect bounds((*iter)->GetWindowBoundsInScreen());\n       bounds.set_y(bounds.y() + slide_length);\n@@ -359,16 +364,14 @@ void MessagePopupCollection::OnNotificationRemoved(\n     return;\n \n   views::Widget* widget = iter->second->GetWidget();\n-  gfx::Rect removed_bounds = widget->GetWindowBoundsInScreen();\n+  if (by_user)\n+    reposition_target_ = widget->GetWindowBoundsInScreen();\n   widget->RemoveObserver(this);\n   widget->Close();\n   widgets_.erase(std::find(widgets_.begin(), widgets_.end(), widget));\n   toasts_.erase(iter);\n   bool widgets_went_empty = widgets_.empty();\n-  if (by_user)\n-    RepositionWidgetsWithTarget(removed_bounds);\n-  else\n-    RepositionWidgets();\n+  RepositionWidgets();\n \n   // A notification removal may create extra space which allows appearing\n   // other notifications.\n@@ -378,7 +381,7 @@ void MessagePopupCollection::OnNotificationRemoved(\n   // other notifications appearing, the newly created widgets also have to be\n   // repositioned.\n   if (by_user && widgets_went_empty)\n-    RepositionWidgetsWithTarget(removed_bounds);\n+    RepositionWidgets();\n }\n \n void MessagePopupCollection::OnNotificationUpdated(","disapproval":false,"date":"2013-04-22 16:34:14.632060","approval":false},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/mukai@chromium.org/13846004/38001","disapproval":false,"date":"2013-04-22 16:44:05.849750","approval":false},{"sender":"commit-bot@chromium.org","recipients":["mukai@chromium.org","dewittj@chromium.org","dharcourt@chromium.org","chromium-reviews@chromium.org"],"text":"Change committed as 195561","disapproval":false,"date":"2013-04-22 18:56:57.958690","approval":false}],"owner_email":"mukai@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"Jun Mukai","subject":"Remembers the current reposition target.","created":"2013-04-19 21:59:04.354500","patchsets":[1,25001,38001],"modified":"2013-04-22 18:56:58.155390","closed":true,"commit":false,"issue":13846004}