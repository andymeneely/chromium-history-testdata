{"description":"cc: Fix flaky readback+forced draw tests\n\nIt's possible that the failed draw will trigger\nother draw attempts before the readback/forced draw\narrive on the Impl thread. This patch avoids performing\nfollowup events multiple times when that happens.\n\nBUG=287893\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=222307","cc":["chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"reviewers":["enne@chromium.org","danakj@chromium.org"],"messages":[{"sender":"brianderson@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"","disapproval":false,"date":"2013-09-09 21:20:18.096830","approval":false},{"sender":"brianderson@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"Fixed formatting issues. ptal.","disapproval":false,"date":"2013-09-09 21:22:03.118470","approval":false},{"sender":"danakj@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"https://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc\nFile cc/trees/layer_tree_host_unittest.cc (right):\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode512\ncc/trees/layer_tree_host_unittest.cc:512: static const int kForcedDrawCommitSourceFrameNumber = 2;\nnit: s/Commit//\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode533\ncc/trees/layer_tree_host_unittest.cc:533: kReadbackReplacementCommitSourceFrameNumber)\nthese must be a superset of the frames that we DrawLayers. so how about just kForcedDrawSFNumber here and delete this ReadbackReplacementCommitNumber constant?\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode541\ncc/trees/layer_tree_host_unittest.cc:541: did_react_to_first_commit_ = true;\nnit: did_post_readback_\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode595\ncc/trees/layer_tree_host_unittest.cc:595: EXPECT_TRUE(host_impl->active_tree()->source_frame_number() ==\nnit: put the source_frame_number in a temp var to make this EXPECT statement prettier/less line-wrappy?\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode606\ncc/trees/layer_tree_host_unittest.cc:606: if (host_impl->active_tree()->source_frame_number() ==\nWhy can't we return false always here?\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest_context.cc\nFile cc/trees/layer_tree_host_unittest_context.cc (right):\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest_context.cc#newcode1505\ncc/trees/layer_tree_host_unittest_context.cc:1505: : did_react_to_first_commit_(false) {}\nnit: did_post_readback_\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest_context.cc#newcode1538\ncc/trees/layer_tree_host_unittest_context.cc:1538: return true;\nwhy can't we always return false here?","disapproval":false,"date":"2013-09-09 22:13:58.525460","approval":false},{"sender":"brianderson@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"https://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc\nFile cc/trees/layer_tree_host_unittest.cc (right):\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode512\ncc/trees/layer_tree_host_unittest.cc:512: static const int kForcedDrawCommitSourceFrameNumber = 2;\nOn 2013/09/09 22:13:58, danakj wrote:\n> nit: s/Commit//\n\nDone.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode533\ncc/trees/layer_tree_host_unittest.cc:533: kReadbackReplacementCommitSourceFrameNumber)\nOn 2013/09/09 22:13:58, danakj wrote:\n> these must be a superset of the frames that we DrawLayers. so how about just\n> kForcedDrawSFNumber here and delete this ReadbackReplacementCommitNumber\n> constant?\n\nI did this on purpose to emphasize that they are the same commit.  I could just put a comment in there or combine the variable names.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode541\ncc/trees/layer_tree_host_unittest.cc:541: did_react_to_first_commit_ = true;\nOn 2013/09/09 22:13:58, danakj wrote:\n> nit: did_post_readback_\n\nDone.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode595\ncc/trees/layer_tree_host_unittest.cc:595: EXPECT_TRUE(host_impl->active_tree()->source_frame_number() ==\nOn 2013/09/09 22:13:58, danakj wrote:\n> nit: put the source_frame_number in a temp var to make this EXPECT statement\n> prettier/less line-wrappy?\n\nDone.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode606\ncc/trees/layer_tree_host_unittest.cc:606: if (host_impl->active_tree()->source_frame_number() ==\nOn 2013/09/09 22:13:58, danakj wrote:\n> Why can't we return false always here?\n\nWe can always return false, but we only need it for the first frame to initiate the forced draw. I guess returning false always is a good way to test that the readback and forced draw still occur even if we return false though.  I will change all of the tests to return false like they did before this patch.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest_context.cc\nFile cc/trees/layer_tree_host_unittest_context.cc (right):\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest_context.cc#newcode1505\ncc/trees/layer_tree_host_unittest_context.cc:1505: : did_react_to_first_commit_(false) {}\nOn 2013/09/09 22:13:58, danakj wrote:\n> nit: did_post_readback_\n\nDone.","disapproval":false,"date":"2013-09-09 22:34:20.770070","approval":false},{"sender":"brianderson@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"https://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc\nFile cc/trees/layer_tree_host_unittest.cc (right):\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode512\ncc/trees/layer_tree_host_unittest.cc:512: static const int kForcedDrawCommitSourceFrameNumber = 2;\nOn 2013/09/09 22:13:58, danakj wrote:\n> nit: s/Commit//\n\nDone.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode533\ncc/trees/layer_tree_host_unittest.cc:533: kReadbackReplacementCommitSourceFrameNumber)\nOn 2013/09/09 22:13:58, danakj wrote:\n> these must be a superset of the frames that we DrawLayers. so how about just\n> kForcedDrawSFNumber here and delete this ReadbackReplacementCommitNumber\n> constant?\n\nI did this on purpose to emphasize that they are the same commit.  I could just put a comment in there or combine the variable names.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode541\ncc/trees/layer_tree_host_unittest.cc:541: did_react_to_first_commit_ = true;\nOn 2013/09/09 22:13:58, danakj wrote:\n> nit: did_post_readback_\n\nDone.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode595\ncc/trees/layer_tree_host_unittest.cc:595: EXPECT_TRUE(host_impl->active_tree()->source_frame_number() ==\nOn 2013/09/09 22:13:58, danakj wrote:\n> nit: put the source_frame_number in a temp var to make this EXPECT statement\n> prettier/less line-wrappy?\n\nDone.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest.cc#newcode606\ncc/trees/layer_tree_host_unittest.cc:606: if (host_impl->active_tree()->source_frame_number() ==\nOn 2013/09/09 22:13:58, danakj wrote:\n> Why can't we return false always here?\n\nWe can always return false, but we only need it for the first frame to initiate the forced draw. I guess returning false always is a good way to test that the readback and forced draw still occur even if we return false though.  I will change all of the tests to return false like they did before this patch.\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest_context.cc\nFile cc/trees/layer_tree_host_unittest_context.cc (right):\n\nhttps://codereview.chromium.org/23542014/diff/8001/cc/trees/layer_tree_host_unittest_context.cc#newcode1505\ncc/trees/layer_tree_host_unittest_context.cc:1505: : did_react_to_first_commit_(false) {}\nOn 2013/09/09 22:13:58, danakj wrote:\n> nit: did_post_readback_\n\nDone.","disapproval":false,"date":"2013-09-09 22:34:20.862130","approval":false},{"sender":"brianderson@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"Addressed comments.\n\nI've been having trouble with the trybots failing to apply my patches. This is my first patch uploaded from a new checkout - hopefully the trybots like it this time.","disapproval":false,"date":"2013-09-09 22:51:42.419630","approval":false},{"sender":"danakj@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"LGTM","disapproval":false,"date":"2013-09-10 15:13:22.621350","approval":true},{"sender":"commit-bot@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/brianderson@chromium.org/23542014/18001","disapproval":false,"date":"2013-09-10 15:14:10.759310","approval":false},{"sender":"commit-bot@chromium.org","recipients":["brianderson@chromium.org","enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","rouslan@chromium.org","fgorski@chromium.org"],"text":"Change committed as 222307","disapproval":false,"date":"2013-09-10 18:06:13.517780","approval":false}],"owner_email":"brianderson@chromium.org","private":false,"base_url":"http://git.chromium.org/chromium/src.git@master","owner":"Brian Anderson","subject":"cc: Fix flaky readback+forced draw tests","created":"2013-09-09 21:19:15.258430","patchsets":[1,5001,8001,14001,18001],"modified":"2013-09-10 18:06:13.898840","closed":true,"commit":false,"issue":23542014}