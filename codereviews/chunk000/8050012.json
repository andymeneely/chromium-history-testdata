{"description":"\novda: fix the issue in calling destroy() after reset() \n\nWhen destroy() is called after reset(), there is an initiation\n of invalid state change, from LOADED to EXECUTE.\nFixed the same.\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=103475","cc":["chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"reviewers":["vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","commit-bot@chromium.org"],"messages":[{"sender":"ashokm@nvidia.com","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"The issue can be reproducible in the two ways:\nrepro steps:\n1) open youtube \n2) Open any video from youtube \n3) while playback, refresh the page by clicking on refresh icon \n4) This reloads the video from beginning.\nBut this sequence of events also initiating an invalid state transition, LOADED to EXECUTE from OVDA.\n\nThe other way::\n1) open youtube \n2) Open any video from youtube \n3) while playback, in search box, search something. \n4) This leads to search results. \nAnd also these steps causes the specified issue.","disapproval":false,"date":"2011-09-27 12:59:42.736674","approval":false},{"sender":"fischman@chromium.org","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"http://codereview.chromium.org/8050012/diff/4001/content/common/gpu/media/omx_video_decode_accelerator.cc\nFile content/common/gpu/media/omx_video_decode_accelerator.cc (right):\n\nhttp://codereview.chromium.org/8050012/diff/4001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode425\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:425: void OmxVideoDecodeAccelerator::OutputPortFlushDone() {\nCan you add a test for the bug you're fixing (i.e. repros the problem before your .cc change, works after your .cc change).\n\nhttp://codereview.chromium.org/8050012/diff/4001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode428\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:428: if (current_state_change_ == RESETTING)\nIMO this conditional is quite unclear.\nI think it makes a lot more sense to put it at the callsite for OutputPortFlushDone() where it's clearer that the alternative is DESTROYING.\n\nhttp://codereview.chromium.org/8050012/diff/4001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode904\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:904: InputPortFlushDone();\nNote that this contains the same kind of latent bug.\nInstead I think line 903 wants to have a:\nif (current_state_change_ == DESTROYING)\n  return;\npreceding the data2 checks.","disapproval":false,"date":"2011-09-27 15:41:44.145903","approval":false},{"sender":"ashokm@nvidia.com","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"Ami,\nThis fix is for the below issue:\nDuring reset(), after making call FlushIOPorts(), if the destroy() is called, there is an invalid state transtion attempt from OVDA, LOADED to EXECUTE.\n\nThe test case TearDownTiming/4 tests the case--destroy() after reset(). \nBut with this test case, before getting the state complete event for EXEC to PAUSE state transition, \ndestroy() is getting called, and this is taken care in function DispatchStateReached()-line no 852.\n\nSo, even with queuing the more inpuytbuffers, \nthat is by increasig the num_in_flight_decodes to 10, \nthis specific case is not hitting.\n\nhttp://codereview.chromium.org/8050012/diff/4001/content/common/gpu/media/omx_video_decode_accelerator.cc\nFile content/common/gpu/media/omx_video_decode_accelerator.cc (right):\n\nhttp://codereview.chromium.org/8050012/diff/4001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode425\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:425: void OmxVideoDecodeAccelerator::OutputPortFlushDone() {\nPlease see my reply comment.\n\nOn 2011/09/27 15:41:44, Ami Fischman wrote:\n> Can you add a test for the bug you're fixing (i.e. repros the problem before\n> your .cc change, works after your .cc change).\n\nhttp://codereview.chromium.org/8050012/diff/4001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode428\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:428: if (current_state_change_ == RESETTING)\nOn 2011/09/27 15:41:44, Ami Fischman wrote:\n> IMO this conditional is quite unclear.\n> I think it makes a lot more sense to put it at the callsite for\n> OutputPortFlushDone() where it's clearer that the alternative is DESTROYING.\n\nDone.\n\nhttp://codereview.chromium.org/8050012/diff/4001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode904\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:904: InputPortFlushDone();\nOn 2011/09/27 15:41:44, Ami Fischman wrote:\n> Note that this contains the same kind of latent bug.\n> Instead I think line 903 wants to have a:\n> if (current_state_change_ == DESTROYING)\n>   return;\n> preceding the data2 checks.\n\nDone.","disapproval":false,"date":"2011-09-28 16:33:41.010734","approval":false},{"sender":"fischman@chromium.org","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"http://codereview.chromium.org/8050012/diff/6001/content/common/gpu/media/omx_video_decode_accelerator.cc\nFile content/common/gpu/media/omx_video_decode_accelerator.cc (right):\n\nhttp://codereview.chromium.org/8050012/diff/6001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode900\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:900: if (current_state_change_ == DESTROYING)\nI wonder whether changing the SetState(CS_RESETTING); call in EglRenderingVDAClient::NotifyFlushDone() to instead post the same call from a callback in the message loop would surface this bug and demonstrate the fix.\n\nI take it that you can repro the bug at will manually and that this fixes it?\n\nhttp://codereview.chromium.org/8050012/diff/6001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode903\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:903: current_state_change_ == DESTROYING);\nSince you put the if before the DCHECK, this line is no longer necessary.","disapproval":false,"date":"2011-09-28 23:40:52.210194","approval":false},{"sender":"ashokm@nvidia.com","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"http://codereview.chromium.org/8050012/diff/6001/content/common/gpu/media/omx_video_decode_accelerator.cc\nFile content/common/gpu/media/omx_video_decode_accelerator.cc (right):\n\nhttp://codereview.chromium.org/8050012/diff/6001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode900\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:900: if (current_state_change_ == DESTROYING)\nI can repro the issue from flash player (Youtube site)  with the steps given in my first comment.\nThis change has fixed the issue. \n\nOn 2011/09/28 23:40:52, Ami Fischman wrote:\n> I wonder whether changing the SetState(CS_RESETTING); call in\n> EglRenderingVDAClient::NotifyFlushDone() to instead post the same call from a\n> callback in the message loop would surface this bug and demonstrate the fix.\n> \n> I take it that you can repro the bug at will manually and that this fixes it?\n\nhttp://codereview.chromium.org/8050012/diff/6001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode903\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:903: current_state_change_ == DESTROYING);\nOn 2011/09/28 23:40:52, Ami Fischman wrote:\n> Since you put the if before the DCHECK, this line is no longer necessary.\n\nDone.","disapproval":false,"date":"2011-09-29 05:34:37.923061","approval":false},{"sender":"fischman@chromium.org","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"http://codereview.chromium.org/8050012/diff/6001/content/common/gpu/media/omx_video_decode_accelerator.cc\nFile content/common/gpu/media/omx_video_decode_accelerator.cc (right):\n\nhttp://codereview.chromium.org/8050012/diff/6001/content/common/gpu/media/omx_video_decode_accelerator.cc#newcode903\ncontent/common/gpu/media/omx_video_decode_accelerator.cc:903: current_state_change_ == DESTROYING);\nOn 2011/09/29 05:34:38, ashok wrote:\n> On 2011/09/28 23:40:52, Ami Fischman wrote:\n> > Since you put the if before the DCHECK, this line is no longer necessary.\n> \n> Done.\n\nI meant that the _line_ I commented on (==DESTROYING) was no longer necessary; it's still useful to keep the previous line (==RESETTING).","disapproval":false,"date":"2011-09-29 17:45:54.047250","approval":false},{"sender":"ashokm@nvidia.com","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"I should have understand it correctly.\nSorry for the misunderstanding.","disapproval":false,"date":"2011-09-30 04:52:52.449980","approval":false},{"sender":"fischman@chromium.org","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"lgtm","disapproval":false,"date":"2011-09-30 15:27:11.227661","approval":true},{"sender":"commit-bot@chromium.org","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","commit-bot@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"CQ is trying tha patch. Follow status at\nhttps://chromium-status.appspot.com/cq/ashokm@nvidia.com/8050012/12001","disapproval":false,"date":"2011-09-30 15:27:15.205981","approval":false},{"sender":"commit-bot@chromium.org","recipients":["ashokm@nvidia.com","vhiremath@nvidia.com","vjain@nvidia.com","fischman@chromium.org","commit-bot@chromium.org","chromium-reviews@chromium.org","hclam+watch@chromium.org","ddorwin+watch@chromium.org","fischman+watch@chromium.org","jam@chromium.org","dpranke+watch-content@chromium.org","acolwell+watch@chromium.org","annacc+watch@chromium.org","apatrick@chromium.org","joi+watch-content@chromium.org","darin-cc@chromium.org","ajwong+watch@chromium.org","vrk@chromium.org","scherkus@chromium.org"],"text":"Change committed as 103475","disapproval":false,"date":"2011-09-30 16:39:44.321527","approval":false}],"owner_email":"ashokm@nvidia.com","private":false,"base_url":"http://src.chromium.org/svn/trunk/src/","owner":"ashok","subject":"ovda: fix the destroy after reset","created":"2011-09-27 12:50:47.109304","patchsets":[1,3001,4001,6001,9001,12001],"modified":"2011-09-30 16:39:44.742603","closed":true,"commit":false,"issue":8050012}