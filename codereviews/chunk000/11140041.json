{"description":"Fix black wallpaper issue when quickly select a bunch of wallpapers\r\n\r\n\r\nBUG=155631, 156542\r\nTEST=\r\n(1) Open \"set wallpaper\" dialog.\r\n(2) Go to the solid colors section.\r\n(3) Quickly click on a color, then on another, then on another.\r\n\r\ndesktop background should not stuck in a black wallpaper.\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=163464","cc":["chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"reviewers":["oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org"],"messages":[{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"Hi guys:\n\nCould you please take a look at this?\nBasically, I found the following two cases that are interesting:\n1. When I select two different wallpapers really quick(using keyboard arrow key), OnImplicitAnimationsCompleted() get called twice as described in comment 13 http://code.google.com/p/chromium/issues/detail?id=155631. And I saw the black wallpaper while a different color is selected.\n2. When I select two different wallpapers moderately quick(click one and then wait for 1s and then click another)(Note I set animation duration to 2s for testing purpose). OnImplicitAnimationsCompleted() only get called once and the wallpaper is consistent with the one selected in wallpaper picker.\nForm the above, it seems closing the widget in kAnimatingDesktopController may or maynot stop its animation. The condition to stop animation is not clear to me. vollick@ any thought?\nBut it looks like \"delete this\" could make sure OnImplicitAnimationsCompleted is not called for closed widget.","disapproval":false,"date":"2012-10-15 23:57:37.767560","approval":false},{"sender":"hshi@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"http://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc#newcode75\nash/desktop_background/desktop_background_view.cc:75: delete this;\nWhy does deleting \"this\" prevent it from being called? \n\nAt line 70 we're already removing this from observers list, shouldn't it prevent future calls to OnImplicitAnimationsCompleted() from ui::LayerAnimationSequence::NotifyEnded()?","disapproval":false,"date":"2012-10-16 00:21:26.289260","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"http://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc#newcode75\nash/desktop_background/desktop_background_view.cc:75: delete this;\nI am guessing OnImplicitAnimationsCompleted() is called by ui::ImplicitAnimationObserver? So removing it from widget observer may not prevent it get called. After deleting \"this\", the ui::ImplicitAnimationObserver became invalid somehow?\n\nOn 2012/10/16 00:21:26, hshi1 wrote:\n> Why does deleting \"this\" prevent it from being called? \n> \n> At line 70 we're already removing this from observers list, shouldn't it prevent\n> future calls to OnImplicitAnimationsCompleted() from\n> ui::LayerAnimationSequence::NotifyEnded()?","disapproval":false,"date":"2012-10-16 00:45:59.264870","approval":false},{"sender":"vollick@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"https://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttps://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc#newcode75\nash/desktop_background/desktop_background_view.cc:75: delete this;\nOn 2012/10/16 00:45:59, bshe wrote:\n> I am guessing OnImplicitAnimationsCompleted() is called by\n> ui::ImplicitAnimationObserver? So removing it from widget observer may not\n> prevent it get called. After deleting \"this\", the ui::ImplicitAnimationObserver\n> became invalid somehow?\n> \n> On 2012/10/16 00:21:26, hshi1 wrote:\n> > Why does deleting \"this\" prevent it from being called? \n> > \n> > At line 70 we're already removing this from observers list, shouldn't it\n> prevent\n> > future calls to OnImplicitAnimationsCompleted() from\n> > ui::LayerAnimationSequence::NotifyEnded()?\n> \nThe ShowWallpaperAnimationObserver is both an animation and a widget observer. The call on line 70 stops this instance from observing the widget, but it is still registered with the animation controller. If we 'delete this' code in ~LayerAnimationObserver will ensure that we stop listening to any *running* animations, but this is not a silver bullet! The observer's destructor does not detach it from any layer animators, so it's quite possible that we could be attached to another animation after we've called 'delete this' leading to crashes, etc. I actually think this is buggy behavior (I've logged http://code.google.com/p/chromium/issues/detail?id=156071 to track this), but in the meantime, I would suggest preceding the 'delete this' line with desktop_widget_->...->layer()->GetAnimator()->RemoveObserver(this)","disapproval":false,"date":"2012-10-16 13:29:32.060640","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"On 2012/10/16 13:29:32, vollick wrote:\n> https://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc\n> File ash/desktop_background/desktop_background_view.cc (right):\n> \n> https://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc#newcode75\n> ash/desktop_background/desktop_background_view.cc:75: delete this;\n> On 2012/10/16 00:45:59, bshe wrote:\n> > I am guessing OnImplicitAnimationsCompleted() is called by\n> > ui::ImplicitAnimationObserver? So removing it from widget observer may not\n> > prevent it get called. After deleting \"this\", the\n> ui::ImplicitAnimationObserver\n> > became invalid somehow?\n> > \n> > On 2012/10/16 00:21:26, hshi1 wrote:\n> > > Why does deleting \"this\" prevent it from being called? \n> > > \n> > > At line 70 we're already removing this from observers list, shouldn't it\n> > prevent\n> > > future calls to OnImplicitAnimationsCompleted() from\n> > > ui::LayerAnimationSequence::NotifyEnded()?\n> > \n> The ShowWallpaperAnimationObserver is both an animation and a widget observer.\n> The call on line 70 stops this instance from observing the widget, but it is\n> still registered with the animation controller. If we 'delete this' code in\n> ~LayerAnimationObserver will ensure that we stop listening to any *running*\n> animations, but this is not a silver bullet! The observer's destructor does not\n> detach it from any layer animators, so it's quite possible that we could be\n> attached to another animation after we've called 'delete this' leading to\n> crashes, etc. I actually think this is buggy behavior (I've logged\n> http://code.google.com/p/chromium/issues/detail?id=156071 to track this), but in\n> the meantime, I would suggest preceding the 'delete this' line with\n> desktop_widget_->...->layer()->GetAnimator()->RemoveObserver(this)\n\nSomehow the problem is still reproducable after I change delete this to desktop_widget_->...->layer()->GetAnimator()->RemoveObserver(this). This maybe a tricky bug.","disapproval":false,"date":"2012-10-16 14:05:59.782170","approval":false},{"sender":"vollick@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"On 2012/10/16 14:05:59, bshe wrote:\n> On 2012/10/16 13:29:32, vollick wrote:\n> >\n> https://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc\n> > File ash/desktop_background/desktop_background_view.cc (right):\n> > \n> >\n> https://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc#newcode75\n> > ash/desktop_background/desktop_background_view.cc:75: delete this;\n> > On 2012/10/16 00:45:59, bshe wrote:\n> > > I am guessing OnImplicitAnimationsCompleted() is called by\n> > > ui::ImplicitAnimationObserver? So removing it from widget observer may not\n> > > prevent it get called. After deleting \"this\", the\n> > ui::ImplicitAnimationObserver\n> > > became invalid somehow?\n> > > \n> > > On 2012/10/16 00:21:26, hshi1 wrote:\n> > > > Why does deleting \"this\" prevent it from being called? \n> > > > \n> > > > At line 70 we're already removing this from observers list, shouldn't it\n> > > prevent\n> > > > future calls to OnImplicitAnimationsCompleted() from\n> > > > ui::LayerAnimationSequence::NotifyEnded()?\n> > > \n> > The ShowWallpaperAnimationObserver is both an animation and a widget observer.\n> > The call on line 70 stops this instance from observing the widget, but it is\n> > still registered with the animation controller. If we 'delete this' code in\n> > ~LayerAnimationObserver will ensure that we stop listening to any *running*\n> > animations, but this is not a silver bullet! The observer's destructor does\n> not\n> > detach it from any layer animators, so it's quite possible that we could be\n> > attached to another animation after we've called 'delete this' leading to\n> > crashes, etc. I actually think this is buggy behavior (I've logged\n> > http://code.google.com/p/chromium/issues/detail?id=156071 to track this), but\n> in\n> > the meantime, I would suggest preceding the 'delete this' line with\n> > desktop_widget_->...->layer()->GetAnimator()->RemoveObserver(this)\n> \n> Somehow the problem is still reproducable after I change delete this to\n> desktop_widget_->...->layer()->GetAnimator()->RemoveObserver(this). This maybe a\n> tricky bug.\n\nActually, I'm suggesting that you do _both_. The 'delete this' is part of the solution (it will detach you from running animations), and detaching from the layer animation will prevent you from being attached to any new ones.","disapproval":false,"date":"2012-10-16 14:29:30.145330","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"I see. Sorry. I misread it. I add it before 'delete this'. Could you take another look?\n\nOn 2012/10/16 14:29:30, vollick wrote:\n> On 2012/10/16 14:05:59, bshe wrote:\n> > On 2012/10/16 13:29:32, vollick wrote:\n> > >\n> >\n> https://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc\n> > > File ash/desktop_background/desktop_background_view.cc (right):\n> > > \n> > >\n> >\n> https://codereview.chromium.org/11140041/diff/1003/ash/desktop_background/desktop_background_view.cc#newcode75\n> > > ash/desktop_background/desktop_background_view.cc:75: delete this;\n> > > On 2012/10/16 00:45:59, bshe wrote:\n> > > > I am guessing OnImplicitAnimationsCompleted() is called by\n> > > > ui::ImplicitAnimationObserver? So removing it from widget observer may not\n> > > > prevent it get called. After deleting \"this\", the\n> > > ui::ImplicitAnimationObserver\n> > > > became invalid somehow?\n> > > > \n> > > > On 2012/10/16 00:21:26, hshi1 wrote:\n> > > > > Why does deleting \"this\" prevent it from being called? \n> > > > > \n> > > > > At line 70 we're already removing this from observers list, shouldn't it\n> > > > prevent\n> > > > > future calls to OnImplicitAnimationsCompleted() from\n> > > > > ui::LayerAnimationSequence::NotifyEnded()?\n> > > > \n> > > The ShowWallpaperAnimationObserver is both an animation and a widget\n> observer.\n> > > The call on line 70 stops this instance from observing the widget, but it is\n> > > still registered with the animation controller. If we 'delete this' code in\n> > > ~LayerAnimationObserver will ensure that we stop listening to any *running*\n> > > animations, but this is not a silver bullet! The observer's destructor does\n> > not\n> > > detach it from any layer animators, so it's quite possible that we could be\n> > > attached to another animation after we've called 'delete this' leading to\n> > > crashes, etc. I actually think this is buggy behavior (I've logged\n> > > http://code.google.com/p/chromium/issues/detail?id=156071 to track this),\n> but\n> > in\n> > > the meantime, I would suggest preceding the 'delete this' line with\n> > > desktop_widget_->...->layer()->GetAnimator()->RemoveObserver(this)\n> > \n> > Somehow the problem is still reproducable after I change delete this to\n> > desktop_widget_->...->layer()->GetAnimator()->RemoveObserver(this). This maybe\n> a\n> > tricky bug.\n> \n> Actually, I'm suggesting that you do _both_. The 'delete this' is part of the\n> solution (it will detach you from running animations), and detaching from the\n> layer animation will prevent you from being attached to any new ones.","disapproval":false,"date":"2012-10-16 14:44:44.448030","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"+sky for OWNERS\n\nThanks!","disapproval":false,"date":"2012-10-16 15:14:13.155840","approval":false},{"sender":"vollick@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"LGTM\n\nhttp://codereview.chromium.org/11140041/diff/10001/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/10001/ash/desktop_background/desktop_background_view.cc#newcode71\nash/desktop_background/desktop_background_view.cc:71: desktop_widget_->GetNativeView()->layer()->GetAnimator()->\nPlease add a comment to this line mentioning that it is required because of this bug http://code.google.com/p/chromium/issues/detail?id=156071","disapproval":false,"date":"2012-10-16 15:20:35.745290","approval":true},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"thanks for review.\n\nhttp://codereview.chromium.org/11140041/diff/10001/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/10001/ash/desktop_background/desktop_background_view.cc#newcode71\nash/desktop_background/desktop_background_view.cc:71: desktop_widget_->GetNativeView()->layer()->GetAnimator()->\nOn 2012/10/16 15:20:36, vollick wrote:\n> Please add a comment to this line mentioning that it is required because of this\n> bug http://code.google.com/p/chromium/issues/detail?id=156071\n\nDone.","disapproval":false,"date":"2012-10-16 16:13:16.895290","approval":false},{"sender":"vollick@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"On 2012/10/16 16:13:16, bshe wrote:\n> thanks for review.\n> \n> http://codereview.chromium.org/11140041/diff/10001/ash/desktop_background/desktop_background_view.cc\n> File ash/desktop_background/desktop_background_view.cc (right):\n> \n> http://codereview.chromium.org/11140041/diff/10001/ash/desktop_background/desktop_background_view.cc#newcode71\n> ash/desktop_background/desktop_background_view.cc:71:\n> desktop_widget_->GetNativeView()->layer()->GetAnimator()->\n> On 2012/10/16 15:20:36, vollick wrote:\n> > Please add a comment to this line mentioning that it is required because of\n> this\n> > bug http://code.google.com/p/chromium/issues/detail?id=156071\n> \n> Done.\n\nIt looks like the linux_chromeos failures are real. Looks like some nullity checks are required when you try to get at the layer animator.","disapproval":false,"date":"2012-10-16 16:47:33.242820","approval":false},{"sender":"sky@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttps://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode71\nash/desktop_background/desktop_background_view.cc:71: // Remove observer from layer animator is needed here because of issue\nComments should describe why code is the way it is. You shouldn't have to go to a bug to figure out it. Document the issue here.\n\nhttps://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode75\nash/desktop_background/desktop_background_view.cc:75: desktop_widget_ = NULL;\nCan you remove 75 and 70 now so that the destructor does the cleanup?\n\nhttps://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode76\nash/desktop_background/desktop_background_view.cc:76: // OnImplicitAnimationsCompleted may get called even if the widget it is\nHow does the code in OnImplicitAnimationsCompleted() get run if you delete this here?\n\nhttps://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc\nFile ash/wm/window_animations.cc (left):\n\nhttps://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc#oldcode252\nash/wm/window_animations.cc:252: window->layer()->SetVisible(true);\nHow was this code ever working? Wouldn't this mean all windows didn't show anything until the animation was done?","disapproval":false,"date":"2012-10-16 17:38:36.000170","approval":false},{"sender":"oshima@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"Sorry for the delay. I was OOO yesterday.\n\nI haven't looked into the logic yet, but ash_shell crashes with this patch (ash_shell --aura-host-window-size=100+100-500x500,100+700-1000x800)\n\n\n#0  0x00007ffff675e41d in ash::internal::(anonymous namespace)::ShowWallpaperAnimationObserver::OnWidgetClosing (this=0x7fffddd953f0, widget=0x7fffddda4780)\n    at ../../ash/desktop_background/desktop_background_view.cc:79\n#1  0x00007ffff6536a34 in views::Widget::OnNativeWidgetDestroying (this=0x7fffddda4780)\n    at ../../ui/views/widget/widget.cc:991\n#2  0x00007ffff653072d in views::NativeWidgetAura::OnWindowDestroying (this=0x7fffde7ec630)\n    at ../../ui/views/widget/native_widget_aura.cc:743\n#3  0x00007ffff7f04e63 in aura::Window::~Window (this=0x7fffddd97700, __in_chrg=<optimized out>)\n    at ../../ui/aura/window.cc:85\n#4  0x00007ffff7f05530 in aura::Window::~Window (this=0x7fffddd97700, __in_chrg=<optimized out>)\n    at ../../ui/aura/window.cc:150\n#5  0x00007ffff652f598 in views::NativeWidgetAura::CloseNow (this=0x7fffde7ec630)\n    at ../../ui/views/widget/native_widget_aura.cc:449\n#6  0x00007ffff65352a7 in views::Widget::CloseNow (this=0x7fffddda4780)\n    at ../../ui/views/widget/widget.cc:541\n#7  0x00007ffff675f2c0 in ash::internal::DesktopBackgroundWidgetController::~DesktopBackgroundWidgetController (this=0x7fffdddafca0, __in_chrg=<optimized out>)\n    at ../../ash/desktop_background/desktop_background_widget_controller.cc:39\n#8  0x00007ffff675f34c in ash::internal::DesktopBackgroundWidgetController::~DesktopBackgroundWidgetController (this=0x7fffdddafca0, __in_chrg=<optimized out>)\n    at ../../ash/desktop_background/desktop_background_widget_controller.cc:43\n#9  0x00007ffff675f75f in scoped_ptr<ash::internal::DesktopBackgroundWidgetController>::~scoped_ptr\n    (this=0x7fffddd75830, __in_chrg=<optimized out>) at ../../base/memory/scoped_ptr.h:163\n#10 0x00007ffff675f552 in ash::internal::AnimatingDesktopController::~AnimatingDesktopController (\n    this=0x7fffddd75830, __in_chrg=<optimized out>)\n    at ../../ash/desktop_background/desktop_background_widget_controller.cc:80\n#11 0x00007ffff675f0db in ash::internal::(anonymous namespace)::DeallocatorkAnimatingDesktopController (p=140736915265584) at ../../ash/desktop_background/desktop_background_widget_controller.cc:22\n#12 0x00007ffff675d17d in aura::Window::SetProperty<ash::internal::AnimatingDesktopController*> (\n    this=0x7fffe5598b10, \n    property=0x7ffff68daf20 <ash::internal::(anonymous namespace)::kAnimatingDesktopController_Value>, value=0x7fffddd75be0) at ../../ui/aura/window_property.h:91\n#13 0x00007ffff675c495 in ash::DesktopBackgroundController::InstallDesktopController (\n    this=0x7fffe55787c0, root_window=0x7fffe5598b00)\n    at ../../ash/desktop_background/desktop_background_controller.cc:335\n#14 0x00007ffff675c4e8 in ash::DesktopBackgroundController::InstallDesktopControllerForAllWindows (\n    this=0x7fffe55787c0) at ../../ash/desktop_background/desktop_background_controller.cc:342\n#15 0x00007ffff675c03f in ash::DesktopBackgroundController::SetDesktopBackgroundImageMode (\n    this=0x7fffe55787c0) at ../../ash/desktop_background/desktop_background_controller.cc:270\n#16 0x00007ffff675c09a in ash::DesktopBackgroundController::OnWallpaperLoadCompleted (\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nOn 2012/10/16 17:38:36, sky wrote:\n> https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc\n> File ash/desktop_background/desktop_background_view.cc (right):\n> \n> https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode71\n> ash/desktop_background/desktop_background_view.cc:71: // Remove observer from\n> layer animator is needed here because of issue\n> Comments should describe why code is the way it is. You shouldn't have to go to\n> a bug to figure out it. Document the issue here.\n> \n> https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode75\n> ash/desktop_background/desktop_background_view.cc:75: desktop_widget_ = NULL;\n> Can you remove 75 and 70 now so that the destructor does the cleanup?\n> \n> https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode76\n> ash/desktop_background/desktop_background_view.cc:76: //\n> OnImplicitAnimationsCompleted may get called even if the widget it is\n> How does the code in OnImplicitAnimationsCompleted() get run if you delete this\n> here?\n> \n> https://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc\n> File ash/wm/window_animations.cc (left):\n> \n> https://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc#oldcode252\n> ash/wm/window_animations.cc:252: window->layer()->SetVisible(true);\n> How was this code ever working? Wouldn't this mean all windows didn't show\n> anything until the animation was done?","disapproval":false,"date":"2012-10-16 17:50:18.223530","approval":false},{"sender":"oshima@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"http://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode74\nash/desktop_background/desktop_background_view.cc:74: RemoveObserver(this);\nLooks like animator doesn't seem to have *this* observer (see my comment below) and it's failing to remove it, yet the observer gets called at the end, which leads to the crash.\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode196\nash/desktop_background/desktop_background_view.cc:196: desktop_widget->GetNativeView()->layer()->GetAnimator());\nDoing this while there is animation may be causing the issue? Won't this override and delete current animation, and/or causes inconsistency?","disapproval":false,"date":"2012-10-16 22:32:50.850780","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"On 2012/10/16 17:50:18, oshima wrote:\n> Sorry for the delay. I was OOO yesterday.\n> \n> I haven't looked into the logic yet, but ash_shell crashes with this patch\n> (ash_shell --aura-host-window-size=100+100-500x500,100+700-1000x800)\n> \n> \n> #0  0x00007ffff675e41d in ash::internal::(anonymous\n> namespace)::ShowWallpaperAnimationObserver::OnWidgetClosing\n> (this=0x7fffddd953f0, widget=0x7fffddda4780)\n>     at ../../ash/desktop_background/desktop_background_view.cc:79\n> #1  0x00007ffff6536a34 in views::Widget::OnNativeWidgetDestroying\n> (this=0x7fffddda4780)\n>     at ../../ui/views/widget/widget.cc:991\n> #2  0x00007ffff653072d in views::NativeWidgetAura::OnWindowDestroying\n> (this=0x7fffde7ec630)\n>     at ../../ui/views/widget/native_widget_aura.cc:743\n> #3  0x00007ffff7f04e63 in aura::Window::~Window (this=0x7fffddd97700,\n> __in_chrg=<optimized out>)\n>     at ../../ui/aura/window.cc:85\n> #4  0x00007ffff7f05530 in aura::Window::~Window (this=0x7fffddd97700,\n> __in_chrg=<optimized out>)\n>     at ../../ui/aura/window.cc:150\n> #5  0x00007ffff652f598 in views::NativeWidgetAura::CloseNow\n> (this=0x7fffde7ec630)\n>     at ../../ui/views/widget/native_widget_aura.cc:449\n> #6  0x00007ffff65352a7 in views::Widget::CloseNow (this=0x7fffddda4780)\n>     at ../../ui/views/widget/widget.cc:541\n> #7  0x00007ffff675f2c0 in\n> ash::internal::DesktopBackgroundWidgetController::~DesktopBackgroundWidgetController\n> (this=0x7fffdddafca0, __in_chrg=<optimized out>)\n>     at ../../ash/desktop_background/desktop_background_widget_controller.cc:39\n> #8  0x00007ffff675f34c in\n> ash::internal::DesktopBackgroundWidgetController::~DesktopBackgroundWidgetController\n> (this=0x7fffdddafca0, __in_chrg=<optimized out>)\n>     at ../../ash/desktop_background/desktop_background_widget_controller.cc:43\n> #9  0x00007ffff675f75f in\n> scoped_ptr<ash::internal::DesktopBackgroundWidgetController>::~scoped_ptr\n>     (this=0x7fffddd75830, __in_chrg=<optimized out>) at\n> ../../base/memory/scoped_ptr.h:163\n> #10 0x00007ffff675f552 in\n> ash::internal::AnimatingDesktopController::~AnimatingDesktopController (\n>     this=0x7fffddd75830, __in_chrg=<optimized out>)\n>     at ../../ash/desktop_background/desktop_background_widget_controller.cc:80\n> #11 0x00007ffff675f0db in ash::internal::(anonymous\n> namespace)::DeallocatorkAnimatingDesktopController (p=140736915265584) at\n> ../../ash/desktop_background/desktop_background_widget_controller.cc:22\n> #12 0x00007ffff675d17d in\n> aura::Window::SetProperty<ash::internal::AnimatingDesktopController*> (\n>     this=0x7fffe5598b10, \n>     property=0x7ffff68daf20 <ash::internal::(anonymous\n> namespace)::kAnimatingDesktopController_Value>, value=0x7fffddd75be0) at\n> ../../ui/aura/window_property.h:91\n> #13 0x00007ffff675c495 in\n> ash::DesktopBackgroundController::InstallDesktopController (\n>     this=0x7fffe55787c0, root_window=0x7fffe5598b00)\n>     at ../../ash/desktop_background/desktop_background_controller.cc:335\n> #14 0x00007ffff675c4e8 in\n> ash::DesktopBackgroundController::InstallDesktopControllerForAllWindows (\n>     this=0x7fffe55787c0) at\n> ../../ash/desktop_background/desktop_background_controller.cc:342\n> #15 0x00007ffff675c03f in\n> ash::DesktopBackgroundController::SetDesktopBackgroundImageMode (\n>     this=0x7fffe55787c0) at\n> ../../ash/desktop_background/desktop_background_controller.cc:270\n> #16 0x00007ffff675c09a in\n> ash::DesktopBackgroundController::OnWallpaperLoadCompleted (\n> \n> \n> \n> \n> \n> \n> \n> \n> \n> \n> \n> \n> \n> \n> On 2012/10/16 17:38:36, sky wrote:\n> >\n> https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc\n> > File ash/desktop_background/desktop_background_view.cc (right):\n> > \n> >\n> https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode71\n> > ash/desktop_background/desktop_background_view.cc:71: // Remove observer from\n> > layer animator is needed here because of issue\n> > Comments should describe why code is the way it is. You shouldn't have to go\n> to\n> > a bug to figure out it. Document the issue here.\n> > \n> >\n> https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode75\n> > ash/desktop_background/desktop_background_view.cc:75: desktop_widget_ = NULL;\n> > Can you remove 75 and 70 now so that the destructor does the cleanup?\n> > \n> >\n> https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode76\n> > ash/desktop_background/desktop_background_view.cc:76: //\n> > OnImplicitAnimationsCompleted may get called even if the widget it is\n> > How does the code in OnImplicitAnimationsCompleted() get run if you delete\n> this\n> > here?\n> > \n> >\n> https://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc\n> > File ash/wm/window_animations.cc (left):\n> > \n> >\n> https://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc#oldcode252\n> > ash/wm/window_animations.cc:252: window->layer()->SetVisible(true);\n> > How was this code ever working? Wouldn't this mean all windows didn't show\n> > anything until the animation was done?\n\nIt looks like this crash is the same as the crash in interactive_ui_tests. The problem was 'delete this' is executed twice in function OnWidgetClosing. When we remove the observer from animator, it will call function CheckCompleted in ImplicitAnimationObserver. And that function will call OnImplicitAnimationsComplete if no sequence is attached to the observer. Inside OnImplicitAnimationsComplete, we will execute 'delete this'. That's the first time. Then after we removed the observer, we execute 'delete this' again at the end of OnWidgetClosing. It caused the crash.\n\nSince I dont see the crash when I test my patch in chromeos build, I assume 'delete this' is not called when removing observer from animator. And the function to determine if 'delete this' maybe called is \"\n111|void ImplicitAnimationObserver::CheckCompleted() {\n112│   if (active_ && attached_sequences().empty()) {\n113│     active_ = false;\n114├>    OnImplicitAnimationsCompleted();\n115│   }\n116│ }\n\"\nI am not sure why in interactive_ui_tests and ash_shell the check is true. I will dig more. vollick@ do you have any input on this?","disapproval":false,"date":"2012-10-17 00:05:01.255170","approval":false},{"sender":"oshima@chromium.org","recipients":["reply@chromiumcodereview-hr.appspotmail.com"],"text":"On Tue, Oct 16, 2012 at 5:05 PM, <bshe@chromium.org> wrote:\r\n\r\n> On 2012/10/16 17:50:18, oshima wrote:\r\n>\r\n>> Sorry for the delay. I was OOO yesterday.\r\n>>\r\n>\r\n>  I haven't looked into the logic yet, but ash_shell crashes with this patch\r\n>> (ash_shell --aura-host-window-size=100+**100-500x500,100+700-1000x800)\r\n>>\r\n>\r\n>\r\n>  #0  0x00007ffff675e41d in ash::internal::(anonymous\r\n>> namespace)::**ShowWallpaperAnimationObserver**::OnWidgetClosing\r\n>> (this=0x7fffddd953f0, widget=0x7fffddda4780)\r\n>>      at ../../ash/desktop_background/**desktop_background_view.cc:79\r\n>> #1  0x00007ffff6536a34 in views::Widget::**OnNativeWidgetDestroying\r\n>> (this=0x7fffddda4780)\r\n>>      at ../../ui/views/widget/widget.**cc:991\r\n>> #2  0x00007ffff653072d in views::NativeWidgetAura::**OnWindowDestroying\r\n>> (this=0x7fffde7ec630)\r\n>>      at ../../ui/views/widget/native_**widget_aura.cc:743\r\n>> #3  0x00007ffff7f04e63 in aura::Window::~Window (this=0x7fffddd97700,\r\n>> __in_chrg=<optimized out>)\r\n>>      at ../../ui/aura/window.cc:85\r\n>> #4  0x00007ffff7f05530 in aura::Window::~Window (this=0x7fffddd97700,\r\n>> __in_chrg=<optimized out>)\r\n>>      at ../../ui/aura/window.cc:150\r\n>> #5  0x00007ffff652f598 in views::NativeWidgetAura::**CloseNow\r\n>> (this=0x7fffde7ec630)\r\n>>      at ../../ui/views/widget/native_**widget_aura.cc:449\r\n>> #6  0x00007ffff65352a7 in views::Widget::CloseNow (this=0x7fffddda4780)\r\n>>      at ../../ui/views/widget/widget.**cc:541\r\n>> #7  0x00007ffff675f2c0 in\r\n>>\r\n>\r\n> ash::internal::**DesktopBackgroundWidgetControl**ler::~**\r\n> DesktopBackgroundWidgetControl**ler\r\n>\r\n>> (this=0x7fffdddafca0, __in_chrg=<optimized out>)\r\n>>      at ../../ash/desktop_background/**desktop_background_widget_**\r\n>> controller.cc:39\r\n>> #8  0x00007ffff675f34c in\r\n>>\r\n>\r\n> ash::internal::**DesktopBackgroundWidgetControl**ler::~**\r\n> DesktopBackgroundWidgetControl**ler\r\n>\r\n>> (this=0x7fffdddafca0, __in_chrg=<optimized out>)\r\n>>      at ../../ash/desktop_background/**desktop_background_widget_**\r\n>> controller.cc:43\r\n>> #9  0x00007ffff675f75f in\r\n>> scoped_ptr<ash::internal::**DesktopBackgroundWidgetControl**\r\n>> ler>::~scoped_ptr\r\n>>      (this=0x7fffddd75830, __in_chrg=<optimized out>) at\r\n>> ../../base/memory/scoped_ptr.**h:163\r\n>> #10 0x00007ffff675f552 in\r\n>> ash::internal::**AnimatingDesktopController::~**AnimatingDesktopController\r\n>> (\r\n>>      this=0x7fffddd75830, __in_chrg=<optimized out>)\r\n>>      at ../../ash/desktop_background/**desktop_background_widget_**\r\n>> controller.cc:80\r\n>> #11 0x00007ffff675f0db in ash::internal::(anonymous\r\n>> namespace)::**DeallocatorkAnimatingDesktopCo**ntroller\r\n>> (p=140736915265584) at\r\n>> ../../ash/desktop_background/**desktop_background_widget_**\r\n>> controller.cc:22\r\n>> #12 0x00007ffff675d17d in\r\n>> aura::Window::SetProperty<ash:**:internal::**AnimatingDesktopController*>\r\n>> (\r\n>>      this=0x7fffe5598b10,\r\n>>      property=0x7ffff68daf20 <ash::internal::(anonymous\r\n>> namespace)::**kAnimatingDesktopController_**Value>,\r\n>> value=0x7fffddd75be0) at\r\n>> ../../ui/aura/window_property.**h:91\r\n>> #13 0x00007ffff675c495 in\r\n>> ash::**DesktopBackgroundController::**InstallDesktopController (\r\n>>      this=0x7fffe55787c0, root_window=0x7fffe5598b00)\r\n>>      at ../../ash/desktop_background/**desktop_background_controller.**\r\n>> cc:335\r\n>> #14 0x00007ffff675c4e8 in\r\n>> ash::**DesktopBackgroundController::**InstallDesktopControllerForAll**Windows\r\n>> (\r\n>>      this=0x7fffe55787c0) at\r\n>> ../../ash/desktop_background/**desktop_background_controller.**cc:342\r\n>> #15 0x00007ffff675c03f in\r\n>> ash::**DesktopBackgroundController::**SetDesktopBackgroundImageMode (\r\n>>      this=0x7fffe55787c0) at\r\n>> ../../ash/desktop_background/**desktop_background_controller.**cc:270\r\n>> #16 0x00007ffff675c09a in\r\n>> ash::**DesktopBackgroundController::**OnWallpaperLoadCompleted (\r\n>>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>\r\n>  On 2012/10/16 17:38:36, sky wrote:\r\n>> >\r\n>>\r\n>\r\n> https://codereview.chromium.**org/11140041/diff/13002/ash/**\r\n> desktop_background/desktop_**background_view.cc<https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc>\r\n>\r\n>> > File ash/desktop_background/**desktop_background_view.cc (right):\r\n>> >\r\n>> >\r\n>>\r\n>\r\n> https://codereview.chromium.**org/11140041/diff/13002/ash/**\r\n> desktop_background/desktop_**background_view.cc#newcode71<https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode71>\r\n>\r\n>> > ash/desktop_background/**desktop_background_view.cc:71: // Remove\r\n>> observer\r\n>>\r\n> from\r\n>\r\n>> > layer animator is needed here because of issue\r\n>> > Comments should describe why code is the way it is. You shouldn't have\r\n>> to go\r\n>> to\r\n>> > a bug to figure out it. Document the issue here.\r\n>> >\r\n>> >\r\n>>\r\n>\r\n> https://codereview.chromium.**org/11140041/diff/13002/ash/**\r\n> desktop_background/desktop_**background_view.cc#newcode75<https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode75>\r\n>\r\n>> > ash/desktop_background/**desktop_background_view.cc:75:\r\n>> desktop_widget_ =\r\n>>\r\n> NULL;\r\n>\r\n>> > Can you remove 75 and 70 now so that the destructor does the cleanup?\r\n>> >\r\n>> >\r\n>>\r\n>\r\n> https://codereview.chromium.**org/11140041/diff/13002/ash/**\r\n> desktop_background/desktop_**background_view.cc#newcode76<https://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode76>\r\n>\r\n>> > ash/desktop_background/**desktop_background_view.cc:76: //\r\n>> > OnImplicitAnimationsCompleted may get called even if the widget it is\r\n>> > How does the code in OnImplicitAnimationsCompleted(**) get run if you\r\n>> delete\r\n>> this\r\n>> > here?\r\n>> >\r\n>> >\r\n>>\r\n>\r\n> https://codereview.chromium.**org/11140041/diff/13002/ash/**\r\n> wm/window_animations.cc<https://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc>\r\n>\r\n>> > File ash/wm/window_animations.cc (left):\r\n>> >\r\n>> >\r\n>>\r\n>\r\n> https://codereview.chromium.**org/11140041/diff/13002/ash/**\r\n> wm/window_animations.cc#**oldcode252<https://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc#oldcode252>\r\n>\r\n>> > ash/wm/window_animations.cc:**252: window->layer()->SetVisible(**true);\r\n>> > How was this code ever working? Wouldn't this mean all windows didn't\r\n>> show\r\n>> > anything until the animation was done?\r\n>>\r\n>\r\n> It looks like this crash is the same as the crash in interactive_ui_tests.\r\n> The\r\n> problem was 'delete this' is executed twice in function OnWidgetClosing.\r\n> When we\r\n> remove the observer from animator, it will call function CheckCompleted in\r\n> ImplicitAnimationObserver. And that function will call\r\n> OnImplicitAnimationsComplete if no sequence is attached to the observer.\r\n> Inside\r\n> OnImplicitAnimationsComplete, we will execute 'delete this'. That's the\r\n> first\r\n> time. Then after we removed the observer, we execute 'delete this' again\r\n> at the\r\n> end of OnWidgetClosing. It caused the crash.\r\n>\r\n> Since I dont see the crash when I test my patch in chromeos build, I assume\r\n> 'delete this' is not called when removing observer from animator. And the\r\n> function to determine if 'delete this' maybe called is \"\r\n> 111|void ImplicitAnimationObserver::**CheckCompleted() {\r\n> 112│   if (active_ && attached_sequences().empty()) {\r\n> 113│     active_ = false;\r\n> 114├>    OnImplicitAnimationsCompleted(**);\r\n> 115│   }\r\n> 116│ }\r\n> \"\r\n> I am not sure why in interactive_ui_tests and ash_shell the check is true.\r\n> I\r\n\r\nwill dig more. vollick@ do you have any input on this?\r\n>\r\n>\r\nYou probably missed my latest comments.\r\n\r\n\r\n\r\n> http://codereview.chromium.**org/11140041/<http://codereview.chromium.org/11140041/>\r\n>\r\n","disapproval":false,"date":"2012-10-17 00:09:58.495420","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"I have uploaded a new patch. Could you guys please take another look? Thanks!\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode71\nash/desktop_background/desktop_background_view.cc:71: // Remove observer from layer animator is needed here because of issue\nAfter discussed with vollick, it seems using StopObservingImplicitAnimations is a better alternative. And moved it in destructor.\n\nOn 2012/10/16 17:38:36, sky wrote:\n> Comments should describe why code is the way it is. You shouldn't have to go to\n> a bug to figure out it. Document the issue here.\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode74\nash/desktop_background/desktop_background_view.cc:74: RemoveObserver(this);\nIt looks like the animator have *this* observer. It is just when we remove *this* observer, we call OnImplicitAnimationsCompleted. It then execute 'delete this'. And after removed the observer, we then execute 'delete this' again in line 79. The second call to 'delete this' caused the crash.\n\nOn 2012/10/16 22:32:51, oshima wrote:\n> Looks like animator doesn't seem to have *this* observer (see my comment below)\n> and it's failing to remove it, yet the observer gets called at the end, which\n> leads to the crash.\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode75\nash/desktop_background/desktop_background_view.cc:75: desktop_widget_ = NULL;\nKeep it since I dont use 'delete this' here anymore.\n\nOn 2012/10/16 17:38:36, sky wrote:\n> Can you remove 75 and 70 now so that the destructor does the cleanup?\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode76\nash/desktop_background/desktop_background_view.cc:76: // OnImplicitAnimationsCompleted may get called even if the widget it is\nI originally want to prevent OnImplicitAnimationsCompleted from being run when widget closed. So I use 'delete this' here.\nIt can fix the black screen problem. But after discussion with vollick, it seems make sure it got run all the time is a better option. Please see my latest patch.\nPreviously, OnImplicitAnimationsCompleted may or maynot run when user switches wallpaper really fast.\n\nOn 2012/10/16 17:38:36, sky wrote:\n> How does the code in OnImplicitAnimationsCompleted() get run if you delete this\n> here?\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/desktop_background/desktop_background_view.cc#newcode196\nash/desktop_background/desktop_background_view.cc:196: desktop_widget->GetNativeView()->layer()->GetAnimator());\nI am not sure if it override and delete current animation. vollick@ may have better answer?\n\nIf you are referring the crash issue here. It should not because of this since the latest patch do not crash ash_shell.\n\nOn 2012/10/16 22:32:51, oshima wrote:\n> Doing this while there is animation may be causing the issue? Won't this\n> override and delete current animation, and/or causes inconsistency?\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc\nFile ash/wm/window_animations.cc (left):\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc#oldcode252\nash/wm/window_animations.cc:252: window->layer()->SetVisible(true);\nThis is suggested by vollick@. It seems it is doing the opposite as you describe. If we keep it in this scope, the window didn't show anything until animation was done.\n\nOn 2012/10/16 17:38:36, sky wrote:\n> How was this code ever working? Wouldn't this mean all windows didn't show\n> anything until the animation was done?","disapproval":false,"date":"2012-10-17 17:40:41.361040","approval":false},{"sender":"oshima@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"http://codereview.chromium.org/11140041/diff/15003/ash/desktop_background/desktop_background_controller.cc\nFile ash/desktop_background/desktop_background_controller.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/15003/ash/desktop_background/desktop_background_controller.cc#newcode336\nash/desktop_background/desktop_background_controller.cc:336: if (animatingController && animatingController->GetController(false) &&\nit's calling GetController(false) three times. can you do\n\nControllerType* controller = animatingController ? ... : NULL;\nif (controller & controller->widget()) {\n\nhttp://codereview.chromium.org/11140041/diff/15003/ash/wm/system_gesture_event_filter.cc\nFile ash/wm/system_gesture_event_filter.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/15003/ash/wm/system_gesture_event_filter.cc#newcode67\nash/wm/system_gesture_event_filter.cc:67: Shell::GetInstance()->delegate()) {\nwhen this can be NULL?","disapproval":false,"date":"2012-10-17 21:53:53.589060","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"Done. Thanks for review.\n\nhttp://codereview.chromium.org/11140041/diff/15003/ash/desktop_background/desktop_background_controller.cc\nFile ash/desktop_background/desktop_background_controller.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/15003/ash/desktop_background/desktop_background_controller.cc#newcode336\nash/desktop_background/desktop_background_controller.cc:336: if (animatingController && animatingController->GetController(false) &&\nOn 2012/10/17 21:53:53, oshima wrote:\n> it's calling GetController(false) three times. can you do\n> \n> ControllerType* controller = animatingController ? ... : NULL;\n> if (controller & controller->widget()) {\n\nDone.\n\nhttp://codereview.chromium.org/11140041/diff/15003/ash/wm/system_gesture_event_filter.cc\nFile ash/wm/system_gesture_event_filter.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/15003/ash/wm/system_gesture_event_filter.cc#newcode67\nash/wm/system_gesture_event_filter.cc:67: Shell::GetInstance()->delegate()) {\nThis comes out when I try to debug the failing interactive_ui_tests.\nWhen we setup interactive_ui_tests, such as MenuItemViewTestBase, we also setup ViewEventTestBase. And in that function, if we have defined 'ash', shell is created with a null delegate.\nhttp://code.google.com/searchframe#OAMlx_jo-ck/src/chrome/test/base/view_event_test_base.cc&exact_package=chromium&q=view_event_test_base.cc&type=cs&l=89\n\nThe reason it didn't fail on build bots is because no touch device is attached. However, I have a touch screen hooked up on my desktop, it reveals the crash.\n\nOn 2012/10/17 21:53:53, oshima wrote:\n> when this can be NULL?","disapproval":false,"date":"2012-10-17 22:19:09.485540","approval":false},{"sender":"oshima@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"lgtm with nits\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_controller.cc\nFile ash/desktop_background/desktop_background_controller.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_controller.cc#newcode351\nash/desktop_background/desktop_background_controller.cc:351: // experience.\nadd reference to bug.\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_view.cc#newcode55\nash/desktop_background/desktop_background_view.cc:55: shell->user_wallpaper_delegate()->OnWallpaperAnimationFinished();\nUgh, these are wrong. Can you add \n// TODO(oshima): fix this for extended desktop.\nbefore shell->GetPrimaryRoot....\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_view.cc#newcode65\nash/desktop_background/desktop_background_view.cc:65: // move it to kDesktopController.\n|| around desktop_widget_ like |desktop_widget_|.","disapproval":false,"date":"2012-10-17 22:35:28.264270","approval":true},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"Done. Thanks!\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_controller.cc\nFile ash/desktop_background/desktop_background_controller.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_controller.cc#newcode351\nash/desktop_background/desktop_background_controller.cc:351: // experience.\nOn 2012/10/17 22:35:28, oshima wrote:\n> add reference to bug.\n\nDone.\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_view.cc#newcode55\nash/desktop_background/desktop_background_view.cc:55: shell->user_wallpaper_delegate()->OnWallpaperAnimationFinished();\nOn 2012/10/17 22:35:28, oshima wrote:\n> Ugh, these are wrong. Can you add \n> // TODO(oshima): fix this for extended desktop.\n> before shell->GetPrimaryRoot....\n\nDone.\n\nhttp://codereview.chromium.org/11140041/diff/12004/ash/desktop_background/desktop_background_view.cc#newcode65\nash/desktop_background/desktop_background_view.cc:65: // move it to kDesktopController.\nOn 2012/10/17 22:35:28, oshima wrote:\n> || around desktop_widget_ like |desktop_widget_|.\n\nDone.","disapproval":false,"date":"2012-10-18 03:13:50.845510","approval":false},{"sender":"sky@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"Please add a test for coverage.","disapproval":false,"date":"2012-10-18 17:05:17.829080","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"On 2012/10/18 17:05:17, sky wrote:\n> Please add a test for coverage.\n\nAdded a unit_tests. Could you please take another look? Thanks!","disapproval":false,"date":"2012-10-18 18:24:53.562700","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"On 2012/10/18 18:24:53, bshe wrote:\n> On 2012/10/18 17:05:17, sky wrote:\n> > Please add a test for coverage.\n> \n> Added a unit_tests. Could you please take another look? Thanks!\n\nping in case this buried. sky@ could you please take a look? Thanks!","disapproval":false,"date":"2012-10-19 19:31:58.179670","approval":false},{"sender":"sky@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"I think this shows that using properties to track all the interdependant background classes proves error prone. I think this code would be clearer if DesktopBackgroundController maintained a map RootWindow->SomeOtherController. This other controller would maintain the necessary state for said RootWindow.\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc\nFile ash/desktop_background/desktop_background_controller.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc#newcode334\nash/desktop_background/desktop_background_controller.cc:334: internal::AnimatingDesktopController* animatingController =\nanimating_controller\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc#newcode339\nash/desktop_background/desktop_background_controller.cc:339: // Stops animation and calls OnImplicitAnimationsCompleted immediately if\nUse () when referring to functions/methods, eg OnImplicitAnimationsCompleted()\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc#newcode341\nash/desktop_background/desktop_background_controller.cc:341: // Note we have to call OnImplicitAnimationsCompleted before we set\nYou don't call OnImplicitAnimationsCompleted() here. I think you mean 'Not we have to make sure OnImpli.. is called before ..'\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc#newcode353\nash/desktop_background/desktop_background_controller.cc:353: StopAnimating();\nI think this should be a real method on AnimatingDesktopController?\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller_unittest.cc\nFile ash/desktop_background/desktop_background_controller_unittest.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller_unittest.cc#newcode181\nash/desktop_background/desktop_background_controller_unittest.cc:181: TEST_F(DesktopBackgroundControllerTest, ChangeWallpaperQuick) {\nAdd description of what this test is verifying.\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_view.cc#newcode67\nash/desktop_background/desktop_background_view.cc:67: DCHECK(controller->widget() == desktop_widget_);\nDCHECK_EQ\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/wm/window_animations.cc\nFile ash/wm/window_animations.cc (left):\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/wm/window_animations.cc#oldcode252\nash/wm/window_animations.cc:252: window->layer()->SetVisible(true);\nDid you see my earlier comment on this on:\n\n\"How was this code ever working? Wouldn't this mean all windows didn't show anything until the animation was done?\"","disapproval":false,"date":"2012-10-22 15:00:26.246530","approval":false},{"sender":"bshe@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"Thanks for review.\n\nI agree the current code is complicated and error prone. I will create a bug for further details/discussion and track the process.\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc\nFile ash/desktop_background/desktop_background_controller.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc#newcode334\nash/desktop_background/desktop_background_controller.cc:334: internal::AnimatingDesktopController* animatingController =\nOn 2012/10/22 15:00:26, sky wrote:\n> animating_controller\n\nDone.\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc#newcode339\nash/desktop_background/desktop_background_controller.cc:339: // Stops animation and calls OnImplicitAnimationsCompleted immediately if\nOn 2012/10/22 15:00:26, sky wrote:\n> Use () when referring to functions/methods, eg OnImplicitAnimationsCompleted()\n\nDone.\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc#newcode341\nash/desktop_background/desktop_background_controller.cc:341: // Note we have to call OnImplicitAnimationsCompleted before we set\nOn 2012/10/22 15:00:26, sky wrote:\n> You don't call OnImplicitAnimationsCompleted() here. I think you mean 'Not we\n> have to make sure OnImpli.. is called before ..'\n\nDone.\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller.cc#newcode353\nash/desktop_background/desktop_background_controller.cc:353: StopAnimating();\nAdded a StopAnimating method in AnimatingDesktopController.\n\nOn 2012/10/22 15:00:26, sky wrote:\n> I think this should be a real method on AnimatingDesktopController?\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller_unittest.cc\nFile ash/desktop_background/desktop_background_controller_unittest.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_controller_unittest.cc#newcode181\nash/desktop_background/desktop_background_controller_unittest.cc:181: TEST_F(DesktopBackgroundControllerTest, ChangeWallpaperQuick) {\nOn 2012/10/22 15:00:26, sky wrote:\n> Add description of what this test is verifying.\n\nDone.\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_view.cc\nFile ash/desktop_background/desktop_background_view.cc (right):\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/desktop_background/desktop_background_view.cc#newcode67\nash/desktop_background/desktop_background_view.cc:67: DCHECK(controller->widget() == desktop_widget_);\nOn 2012/10/22 15:00:26, sky wrote:\n> DCHECK_EQ\n\nDone.\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/wm/window_animations.cc\nFile ash/wm/window_animations.cc (left):\n\nhttp://codereview.chromium.org/11140041/diff/26006/ash/wm/window_animations.cc#oldcode252\nash/wm/window_animations.cc:252: window->layer()->SetVisible(true);\nYes. I saw your comment and I think I replied here: http://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc#oldcode252\nSorry for confusion. I mixed your comment with oshima's comment.\nvollick@ maybe a better person to provide more details about the reason we move it to outside.\n\nOn 2012/10/22 15:00:26, sky wrote:\n> Did you see my earlier comment on this on:\n> \n> \"How was this code ever working? Wouldn't this mean all windows didn't show\n> anything until the animation was done?\"","disapproval":false,"date":"2012-10-22 16:31:19.048080","approval":false},{"sender":"sky@chromium.org","recipients":["bshe@chromium.org","oshima@chromium.org","vollick@chromium.org","hshi@chromium.org","sky@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","ben+watch@chromium.org","hshi@chromium.org"],"text":"LGTM\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc\nFile ash/wm/window_animations.cc (left):\n\nhttp://codereview.chromium.org/11140041/diff/13002/ash/wm/window_animations.cc#oldcode252\nash/wm/window_animations.cc:252: window->layer()->SetVisible(true);\nOn 2012/10/17 17:40:41, bshe wrote:\n> This is suggested by vollick@. It seems it is doing the opposite as you\n> describe. If we keep it in this scope, the window didn't show anything until\n> animation was done.\n> \n> On 2012/10/16 17:38:36, sky wrote:\n> > How was this code ever working? Wouldn't this mean all windows didn't show\n> > anything until the animation was done?\n> \n\nI think the new code makes sense. What I was confused by was how it ever worked.","disapproval":false,"date":"2012-10-22 16:51:03.434640","approval":true}],"owner_email":"bshe@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"bshe","subject":"Fix black wallpaper issue when quickly select a bunch of wallpapers","created":"2012-10-15 22:10:49.972750","patchsets":[1,1003,10001,13002,20003,15003,12004,26005,26006,32001,30003],"modified":"2012-10-23 01:05:32.647680","closed":true,"commit":false,"issue":11140041}