{"description":"No longer display login when oauth token not available.\n\nNow always display sync config screen if sync is already configured. Changed app oauth flow to explicitly force the login screen via a special URL rather than having logic in SyncSetupHandler.\n\nChanged ProfileSyncService to stop listening to GAIA_SIGNIN_FAILED notifications and treating them as sync errors - this was causing infinite spin when using ASPs because ASP prompts look like auth errors.\n\nBUG=118533, 113552\nTEST=make sure app notification signin flow still works\n\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=127560","cc":["chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"reviewers":["sky@chromium.org","jhawkins@chromium.org","asargent@google.com","asargent@chromium.org","zea@chromium.org"],"messages":[{"sender":"atwilson@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"asargent: please look at browser/extensions for OWNERS approval\nsky: please take a look at change to browser/ui/browser.cc for OWNERS approval\njhawkins: browser/webui, browser/resources and also url_constants.cc/h please.\nzea: browser/sync\n\nThanks!","disapproval":false,"date":"2012-03-18 00:24:50.760233","approval":false},{"sender":"jhawkins@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"LGTM with nits, but I think we need to revisit the ShowLoginUI situation at some point.  If you agree, a todo would be good.\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/signin/login_ui_service.h\nFile chrome/browser/ui/webui/signin/login_ui_service.h (right):\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/signin/login_ui_service.h#newcode48\nchrome/browser/ui/webui/signin/login_ui_service.h:48: // to gather GAIA credentials for oauth tokens).\nI think we're reaching a fragile state with this method, but I don't have an idea for how to fix it.  fwiw the fragility has to do with the 'Does X if Y; otherwise Z' nature of this method.  With |force_login| the logic becomes more complicated.\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/sync_promo/sync_promo_handler.cc\nFile chrome/browser/ui/webui/sync_promo/sync_promo_handler.cc (right):\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/sync_promo/sync_promo_handler.cc#newcode228\nchrome/browser/ui/webui/sync_promo/sync_promo_handler.cc:228: OpenSyncSetup(true);\nDocument what true implies here.\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/sync_setup_handler.cc\nFile chrome/browser/ui/webui/sync_setup_handler.cc (right):\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/sync_setup_handler.cc#newcode703\nchrome/browser/ui/webui/sync_setup_handler.cc:703: OpenSyncSetup(false);\nDocument what false implies here.","disapproval":false,"date":"2012-03-18 02:22:14.150240","approval":true},{"sender":"atwilson@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"I'll have a better idea of all the callsites for ShowLoginUI() once I finish my in-progress refactoring, and we can figure out how we want to break it up at that point.\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/signin/login_ui_service.h\nFile chrome/browser/ui/webui/signin/login_ui_service.h (right):\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/signin/login_ui_service.h#newcode48\nchrome/browser/ui/webui/signin/login_ui_service.h:48: // to gather GAIA credentials for oauth tokens).\nSounds good to me. I'll add a TODO and follow up with you in email to figure out where we want to go with this.\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/sync_promo/sync_promo_handler.cc\nFile chrome/browser/ui/webui/sync_promo/sync_promo_handler.cc (right):\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/sync_promo/sync_promo_handler.cc#newcode228\nchrome/browser/ui/webui/sync_promo/sync_promo_handler.cc:228: OpenSyncSetup(true);\nOn 2012/03/18 02:22:14, James Hawkins wrote:\n> Document what true implies here.\nDone.\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/sync_setup_handler.cc\nFile chrome/browser/ui/webui/sync_setup_handler.cc (right):\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/ui/webui/sync_setup_handler.cc#newcode703\nchrome/browser/ui/webui/sync_setup_handler.cc:703: OpenSyncSetup(false);\nOn 2012/03/18 02:22:14, James Hawkins wrote:\n> Document what false implies here.\n\nDone.","disapproval":false,"date":"2012-03-18 03:17:01.926980","approval":false},{"sender":"dbeam@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"drive by comment on .js change, just FYI\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/resources/sync_setup_overlay.js\nFile chrome/browser/resources/sync_setup_overlay.js (right):\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/resources/sync_setup_overlay.js#newcode76\nchrome/browser/resources/sync_setup_overlay.js:76: var forceLogin = (document.location.hash == \"#forceLogin\");\nnit: ... only [use parentheses] where required by the syntax and semantics.\nhttp://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml#Parentheses\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/resources/sync_setup_overlay.js#newcode77\nchrome/browser/resources/sync_setup_overlay.js:77: var result = JSON.stringify({'forceLogin': forceLogin});\nwe already serialize objects to JSON and decode them when doing the message passing so you're double serializing whenever you do this, additionally you could probably just pass a boolean and convert to object or array later if necessary","disapproval":false,"date":"2012-03-18 21:55:43.905744","approval":false},{"sender":"atwilson@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"http://codereview.chromium.org/9724016/diff/4003/chrome/browser/resources/sync_setup_overlay.js\nFile chrome/browser/resources/sync_setup_overlay.js (right):\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/resources/sync_setup_overlay.js#newcode76\nchrome/browser/resources/sync_setup_overlay.js:76: var forceLogin = (document.location.hash == \"#forceLogin\");\nOn 2012/03/18 21:55:44, Dan Beam wrote:\n> nit: ... only [use parentheses] where required by the syntax and semantics.\n> http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml#Parentheses\n\nDone.\n\nhttp://codereview.chromium.org/9724016/diff/4003/chrome/browser/resources/sync_setup_overlay.js#newcode77\nchrome/browser/resources/sync_setup_overlay.js:77: var result = JSON.stringify({'forceLogin': forceLogin});\nOn 2012/03/18 21:55:44, Dan Beam wrote:\n> we already serialize objects to JSON and decode them when doing the message\n> passing so you're double serializing whenever you do this, additionally you\n> could probably just pass a boolean and convert to object or array later if\n> necessary\n\nWhen I try to do this, like so:\n didShowPage: function() {                                                    \n      var forceLogin = document.location.hash == \"#forceLogin\";                  \n      var result = {'forceLogin': forceLogin};                                   \n      chrome.send('SyncSetupAttachHandler', [result]);                           \n    },     \n\nI hit a DCHECK down in the webkit/glue code trying to marshal the parameters up to chromium:\n\n[28631:-1610357440:383651369584481:FATAL:cpp_variant.cc(245)] Check failed: fals\\\ne.                                                                               \nBacktrace:                                                                       \n        0   Chromium Framework                  0x06ce401f base::debug::StackTra\\\nce::StackTrace() + 63                                                            \n        1   Chromium Framework                  0x06ce3fbb base::debug::StackTra\\\nce::StackTrace() + 43                                                            \n        2   Chromium Framework                  0x06d337cc logging::LogMessage::\\\n~LogMessage() + 76                                                               \n        3   Chromium Framework                  0x06d322cb logging::LogMessage::\\\n~LogMessage() + 43                                                               \n        4   Chromium Framework                  0x073b2391 CppVariant::ToVector(\\\n) const + 1185                                                                   \n        5   Chromium Framework                  0x07eeced5 (anonymous namespace)\\\n::CreateValueFromCppVariant(CppVariant const&) + 325                             \n        6   Chromium Framework                  0x07eecf40 (anonymous namespace)\\\n::CreateValueFromCppVariant(CppVariant const&) + 432                             \n        7   Chromium Framework                  0x07eec905 WebUIBindings::Send(s\\\ntd::vector<CppVariant, std::allocator<CppVariant> > const&, CppVariant*) + 357   \n        8   Chromium Framework                  0x07eef18e base::internal::Runna\\\nbleAdapter<void (WebUIBindings::*)(std::vector<CppVariant, std::allocator<CppVar\\\niant> > const&, CppVariant*)>::Run(WebUIBindings*, std::vector<CppVariant, std::\\\nallocator<CppVariant> > const&, CppVariant* const&) + 190                        \n \nLooks like cpp_variant.cc expects the passed param to have a \"length\" attribute, and when it doesn't it hits NOTREACHED. Is there something different I have to do here?","disapproval":false,"date":"2012-03-19 04:11:31.124182","approval":false},{"sender":"sky@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"http://codereview.chromium.org/9724016/diff/2002/chrome/browser/ui/browser.cc\nFile chrome/browser/ui/browser.cc (right):\n\nhttp://codereview.chromium.org/9724016/diff/2002/chrome/browser/ui/browser.cc#newcode5646\nchrome/browser/ui/browser.cc:5646: profile()->GetOriginalProfile())->ShowLoginUI(false);\nWhen I look at code like this I have no idea what true/false means. It would be far more readable if you used an enum here.","disapproval":false,"date":"2012-03-19 15:15:30.679755","approval":false},{"sender":"asargent@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","asargent@chromium.org","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"chrome/browser/extensions/app_notify_channel_ui.cc LGTM\n\nI agree with Scott that an enum of something like FORCE_LOGIN / NO_FORCE_LOGIN would improve readability.","disapproval":false,"date":"2012-03-19 16:43:54.555900","approval":true},{"sender":"atwilson@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","asargent@chromium.org","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"On 2012/03/19 15:15:30, sky wrote:\n> When I look at code like this I have no idea what true/false means. It would be\n> far more readable if you used an enum here.\n\nI'd like to land as-is, with the understanding that I will refactor this API anyway post-M19 per http://crbug.com/118795. Is this acceptable to you, or must this be done in this CL?","disapproval":false,"date":"2012-03-19 19:40:31.862465","approval":false},{"sender":"sky@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","asargent@chromium.org","zea@chromium.org","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"Add a TODO then and LGTM","disapproval":false,"date":"2012-03-19 20:44:23.841476","approval":true},{"sender":"atwilson@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","asargent@chromium.org","zea@chromium.org","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"On 2012/03/19 20:44:23, sky wrote:\n> Add a TODO then and LGTM\nDone.","disapproval":false,"date":"2012-03-19 20:49:38.529832","approval":false},{"sender":"zea@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","asargent@chromium.org","zea@chromium.org","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"sync LGTM\n\nhttp://codereview.chromium.org/9724016/diff/2002/chrome/browser/ui/webui/sync_setup_handler.cc\nFile chrome/browser/ui/webui/sync_setup_handler.cc (right):\n\nhttp://codereview.chromium.org/9724016/diff/2002/chrome/browser/ui/webui/sync_setup_handler.cc#newcode1\nchrome/browser/ui/webui/sync_setup_handler.cc:1: // Copyright (c) 2011 The Chromium Authors. All rights reserved.\n2012","disapproval":false,"date":"2012-03-19 20:53:50.877617","approval":true},{"sender":"commit-bot@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","asargent@chromium.org","zea@chromium.org","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/atwilson@chromium.org/9724016/13002","disapproval":false,"date":"2012-03-19 20:58:33.283374","approval":false},{"sender":"commit-bot@chromium.org","recipients":["atwilson@chromium.org","sky@chromium.org","jhawkins@chromium.org","asargent@google.com","asargent@chromium.org","zea@chromium.org","chromium-reviews@chromium.org","nick@chromium.org","akalin@chromium.org","rsimha@chromium.org","mihaip+watch@chromium.org","aa@chromium.org","arv@chromium.org","tim@chromium.org"],"text":"Change committed as 127560","disapproval":false,"date":"2012-03-19 22:50:44.668646","approval":false}],"owner_email":"atwilson@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"Andrew T Wilson","subject":"No longer display login when oauth token not available.","created":"2012-03-17 04:48:19.591180","patchsets":[1,4003,2002,10001,13002],"modified":"2012-03-19 22:50:45.239226","closed":true,"commit":false,"issue":9724016}