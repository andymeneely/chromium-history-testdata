{"description":"Fix resource destruction in proxy\n\nThis ensures that the resource on the plugin side is destroyed before we send\nthe message to the host, so that it has a chance to do proper cleanup.\n\nAlso, fix Surface3D destruction that could cause a write-after-free.\n\nBUG=none\nTEST=go to youtube with out-of-process pepper flash. click on fullscreen.\nobserve no hang, no crash\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=80188","cc":["chromium-reviews@chromium.org"],"reviewers":["brettw@chromium.org"],"messages":[{"sender":"piman@chromium.org","recipients":["piman@chromium.org","brettw@chromium.org","chromium-reviews@chromium.org"],"text":"","disapproval":false,"date":"2011-04-01 04:01:26.858749","approval":false},{"sender":"brettw@chromium.org","recipients":["piman@chromium.org","brettw@chromium.org","chromium-reviews@chromium.org"],"text":"http://codereview.chromium.org/6771042/diff/1/ppapi/proxy/plugin_resource_tracker.cc\nFile ppapi/proxy/plugin_resource_tracker.cc (right):\n\nhttp://codereview.chromium.org/6771042/diff/1/ppapi/proxy/plugin_resource_tracker.cc#newcode124\nppapi/proxy/plugin_resource_tracker.cc:124: // re-entering. That way, when the destructor is called, it's out of the\nCan you give an example of when a destructor might be re-entrant?","disapproval":false,"date":"2011-04-01 05:23:53.384223","approval":false},{"sender":"piman@chromium.org","recipients":["piman@chromium.org","brettw@chromium.org","chromium-reviews@chromium.org"],"text":"http://codereview.chromium.org/6771042/diff/1/ppapi/proxy/plugin_resource_tracker.cc\nFile ppapi/proxy/plugin_resource_tracker.cc (right):\n\nhttp://codereview.chromium.org/6771042/diff/1/ppapi/proxy/plugin_resource_tracker.cc#newcode124\nppapi/proxy/plugin_resource_tracker.cc:124: // re-entering. That way, when the destructor is called, it's out of the\nOn 2011/04/01 05:23:53, brettw wrote:\n> Can you give an example of when a destructor might be re-entrant?\n\nThe case I'm worried about is ~Context3D destroying the command buffers, that does a Finish() before destroying (sync IPC), that ends up executing a pending SwapBuffers, that send back a SwapBuffersACK that would try to access the context through the map. \n\nTechnically, with the message unblock we added, it shouldn't happen today (the SwapBuffersAck would be delayed). But I want to future-proof it, the failure case would be bad (use after free) and difficult to debug - in case we find a better solution.","disapproval":false,"date":"2011-04-01 05:34:09.666868","approval":false},{"sender":"brettw@chromium.org","recipients":["piman@chromium.org","brettw@chromium.org","chromium-reviews@chromium.org"],"text":"LGTM","disapproval":false,"date":"2011-04-01 05:36:51.530602","approval":true}],"owner_email":"piman@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"piman","subject":"Fix resource destruction in proxy","created":"2011-04-01 04:01:00.818064","patchsets":[1],"modified":"2011-05-09 13:47:55.989592","closed":true,"commit":false,"issue":6771042}