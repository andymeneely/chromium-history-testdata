{"description":"Separate layer property pushes from tree structure syncs and clean up scrollbar layer pointers\n\nWe need sync the cc::Layer tree structure and layer properties to cc::LayerImpls\nat commit time. We track when properties and tree structure change and use that\nto decide whether to do a full tree sync or just a property push. This patch\nseparates the property push to always happen seperately from the tree sync.\n\nThe scrollbar and scroll layer pointer code needed a bit of cleanup to make this\nwork. Before this patch, the way that scrolling worked was during the scrollbar\npointer sync inside TreeSynchronizer::synchronizeTrees() was what actually\nupdated the scroll offsets as a side effect of setting the pointer values. This\npatch rejiggers things so the ScrollbarAnimationController maintains the scroll\nproperties at all times and the scrollbar layers pull values from their\ncontroller. As a bonus, this means changes to the scroll offset no longer need\na full tree sync - they just need a property push.\n\nThe scrollable bounds are also now pulled from the layer directly instead of the\nfirst child of a layer to avoid depending on properties updating in a specific\norder and be overall less hacky. This depends on webkit.org/b/106518\n\nBUG=169143\n\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=176540","cc":["chromium-reviews@chromium.org","cc-bugs@chromium.org","aelias@chromium.org"],"reviewers":["enne@chromium.org"],"messages":[{"sender":"jamesr@chromium.org","recipients":["jamesr@chromium.org","enne@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","aelias@chromium.org"],"text":"","disapproval":false,"date":"2013-01-10 23:30:08.856720","approval":false},{"sender":"enne@chromium.org","recipients":["jamesr@chromium.org","enne@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","aelias@chromium.org"],"text":"https://codereview.chromium.org/11821064/diff/1/cc/layer.cc\nFile cc/layer.cc (right):\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer.cc#newcode444\ncc/layer.cc:444: setNeedsCommit();\n\\o/\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_impl.cc\nFile cc/layer_impl.cc (right):\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_impl.cc#newcode771\ncc/layer_impl.cc:771: noteLayerPropertyChangedForSubtree();\nJust as a sanity check, the change in ordering of this function is irrelevant, you just wanted to group it by the actual property change, yeah?\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_tree_host.cc\nFile cc/layer_tree_host.cc (right):\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_tree_host.cc#newcode300\ncc/layer_tree_host.cc:300: syncTree->FindRootScrollLayer();\nWhy do you need to FindRootScrollLayer if you don't sync?\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/tree_synchronizer.cc\nFile cc/tree_synchronizer.cc (right):\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/tree_synchronizer.cc#newcode8\ncc/tree_synchronizer.cc:8: #include \"base/logging.h\"\n...","disapproval":false,"date":"2013-01-11 04:51:23.255270","approval":false},{"sender":"jamesr@chromium.org","recipients":["jamesr@chromium.org","enne@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","aelias@chromium.org"],"text":"https://codereview.chromium.org/11821064/diff/1/cc/layer_impl.cc\nFile cc/layer_impl.cc (right):\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_impl.cc#newcode771\ncc/layer_impl.cc:771: noteLayerPropertyChangedForSubtree();\nOn 2013/01/11 04:51:23, enne wrote:\n> Just as a sanity check, the change in ordering of this function is irrelevant,\n> you just wanted to group it by the actual property change, yeah?\n\nRight - want to keep the association between changing a property and noting it clear.\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_tree_host.cc\nFile cc/layer_tree_host.cc (right):\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_tree_host.cc#newcode300\ncc/layer_tree_host.cc:300: syncTree->FindRootScrollLayer();\nOn 2013/01/11 04:51:23, enne wrote:\n> Why do you need to FindRootScrollLayer if you don't sync?\n\nFindRoot...() depends on properties (most notably, LayerImpl::m_scrollable) which might have changed since last commit.\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/tree_synchronizer.cc\nFile cc/tree_synchronizer.cc (right):\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/tree_synchronizer.cc#newcode8\ncc/tree_synchronizer.cc:8: #include \"base/logging.h\"\nOn 2013/01/11 04:51:23, enne wrote:\n> ...\n\nI don't know how this compiled before.  The DCHECK_EQ()s didn't compile","disapproval":false,"date":"2013-01-11 05:07:57.762770","approval":false},{"sender":"enne@chromium.org","recipients":["jamesr@chromium.org","enne@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","aelias@chromium.org"],"text":"lgtm\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_tree_host.cc\nFile cc/layer_tree_host.cc (right):\n\nhttps://codereview.chromium.org/11821064/diff/1/cc/layer_tree_host.cc#newcode300\ncc/layer_tree_host.cc:300: syncTree->FindRootScrollLayer();\nOn 2013/01/11 05:07:57, jamesr wrote:\n> On 2013/01/11 04:51:23, enne wrote:\n> > Why do you need to FindRootScrollLayer if you don't sync?\n> \n> FindRoot...() depends on properties (most notably, LayerImpl::m_scrollable)\n> which might have changed since last commit.\n\nAha! Thanks.  :)","disapproval":false,"date":"2013-01-11 05:39:51.648960","approval":true},{"sender":"commit-bot@chromium.org","recipients":["jamesr@chromium.org","enne@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","aelias@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/jamesr@chromium.org/11821064/9001","disapproval":false,"date":"2013-01-11 22:57:47.665130","approval":false},{"sender":"commit-bot@chromium.org","recipients":["jamesr@chromium.org","enne@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org","aelias@chromium.org"],"text":"Change committed as 176540","disapproval":false,"date":"2013-01-12 16:34:56.081500","approval":false}],"owner_email":"jamesr@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"jamesr","subject":"Separate layer property pushes from tree structure syncs and clean up scrollbar layer pointers","created":"2013-01-10 23:29:30.079200","patchsets":[1,9001],"modified":"2013-01-12 16:34:56.544780","closed":true,"commit":false,"issue":11821064}