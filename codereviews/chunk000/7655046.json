{"description":"Linux: allow linking directly with Kerberos instead of using dlopen.\r\n\r\ndlopen is still the default for Google Chrome. This option\r\nis intended for Linux distro packagers.\r\n\r\nBUG=92689\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=98116","cc":["chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"reviewers":["cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","dpolukhin@chromium.org"],"messages":[{"sender":"phajdan.jr@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"","disapproval":false,"date":"2011-08-18 17:03:50.162265","approval":false},{"sender":"cbentzel@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org","wtc@chromium.org"],"text":"http://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.h\nFile net/http/http_auth_gssapi_posix.h (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.h#newcode9\nnet/http/http_auth_gssapi_posix.h:9: #include <gssapi.h>\nIs the third_party one included in the search path? Or is this using the system one always, and we assume that if you build without USE_KERBEROS that gssapi.h is installed?\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/mock_gssapi_library_posix.cc\nFile net/http/mock_gssapi_library_posix.cc (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/mock_gssapi_library_posix.cc#newcode281\nnet/http/mock_gssapi_library_posix.cc:281: *output_name = reinterpret_cast<gss_name_t>(output);\nNot a bad thing - but was this needed? \n\nThe gssapi.h header in net/third_party has it defined as a void*, and casts from void* to other types are allowed.\n\nAlso, this may need to be a static_cast rather than a reinterpret_cast\n\nhttp://stackoverflow.com/questions/310451/should-i-use-static-cast-or-reinterpret-cast-when-casting-a-void-to-whatever\n\nhttp://codereview.chromium.org/7655046/diff/1/net/net.gyp\nFile net/net.gyp (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/net.gyp#newcode10\nnet/net.gyp:10: 'linux_link_kerberos%': 0,\nShould linux be removed from the name?","disapproval":false,"date":"2011-08-18 21:21:17.853421","approval":false},{"sender":"phajdan.jr@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org","wtc@chromium.org"],"text":"http://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.h\nFile net/http/http_auth_gssapi_posix.h (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.h#newcode9\nnet/http/http_auth_gssapi_posix.h:9: #include <gssapi.h>\nOn 2011/08/18 21:21:17, cbentzel wrote:\n> Is the third_party one included in the search path? Or is this using the system\n> one always, and we assume that if you build without USE_KERBEROS that gssapi.h\n> is installed?\n\nThis is using the system one. When not using Kerberos we're not using this file.\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/mock_gssapi_library_posix.cc\nFile net/http/mock_gssapi_library_posix.cc (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/mock_gssapi_library_posix.cc#newcode281\nnet/http/mock_gssapi_library_posix.cc:281: *output_name = reinterpret_cast<gss_name_t>(output);\nOn 2011/08/18 21:21:17, cbentzel wrote:\n> Not a bad thing - but was this needed? \n> \n> The gssapi.h header in net/third_party has it defined as a void*, and casts from\n> void* to other types are allowed.\n> \n> Also, this may need to be a static_cast rather than a reinterpret_cast\n> \n> http://stackoverflow.com/questions/310451/should-i-use-static-cast-or-reinterpret-cast-when-casting-a-void-to-whatever\n> \n\nwhen using the system header static_cast doesn't work:\n\nnet/http/mock_gssapi_library_posix.cc:281: error: invalid static_cast from type ‘net::test::GssNameMockImpl*’ to type ‘gss_name_struct*’\n\nhttp://codereview.chromium.org/7655046/diff/1/net/net.gyp\nFile net/net.gyp (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/net.gyp#newcode10\nnet/net.gyp:10: 'linux_link_kerberos%': 0,\nOn 2011/08/18 21:21:17, cbentzel wrote:\n> Should linux be removed from the name? \n\nThis follows the convention used for gnome-keyring. I can update the name if you want.","disapproval":false,"date":"2011-08-18 23:30:32.266366","approval":false},{"sender":"wtc@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"Can we just always link with krb5-config --libs gssapi\ndirectly?  That'll simplify the code.","disapproval":false,"date":"2011-08-18 23:48:05.915120","approval":false},{"sender":"cbentzel@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"Evan - I'm not familiar enough with how we package/ship our Linux builds.\n\nCurrently for Kerberos authentication we dlopen/dlsym one of a few gssapi library names when we see a Negotiate header.\n\nPawel's changing this to be linked directly, specifically to help gentoo.\n\nShould we just take this approach for all Linux builds? My two concerns are that the gssapi libraries may not be installed on a system which wants to run Chrome, and will require another package dependency. Another is that it may have a small startup time cost for the majority of Linux users who never see a Negotiate authentication challenge.\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.h\nFile net/http/http_auth_gssapi_posix.h (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.h#newcode9\nnet/http/http_auth_gssapi_posix.h:9: #include <gssapi.h>\nOn 2011/08/18 23:30:32, Paweł Hajdan Jr. wrote:\n> On 2011/08/18 21:21:17, cbentzel wrote:\n> > Is the third_party one included in the search path? Or is this using the\n> system\n> > one always, and we assume that if you build without USE_KERBEROS that gssapi.h\n> > is installed?\n> \n> This is using the system one. When not using Kerberos we're not using this file.\n\nWhat I'm asking is whether all developer machines have a system level gssapi.h installed and on the include path, as well as all build bots. You may need to modify install-build-deps.sh. You should also remove net/third_party/gssapi/gssapi.h in this CL.\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/mock_gssapi_library_posix.cc\nFile net/http/mock_gssapi_library_posix.cc (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/mock_gssapi_library_posix.cc#newcode281\nnet/http/mock_gssapi_library_posix.cc:281: *output_name = reinterpret_cast<gss_name_t>(output);\nOn 2011/08/18 23:30:32, Paweł Hajdan Jr. wrote:\n> On 2011/08/18 21:21:17, cbentzel wrote:\n> > Not a bad thing - but was this needed? \n> > \n> > The gssapi.h header in net/third_party has it defined as a void*, and casts\n> from\n> > void* to other types are allowed.\n> > \n> > Also, this may need to be a static_cast rather than a reinterpret_cast\n> > \n> >\n> http://stackoverflow.com/questions/310451/should-i-use-static-cast-or-reinterpret-cast-when-casting-a-void-to-whatever\n> > \n> \n> when using the system header static_cast doesn't work:\n> \n> net/http/mock_gssapi_library_posix.cc:281: error: invalid static_cast from type\n> ‘net::test::GssNameMockImpl*’ to type ‘gss_name_struct*’\n\nAh, so gss_name_t is no longer a void* in the system gssapi.h you are building on.\n\nThis is probably OK. I believe reinterpret_cast is still OK here.\n\nhttp://codereview.chromium.org/7655046/diff/1/net/net.gyp\nFile net/net.gyp (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/net.gyp#newcode10\nnet/net.gyp:10: 'linux_link_kerberos%': 0,\nOn 2011/08/18 23:30:32, Paweł Hajdan Jr. wrote:\n> On 2011/08/18 21:21:17, cbentzel wrote:\n> > Should linux be removed from the name? \n> \n> This follows the convention used for gnome-keyring. I can update the name if you\n> want.\n\nThis is fine for consistency.","disapproval":false,"date":"2011-08-19 12:22:35.374411","approval":false},{"sender":"evan@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"On 2011/08/18 23:48:05, wtc wrote:\n> Can we just always link with krb5-config --libs gssapi\n> directly?  That'll simplify the code.\n\n$ apt-cache rdepends libkrb5-3\nlibkrb5-3\nReverse Depends:\n  libcamel1.2-14\n  winbind\n  gnome-settings-daemon\n  evolution-data-server\n  [...many more...]\n\n\nIt looks like this will be available on any Ubuntu system as well.  Who wrote the initial patch?","disapproval":false,"date":"2011-08-19 17:19:08.348464","approval":false},{"sender":"evan@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"On 2011/08/19 17:19:08, Evan Martin wrote:\n> Who wrote\n> the initial patch?\n\nI ask because they may know why we went the more complicated dlopen route.  I'm fine with depending on this.","disapproval":false,"date":"2011-08-19 17:19:49.779636","approval":false},{"sender":"cbentzel@chromium.org","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"I wrote the initial patch, essentially mirroring firefox's approach.\n\nI'm fine with this route.\n\nOn Fri, Aug 19, 2011 at 1:19 PM,  <evan@chromium.org> wrote:\n> On 2011/08/19 17:19:08, Evan Martin wrote:\n>>\n>> Who wrote\n>> the initial patch?\n>\n> I ask because they may know why we went the more complicated dlopen route.\n>  I'm\n> fine with depending on this.\n>\n> http://codereview.chromium.org/7655046/\n>\n","disapproval":false,"date":"2011-08-19 17:21:59.921140","approval":false},{"sender":"evan@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"Lei, do you know how we can tell whether we expect krb5 to be available on all our users' systems?  I guess for RPM systems we need to check LSB?","disapproval":false,"date":"2011-08-19 17:23:54.028606","approval":false},{"sender":"thestig@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"On 2011/08/19 17:23:54, Evan Martin wrote:\n> Lei, do you know how we can tell whether we expect krb5 to be available on all\n> our users' systems?  I guess for RPM systems we need to check LSB?\n\nlsb doesn't have a direct dependency on krb5.","disapproval":false,"date":"2011-08-19 18:26:21.219585","approval":false},{"sender":"phajdan.jr@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"I'm not sure if it's possible to make Google Chrome link to Kerberos directly. Note that this scenario would require binary compatibility, and we don't control the entire stack.\n\n1. dlopen code tries different library names. I believe this would break when linking directly, because just one name would get hardcoded.\n\n2. Output of krb5-config --libs gssapi differs between systems and Kerberos implementations.\n\nNote that the problems above are only important for binary compatibility. For distros that control the entire stack this is not an issue.","disapproval":false,"date":"2011-08-22 18:39:52.286120","approval":false},{"sender":"evan@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"I agree with cbentzel's comments (you should remove the local gssapi.h in this change, need to check that all the bots are fixed and update install-build-deps / update the wiki).\n\nTypically whenever we make this sort of change someone loses 20 minutes trying to track down why their system broke, it'd be nice to try to prevent that.\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_handler_negotiate_unittest.cc\nFile net/http/http_auth_handler_negotiate_unittest.cc (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_handler_negotiate_unittest.cc#newcode346\nnet/http/http_auth_handler_negotiate_unittest.cc:346: #if defined(DLOPEN_KERBEROS)\nMaybe add a comment here explaining that this test doesn't make sense with non-dlopen kerberos.","disapproval":false,"date":"2011-08-22 23:45:17.195898","approval":false},{"sender":"wtc@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"The reason I suggested linking with gssapi directly is to\nsimplify the code.\n\nI am fine with choosing MIT Kerberos in the official Chrome\nbuilds.  We can simply link with -lgssapi_krb5 because it is\nhardcoded on line 433 of net/http/http_auth_gssapi_posix.cc.\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.cc\nFile net/http/http_auth_gssapi_posix.cc (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.cc#newcode437\nnet/http/http_auth_gssapi_posix.cc:437: \"libgssapi_krb5.so.2\",  // MIT Kerberos - FC, Suse10, Debian\nNote that there is only one SONAME for MIT Kerberos in this\ntable.\n\nThis implies that if we standardize on MIT Kerberos, then we\ncan simply link with -lgssapi_krb5 and the binary will work\non FC, Suse10, Debian.","disapproval":false,"date":"2011-08-23 00:56:25.697339","approval":false},{"sender":"cbentzel@chromium.org","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"On Mon, Aug 22, 2011 at 8:56 PM,  <wtc@chromium.org> wrote:\n> The reason I suggested linking with gssapi directly is to\n> simplify the code.\n>\n> I am fine with choosing MIT Kerberos in the official Chrome\n> builds.  We can simply link with -lgssapi_krb5 because it is\n> hardcoded on line 433 of net/http/http_auth_gssapi_posix.cc.\n\nOSX Lion has moved to Heimdal, albeit with an MIT Kerberos shim.\n\nWe also have a GSSAPILibraryName entry in group policy. I'm not sure\nhow many people are using it, but removing the dlopen portion of the\ncode will prevent that from working.\n\n>\n>\n> http://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.cc\n> File net/http/http_auth_gssapi_posix.cc (right):\n>\n> http://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.cc#newcode437\n> net/http/http_auth_gssapi_posix.cc:437: \"libgssapi_krb5.so.2\",  // MIT\n> Kerberos - FC, Suse10, Debian\n> Note that there is only one SONAME for MIT Kerberos in this\n> table.\n>\n> This implies that if we standardize on MIT Kerberos, then we\n> can simply link with -lgssapi_krb5 and the binary will work\n> on FC, Suse10, Debian.\n>\n> http://codereview.chromium.org/7655046/\n>\n","disapproval":false,"date":"2011-08-23 01:08:56.571613","approval":false},{"sender":"phajdan.jr@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"PTAL\n\nI think the safest plan would be to commit this for now (it doesn't change anything for Google Chrome) and let distros do some experiments (for example switching between MIT Kerberos and Heimdal and checking if the binary compatibility is preserved - probably not).\n\nAgain, please note this just mimics the infrastructure for gnome-keyring, which to the best of my knowledge has negligible maintenance cost.\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.cc\nFile net/http/http_auth_gssapi_posix.cc (right):\n\nhttp://codereview.chromium.org/7655046/diff/1/net/http/http_auth_gssapi_posix.cc#newcode437\nnet/http/http_auth_gssapi_posix.cc:437: \"libgssapi_krb5.so.2\",  // MIT Kerberos - FC, Suse10, Debian\nOn 2011/08/23 00:56:25, wtc wrote:\n> Note that there is only one SONAME for MIT Kerberos in this\n> table.\n> \n> This implies that if we standardize on MIT Kerberos, then we\n> can simply link with -lgssapi_krb5 and the binary will work\n> on FC, Suse10, Debian.\n\nThis also implies that we'd be broken with Heimdal.","disapproval":false,"date":"2011-08-23 19:17:13.762628","approval":false},{"sender":"cbentzel@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"LGTM\n\nThis doesn't have the change to build/install-build-deps.sh\nWas this because debian distros which are supported should already have it? Evan's rdepends command seems to indicate that.","disapproval":false,"date":"2011-08-23 20:04:22.579064","approval":true},{"sender":"evan@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"I think we might need to install the -dev package.  Please don't land this unless you're sure the bots won't break.","disapproval":false,"date":"2011-08-23 20:20:30.058567","approval":false},{"sender":"dpolukhin@chromium.org","recipients":["phajdan.jr@chromium.org","cbentzel@chromium.org","wtc@chromium.org","evan@chromium.org","thestig@chromium.org","dpolukhin@chromium.org","chromium-reviews@chromium.org","cbentzel+watch@chromium.org","darin-cc@chromium.org","phajdan.jr@chromium.org"],"text":"http://codereview.chromium.org/7655046/diff/15001/net/http/http_auth_gssapi_posix.h\nFile net/http/http_auth_gssapi_posix.h (right):\n\nhttp://codereview.chromium.org/7655046/diff/15001/net/http/http_auth_gssapi_posix.h#newcode9\nnet/http/http_auth_gssapi_posix.h:9: #include <gssapi.h>\nIt looks like this CL broke Chrome OS build:\n\nchromeos-chrome-15.0.859.0_rc-r1: In file included from net/http/http_auth_gssapi_posix.cc:5:\nchromeos-chrome-15.0.859.0_rc-r1: ./net/http/http_auth_gssapi_posix.h:9:20: error: gssapi.h: No such file or directory\nchromeos-chrome-15.0.859.0_rc-r1: In file included from ./net/http/http_auth_handler_negotiate.h:21,\nchromeos-chrome-15.0.859.0_rc-r1:                  from net/http/http_auth_handler_factory.cc:16:\nchromeos-chrome-15.0.859.0_rc-r1: ./net/http/http_auth_gssapi_posix.h:9:20: error: gssapi.h: No such file or directory\nchromeos-chrome-15.0.859.0_rc-r1: In file included from ./net/http/http_auth_handler_negotiate.h:21,\nchromeos-chrome-15.0.859.0_rc-r1:                  from net/http/http_auth.cc:14:\nchromeos-chrome-15.0.859.0_rc-r1: ./net/http/http_auth_gssapi_posix.h:9:20: error: gssapi.h: No such file or directory","disapproval":false,"date":"2011-08-24 07:45:30.264928","approval":false}],"owner_email":"phajdan.jr@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"Paweł Hajdan Jr.","subject":"Linux: allow linking directly with Kerberos instead of using dlopen.","created":"2011-08-18 17:03:30.330646","patchsets":[1,11001,15001,11017],"modified":"2011-08-24 21:19:22.706106","closed":true,"commit":false,"issue":7655046}