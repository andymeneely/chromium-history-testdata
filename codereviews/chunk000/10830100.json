{"description":"Fix SyncManager initialization failure crash.\n\nThis crash was introduced in r148926, which changes SyncManager init\nbehaviour.  Previously, the SyncManager would end up with a valid\nSyncScheduler regardless of whether or not the initialization failed.\nThis SyncScheduler would later play an important role in shutting down\nthe syncer.  Without a scheduler, the shutdown process crashes.\n\nThe ProfileSyncServiceTest.CorruptDatabase test simulates the scenario\nwe fail to load a sync directory.  This will result in a SyncManager\ninitialization failure.  It is intended to test that this failure is\nhandled by the ProfileSyncService, SyncBackendHost and SyncManager.\n\nBUG=139723\n\n\nCommitted: http://src.chromium.org/viewvc/chrome?view=rev&revision=149306","cc":["chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","tim@chromium.org"],"reviewers":["tim@chromium.org","akalin@chromium.org"],"messages":[{"sender":"rlarocque@chromium.org","recipients":["rlarocque@chromium.org","tim@chromium.org","chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","akalin@chromium.org","tim@chromium.org"],"text":"","disapproval":false,"date":"2012-07-31 18:42:32.444660","approval":false},{"sender":"tim@chromium.org","recipients":["rlarocque@chromium.org","tim@chromium.org","chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","akalin@chromium.org","tim@chromium.org"],"text":"http://codereview.chromium.org/10830100/diff/1/chrome/browser/sync/glue/sync_backend_host.cc\nFile chrome/browser/sync/glue/sync_backend_host.cc (right):\n\nhttp://codereview.chromium.org/10830100/diff/1/chrome/browser/sync/glue/sync_backend_host.cc#newcode852\nchrome/browser/sync/glue/sync_backend_host.cc:852: sync_manager_.reset();\nThe main danger with this is that SyncManager needs to make sure it tears down what it needs to if it detects failure. We actually carefully tear things down in StopSyncingForShutdown and ShutdownOnSyncThread, but this will mean we just rely on declaration orders / destructors. \n\nI'd recommend we move the call to set up connection_manager_ to *after* we return false for good measure -- if we created that and (for example) set up the NetworkChangeNotifier, we'd be in danger of hanging on shutdown since we'd return false but never call TerminateAllIO (because we'd never call StopSyncingForShutdown).\n\nI'd also recommend, if we can, that we call sync_manager_->ShutdownOnSyncThread() before reset here.","disapproval":false,"date":"2012-07-31 19:40:26.355590","approval":false},{"sender":"rlarocque@chromium.org","recipients":["rlarocque@chromium.org","tim@chromium.org","akalin@chromium.org","chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","akalin@chromium.org","tim@chromium.org"],"text":"Updated in response to Tim's comments.\n\n+Fred: Do you know when the notifier starts posting tasks to the sync loop?  Is the destruction order being proposed here likely to leave behind any notifier tasks?\n\nhttp://codereview.chromium.org/10830100/diff/1/chrome/browser/sync/glue/sync_backend_host.cc\nFile chrome/browser/sync/glue/sync_backend_host.cc (right):\n\nhttp://codereview.chromium.org/10830100/diff/1/chrome/browser/sync/glue/sync_backend_host.cc#newcode852\nchrome/browser/sync/glue/sync_backend_host.cc:852: sync_manager_.reset();\nOn 2012/07/31 19:40:26, timsteele wrote:\n> The main danger with this is that SyncManager needs to make sure it tears down\n> what it needs to if it detects failure. We actually carefully tear things down\n> in StopSyncingForShutdown and ShutdownOnSyncThread, but this will mean we just\n> rely on declaration orders / destructors. \n> \n> I'd recommend we move the call to set up connection_manager_ to *after* we\n> return false for good measure -- if we created that and (for example) set up the\n> NetworkChangeNotifier, we'd be in danger of hanging on shutdown since we'd\n> return false but never call TerminateAllIO (because we'd never call\n> StopSyncingForShutdown).\n\nGood idea.  Done.\n\n> I'd also recommend, if we can, that we call\n> sync_manager_->ShutdownOnSyncThread() before reset here.\n\nDone.","disapproval":false,"date":"2012-07-31 20:14:07.671920","approval":false},{"sender":"tim@chromium.org","recipients":["rlarocque@chromium.org","tim@chromium.org","akalin@chromium.org","chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","akalin@chromium.org","tim@chromium.org"],"text":"I'm not 100% sure when the notifier starts posting to the sync loop, so yeah Fred should know.  I just know the posted tasks won't reference the SyncManager (via observer) until the SBH calls UpdateEnabledTypes.\n\nPending data from Fred, this LGTM\n\nhttp://codereview.chromium.org/10830100/diff/1012/chrome/browser/sync/profile_sync_service_unittest.cc\nFile chrome/browser/sync/profile_sync_service_unittest.cc (right):\n\nhttp://codereview.chromium.org/10830100/diff/1012/chrome/browser/sync/profile_sync_service_unittest.cc#newcode85\nchrome/browser/sync/profile_sync_service_unittest.cc:85: true, true, false, true, true, syncer::STORAGE_IN_MEMORY);\n+100\n\nhttp://codereview.chromium.org/10830100/diff/1012/sync/internal_api/sync_manager_impl.cc\nFile sync/internal_api/sync_manager_impl.cc (left):\n\nhttp://codereview.chromium.org/10830100/diff/1012/sync/internal_api/sync_manager_impl.cc#oldcode688\nsync/internal_api/sync_manager_impl.cc:688: connection_manager_->set_client_id(directory()->cache_guid());\nah, yeah, good to move this up\n\nhttp://codereview.chromium.org/10830100/diff/1012/sync/syncable/invalid_directory_backing_store.h\nFile sync/syncable/invalid_directory_backing_store.h (right):\n\nhttp://codereview.chromium.org/10830100/diff/1012/sync/syncable/invalid_directory_backing_store.h#newcode16\nsync/syncable/invalid_directory_backing_store.h:16: InvalidDirectoryBackingStore();\nvirtual dtor","disapproval":false,"date":"2012-07-31 21:14:36.227580","approval":true},{"sender":"akalin@chromium.org","recipients":["rlarocque@chromium.org","tim@chromium.org","akalin@chromium.org","chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","tim@chromium.org"],"text":"On 2012/07/31 20:14:07, rlarocque wrote:\n> Updated in response to Tim's comments.\n> \n> +Fred: Do you know when the notifier starts posting tasks to the sync loop?  Is\n> the destruction order being proposed here likely to leave behind any notifier\n> tasks?\n\nIt's after UpdateEnabledTypes, etc. is called on the notifier, but you shouldn't need to worry about that.  NonBlockingInvalidationNotifier handles the sync/IO thread communication, and behaves like a single-threaded SyncNotifier (i.e., UpdateRegisteredIds(handler, ObjectIdSet()) should immediately stop notifications for handler [formerly RemoveObserver(handler)]).\n\nBut yeah, this destruction order LGTM.","disapproval":false,"date":"2012-07-31 21:34:18.882220","approval":true},{"sender":"rlarocque@chromium.org","recipients":["rlarocque@chromium.org","tim@chromium.org","akalin@chromium.org","chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","tim@chromium.org"],"text":"http://codereview.chromium.org/10830100/diff/1012/sync/syncable/invalid_directory_backing_store.h\nFile sync/syncable/invalid_directory_backing_store.h (right):\n\nhttp://codereview.chromium.org/10830100/diff/1012/sync/syncable/invalid_directory_backing_store.h#newcode16\nsync/syncable/invalid_directory_backing_store.h:16: InvalidDirectoryBackingStore();\nOn 2012/07/31 21:14:36, timsteele wrote:\n> virtual dtor\n\nGood catch.  Done.","disapproval":false,"date":"2012-07-31 21:36:00.114840","approval":false},{"sender":"commit-bot@chromium.org","recipients":["rlarocque@chromium.org","tim@chromium.org","akalin@chromium.org","chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","tim@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/rlarocque@chromium.org/10830100/7002","disapproval":false,"date":"2012-07-31 21:36:47.870580","approval":false},{"sender":"commit-bot@chromium.org","recipients":["rlarocque@chromium.org","tim@chromium.org","akalin@chromium.org","chromium-reviews@chromium.org","rsimha@chromium.org","nick@chromium.org","tim@chromium.org"],"text":"Change committed as 149306","disapproval":false,"date":"2012-07-31 23:01:00.734480","approval":false}],"owner_email":"rlarocque@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"rlarocque","subject":"Fix SyncManager initialization failure crash.","created":"2012-07-31 18:22:15.016400","patchsets":[1,1012,7002],"modified":"2012-07-31 23:01:00.963020","closed":true,"commit":false,"issue":10830100}