{"description":"Instead of reabooting the device, have the daemon restart adbd.\n\nTBR=cmp\nBUG=169338\nNOTRY=True\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=189963","cc":["chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"reviewers":["frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org"],"messages":[{"sender":"navabi@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"","disapproval":false,"date":"2013-03-21 02:58:09.694480","approval":false},{"sender":"commit-bot@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"No LGTM from a valid reviewer yet. Only full committers are accepted.\nEven if an LGTM may have been provided, it was from a non-committer or\na lowly provisional committer, _not_ a full super star committer.\nSee http://www.chromium.org/getting-involved/become-a-committer\nNote that this has nothing to do with OWNERS files.","disapproval":false,"date":"2013-03-21 03:17:17.701330","approval":false},{"sender":"navabi@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"On 2013/03/21 03:17:17, I haz the power (commit-bot) wrote:\n> No LGTM from a valid reviewer yet. Only full committers are accepted.\n> Even if an LGTM may have been provided, it was from a non-committer or\n> a lowly provisional committer, _not_ a full super star committer.\n> See http://www.chromium.org/getting-involved/become-a-committer\n> Note that this has nothing to do with OWNERS files.\n\nlgtm","disapproval":false,"date":"2013-03-21 03:18:29.587090","approval":false},{"sender":"ilevy@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"https://codereview.chromium.org/12927008/diff/1/tools/android/adb_reboot/adb_reboot.c\nFile tools/android/adb_reboot/adb_reboot.c (right):\n\nhttps://codereview.chromium.org/12927008/diff/1/tools/android/adb_reboot/adb_reboot.c#newcode30\ntools/android/adb_reboot/adb_reboot.c:30: system(\"stop adbd\");\nYou may need to add a sleep here, stop adbd might be an asynchronous call.","disapproval":false,"date":"2013-03-21 03:18:54.358560","approval":false},{"sender":"commit-bot@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"No LGTM from a valid reviewer yet. Only full committers are accepted.\nEven if an LGTM may have been provided, it was from a non-committer or\na lowly provisional committer, _not_ a full super star committer.\nSee http://www.chromium.org/getting-involved/become-a-committer\nNote that this has nothing to do with OWNERS files.","disapproval":false,"date":"2013-03-21 03:22:53.530720","approval":false},{"sender":"navabi@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"https://codereview.chromium.org/12927008/diff/1/tools/android/adb_reboot/adb_reboot.c\nFile tools/android/adb_reboot/adb_reboot.c (right):\n\nhttps://codereview.chromium.org/12927008/diff/1/tools/android/adb_reboot/adb_reboot.c#newcode30\ntools/android/adb_reboot/adb_reboot.c:30: system(\"stop adbd\");\nOn 2013/03/21 03:18:54, Isaac wrote:\n> You may need to add a sleep here, stop adbd might be an asynchronous call.\n\nI've tested locally, and adbd seems to restart fine. To test I pushed this version of the daemon to a device, then I wrote a script that every second will do an \"adb devices\". When the device detects a missed heartbeat it restarts adbd and you can see the host not see the devices for a couple seconds and then see the devices come back. Seems to work. Do you have any reason to believe it is asynchronous?","disapproval":false,"date":"2013-03-21 03:24:31.320270","approval":false},{"sender":"ilevy@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"You can't TBR stuff without being a full committer.\n\nAnd in general, I think we should avoid TBRs when dealing with adb_reboot because of the possibility that it could require us to manually fix devices if something goes wrong.\n\nThis lgtm if you've tested and don't need the sleep","disapproval":false,"date":"2013-03-21 03:25:45.105840","approval":true},{"sender":"ilevy@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"In generally killing a process is asynchronous.","disapproval":false,"date":"2013-03-21 03:27:00.261100","approval":false},{"sender":"navabi@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"> And in general, I think we should avoid TBRs when dealing with adb_reboot\n> because of the possibility that it could require us to manually fix devices if\n> something goes wrong.\n\nIn general, I agree. The exception here is that currently the adb_reboot is only being tested on a single bot, which was not even running before I brought it back up to experiment this daemon (i.e. soju-official-perf-clankium)","disapproval":false,"date":"2013-03-21 03:33:15.792420","approval":false},{"sender":"commit-bot@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/navabi@google.com/12927008/1","disapproval":false,"date":"2013-03-21 03:34:56.501750","approval":false},{"sender":"ilevy@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"Yeah actually I'm nervous about this code.  I think you need to wait for adbd to die before spawning the new one.  Otherwise you can get into a situation where you've adbd is dying but the new one doesn't start up and then the phone will require manual intervention (I think).","disapproval":false,"date":"2013-03-21 07:51:03.220770","approval":false},{"sender":"pliard@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"I might have missed a few e-mails but do we know if restarting adbd fixes as many failures as rebooting the device?\n\nhttps://chromiumcodereview.appspot.com/12927008/diff/1/tools/android/adb_reboot/adb_reboot.c\nFile tools/android/adb_reboot/adb_reboot.c (right):\n\nhttps://chromiumcodereview.appspot.com/12927008/diff/1/tools/android/adb_reboot/adb_reboot.c#newcode30\ntools/android/adb_reboot/adb_reboot.c:30: system(\"stop adbd\");\nOn 2013/03/21 03:24:31, navabi wrote:\n> On 2013/03/21 03:18:54, Isaac wrote:\n> > You may need to add a sleep here, stop adbd might be an asynchronous call.\n> \n> I've tested locally, and adbd seems to restart fine. To test I pushed this\n> version of the daemon to a device, then I wrote a script that every second will\n> do an \"adb devices\". When the device detects a missed heartbeat it restarts adbd\n> and you can see the host not see the devices for a couple seconds and then see\n> the devices come back. Seems to work. Do you have any reason to believe it is\n> asynchronous?\n\nA plain kill would definitely be asynchronous. We already had flakiness in the past caused by this pattern. I don't know how 'stop' behaves though. I would just add a sleep in case as Isaac said if we cannot learn more about how 'stop' behaves. The fact that it worked a couple of times doesn't guarantee that it is not flaky.","disapproval":false,"date":"2013-03-21 13:29:55.612790","approval":false},{"sender":"navabi@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"On 2013/03/21 07:51:03, Isaac wrote:\n> Yeah actually I'm nervous about this code.  I think you need to wait for adbd to\n> die before spawning the new one.  Otherwise you can get into a situation where\n> you've adbd is dying but the new one doesn't start up and then the phone will\n> require manual intervention (I think).\n\nIf the adbd does not start then we will definitely need manual intervention. pliard shares the same concern. I'll put a sleep in there to be safe.","disapproval":false,"date":"2013-03-21 17:08:00.016790","approval":false},{"sender":"navabi@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"On 2013/03/21 13:29:55, pliard wrote:\n> I might have missed a few e-mails but do we know if restarting adbd fixes as\n> many failures as rebooting the device?\n\nAs far as I have seen there are two primary device failures. One is the \"offline\" status, which I believe restarting adbd fixes and does so faster, and the other is the device turns off, in which case neither solution fixes the devices.\n\nThere may be a rare third failure type where the device does not show up at all but is still on. I don't think we know for sure if either solution fixes that issue, but I would imagine reboot would. I have seen this very rarely, and I do not know know if adbd restart will fix it. I think using the adbd restart solution has other advantages that make it the better solution.\n\nhttps://chromiumcodereview.appspot.com/12927008/diff/1/tools/android/adb_reboot/adb_reboot.c\n> File tools/android/adb_reboot/adb_reboot.c (right):\n> \n> https://chromiumcodereview.appspot.com/12927008/diff/1/tools/android/adb_reboot/adb_reboot.c#newcode30\n> tools/android/adb_reboot/adb_reboot.c:30: system(\"stop adbd\");\n> On 2013/03/21 03:24:31, navabi wrote:\n> > On 2013/03/21 03:18:54, Isaac wrote:\n> > > You may need to add a sleep here, stop adbd might be an asynchronous call.\n> > \n> > I've tested locally, and adbd seems to restart fine. To test I pushed this\n> > version of the daemon to a device, then I wrote a script that every second\n> will\n> > do an \"adb devices\". When the device detects a missed heartbeat it restarts\n> adbd\n> > and you can see the host not see the devices for a couple seconds and then see\n> > the devices come back. Seems to work. Do you have any reason to believe it is\n> > asynchronous?\n> \n> A plain kill would definitely be asynchronous. We already had flakiness in the\n> past caused by this pattern. I don't know how 'stop' behaves though. I would\n> just add a sleep in case as Isaac said if we cannot learn more about how 'stop'\n> behaves. The fact that it worked a couple of times doesn't guarantee that it is\n> not flaky.\n\nOk. I will add a sleep(2) to be safe.","disapproval":false,"date":"2013-03-21 17:12:43.235960","approval":false},{"sender":"navabi@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"PTAL.\n\nFollowing up on pliard's question of whether this fixes up the same issues as rebooting. I believe for ~95% of the device issues that adb reboot fixes, we know that restarting adbd restart fixes. For the following ~5%, we don't know; it may very well be the case that adbd restart fixes it too.\n\nBesides the fact that adbd restart is less disruptive, it also has the advantage of not stopping adb_reboot from running on the device. For long running perf tests, if the daemon reboots because of loss of connectivity, then it will no longer be running and if connectivity is lost again during the same build, the phone will not reboot on disconnect and will require manual intervention. With this solution, the daemon will keep running and keep fixing device failures.","disapproval":false,"date":"2013-03-21 17:25:32.377070","approval":false},{"sender":"frankf@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"lgtm\n\nLet's get some empirical data on improved robustness, we can always iterate on this.","disapproval":false,"date":"2013-03-21 18:16:35.559590","approval":true},{"sender":"pliard@google.com","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"lgtm, thanks Armand!","disapproval":false,"date":"2013-03-21 18:36:35.316420","approval":true},{"sender":"commit-bot@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/navabi@google.com/12927008/22001","disapproval":false,"date":"2013-03-21 18:55:21.088060","approval":false},{"sender":"commit-bot@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/navabi@google.com/12927008/41001","disapproval":false,"date":"2013-03-22 23:25:25.500860","approval":false},{"sender":"commit-bot@chromium.org","recipients":["navabi@google.com","frankf@chromium.org","pliard@google.com","sivachandra@chromium.org","cmp@chromium.org","ilevy@chromium.org","chromium-reviews@chromium.org","klundberg+watch@chromium.org","frankf+watch@chromium.org","bulach+watch@chromium.org","yfriedman+watch@chromium.org","ilevy+watch@chromium.org"],"text":"Change committed as 189963","disapproval":false,"date":"2013-03-23 00:58:18.464120","approval":false}],"owner_email":"navabi@google.com","private":false,"base_url":"https://chromium.googlesource.com/chromium/src.git@master","owner":"navabi","subject":"Instead of reabooting the device, have the daemon restart adbd.","created":"2013-03-21 02:57:28.369250","patchsets":[1,22001,41001],"modified":"2013-03-23 00:58:18.620680","closed":true,"commit":false,"issue":12927008}